

<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1" />
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta name="theme-color" content="#f9f9f9" />

	<title>你还缺scRNA-seq的workflow吗？ 作者： 生信菜鸟团 来源： 生信菜鸟团 前言 之前曾老师给我看了一位在pipebio工作的生信工程师Roman Hillje的scRNA-seq的workflow，今天整理一下分享给大家。 Roman Hillje的github主页：https://github.  | AiBard123| ai工具网址导航,ai最新产品</title>
	<link rel="shortcut icon" href="/assets/images/favicon.png" />
    <meta name="keywords" content="chatgpt,AI,AI聊天,AI文本生成,AI绘画,AI编程,AI电商" />
    <meta name="description" content="AiBard123 网址导航 | 免费chatgpt 汇集各类先进的人工智能产品，旨在帮助用户更快速地了解和使用这些产品,轻松地浏览不同领域的AI产品，包括语音识别、图像处理、自然语言处理。" />
    
    <meta name="baidu-site-verification" content="codeva-cCAOSG8MBO" />
    
    <link rel="stylesheet" id="block-library-css"
        href="/assets/css/block-library.min-5.6.2.css" type="text/css" media="all" />
    <link rel="stylesheet" id="iconfont-css" href="/assets/css/iconfont-3.03029.1.css"
        type="text/css" media="all" />

    
    <link href="/scss/style.min.css" rel="stylesheet" />
    
		    <link rel="stylesheet" id="iowen-css" href="/assets/css/style-3.03029.1.css"
        type="text/css" media="all" />
    <link rel="stylesheet" id="custom-css" href="/assets/css/custom-style.css"
        type="text/css" media="all" />
		
		<link rel="stylesheet" href=/plugins/font-awesome/css/font-awesome.min.css />


    <link rel="stylesheet" id="fortawesome-css" href="/assets/fontawesome-5.15.4/css/all.min.css" type="text/css" />


    <script type="text/javascript" src="/assets/js/jquery.min-3.2.1.js" id="jquery-js"></script>
    <script type="text/javascript" src="/assets/js/content-search.js"  id="content-search-js"></script>

    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2073588164294660"
     crossorigin="anonymous"></script>

	
    <script>
        

		var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?8450bc732b2a86f7e4aec4ebd9fd8252";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();

        
    </script>
    

    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-7071W80M2K"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-7071W80M2K');
    </script>

</head>


    <div class="page-container">
	
	<div id="sidebar" class="sticky sidebar-nav fade animate-nav" style="width: 170px">
        
            <div class="modal-dialog h-100 sidebar-nav-inner">
                <div class="sidebar-logo border-bottom border-color">
                    
                    <div class="logo overflow-hidden">
                        <a href="https://aibard123.com/" class="logo-expanded">
                            <img src="/assets/images/bt8-expand-light.png" height="40" class="logo-light"
                                alt="AiBard123| ai工具网址导航,ai最新产品">
                            <img src="/assets/images/bt8-expand-dark.png" height="40" class="logo-dark d-none"
                                alt="AiBard123| ai工具网址导航,ai最新产品">
                        </a>
                        <a href="https://aibard123.com/" class="logo-collapsed">
                            <img src="/assets/images/bt.png" height="40" class="logo-light"
                                alt="AiBard123| ai工具网址导航,ai最新产品">
                            <img src="/assets/images/bt.png" height="40" class="logo-dark d-none"
                                alt="AiBard123| ai工具网址导航,ai最新产品">
                        </a>
                    </div>
                    
                </div>
                <div class="sidebar-menu flex-fill">
                    <div class="sidebar-scroll">
                        <div class="sidebar-menu-inner">
                            <ul>
                                
                                    
                                    <li class="sidebar-item">
                                        <a href="/#00834a9dd147b04c5d53d4368cdb0b57" class="smooth">
                                            <i class="fas fa-sun fa-lg fa-lg icon-fw icon-lg mr-2"></i>
                                            <span>本月热门</span>
                                        </a>
                                    </li>
                                    
                                
                                    
                                    <li class="sidebar-item">
                                        <a href="/#db0311e7ecfedd24d157f0ceb4a0897f" class="smooth">
                                            <i class="fas fa-star-and-crescent fa-lg fa-lg icon-fw icon-lg mr-2"></i>
                                            <span>热门网站</span>
                                        </a>
                                    </li>
                                    
                                
                                    
                                    <li class="sidebar-item">
                                        <a href="/#21b5cbb2c769010fec3ce029a5f8a4a3" class="smooth">
                                            <i class="far fa-star fa-lg icon-fw icon-lg mr-2"></i>
                                            <span>国内热门</span>
                                        </a>
                                    </li>
                                    
                                
                                    
                                    <li class="sidebar-item">
                                        <a href="/#8310718935e8ec25ce0350de01e3f7dc" class="smooth">
                                            <i class="fas fa-phone fa-lg fa-lg icon-fw icon-lg mr-2"></i>
                                            <span>对话工具</span>
                                        </a>
                                    </li>
                                    
                                
                                    
                                    <li class="sidebar-item">
                                        <a href="/#d58e850d9115797306c2edf61ac6ddd8" class="smooth">
                                            <i class="fas fa-newspaper fa-lg fa-lg icon-fw icon-lg mr-2"></i>
                                            <span>写作</span>
                                        </a>
                                    </li>
                                    
                                
                                    
                                    <li class="sidebar-item">
                                        <a href="/#2a7418a5f8f1ca4e054364a9300657df" class="smooth">
                                            <i class="fas fa-image fa-lg fa-lg icon-fw icon-lg mr-2"></i>
                                            <span>图像生成</span>
                                        </a>
                                    </li>
                                    
                                
                                    
                                    <li class="sidebar-item">
                                        <a href="/#7808a68ee1b34dab43011429a12de19e" class="smooth">
                                            <i class="fas fa-image fa-lg fa-lg icon-fw icon-lg mr-2"></i>
                                            <span>图像处理</span>
                                        </a>
                                    </li>
                                    
                                
                                    
                                    <li class="sidebar-item">
                                        <a href="/#6729afc51f5ac49a828812fa0eb0c82f" class="smooth">
                                            <i class="fas fa-video fa-lg fa-lg icon-fw icon-lg mr-2"></i>
                                            <span>音视频</span>
                                        </a>
                                    </li>
                                    
                                
                                    
                                    <li class="sidebar-item">
                                        <a href="/#e5ce844860451fff3faf3d8f8894971d" class="smooth">
                                            <i class="fas fa-music fa-lg fa-lg icon-fw icon-lg mr-2"></i>
                                            <span>音乐生成</span>
                                        </a>
                                    </li>
                                    
                                
                                    
                                    <li class="sidebar-item">
                                        <a href="/#db53804b7d726967c58fcc8c9ca03d27" class="smooth">
                                            <i class="fas fa-language fa-lg fa-lg icon-fw icon-lg mr-2"></i>
                                            <span>办公</span>
                                        </a>
                                    </li>
                                    
                                
                                    
                                    <li class="sidebar-item">
                                        <a href="/#47b7af9547e034d28fe6f6d439968ac8" class="smooth">
                                            <i class="fas fa-copy fa-lg fa-lg icon-fw icon-lg mr-2"></i>
                                            <span>提示词</span>
                                        </a>
                                    </li>
                                    
                                
                                    
                                    <li class="sidebar-item">
                                        <a href="/#41282bf95e43c64d579757573a03cdde" class="smooth">
                                            <i class="fas fa-code fa-lg fa-lg icon-fw icon-lg mr-2"></i>
                                            <span>编程</span>
                                        </a>
                                    </li>
                                    
                                
                                    
                                    <li class="sidebar-item">
                                        <a href="/#fd71852fd52d5e18ef4f9a252f1eac58" class="smooth">
                                            <i class="fas fa-search fa-lg fa-lg icon-fw icon-lg mr-2"></i>
                                            <span>AI搜索</span>
                                        </a>
                                    </li>
                                    
                                
                                    
                                    <li class="sidebar-item">
                                        <a href="/#81b1637fbe47625dbdf2094acd3b6683" class="smooth">
                                            <i class="fas fa-language fa-lg fa-lg icon-fw icon-lg mr-2"></i>
                                            <span>文本翻译</span>
                                        </a>
                                    </li>
                                    
                                
                                    
                                    <li class="sidebar-item">
                                        <a href="/#2e9ba3fa6e1ed0e9311b3e97f97f9a40" class="smooth">
                                            <i class="fas fa-book fa-lg fa-lg icon-fw icon-lg mr-2"></i>
                                            <span>学习网站</span>
                                        </a>
                                    </li>
                                    
                                
                            </ul>           
                        </div>
                    </div>
                </div>
                <div class="border-top py-2 border-color">
                    <div class="flex-bottom">
                        <ul>
			    <li id="menu-item-212"
                                 class="menu-item menu-item-type-custom menu-item-object-custom menu-item-212 sidebar-item">
                                 <a href="#friendlink" class="smooth">
                                     <i class="fab fa-staylinked icon-fw icon-lg mr-2"></i>
                                     <span>友情链接</span>
                                 </a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>


<div class="flex-fill grid-bg">
    <div class="big-header-banner">
        <div id="header" class="page-header sticky">
            <div class="navbar navbar-expand-md">
                <div class="container-fluid p-0">

                    <a href="" class="navbar-brand d-md-none" title="AiBard123| ai工具网址导航,ai最新产品">
                        <img src="/assets/images/bt.png" class="logo-light"
                            alt="AiBard123| ai工具网址导航,ai最新产品">
                        <img src="/assets/images/bt.png" class="logo-dark d-none"
                            alt="AiBard123| ai工具网址导航,ai最新产品">
                    </a>

                    <div class="collapse navbar-collapse order-2 order-md-1">
                        <div class="header-mini-btn">
                            <label>
                                <input id="mini-button" type="checkbox">
                                <svg viewbox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                                    <path class="line--1" d="M0 40h62c18 0 18-20-17 5L31 55"></path>
                                    <path class="line--2" d="M0 50h80"></path>
                                    <path class="line--3" d="M0 60h62c18 0 18 20-17-5L31 45"></path>
                                </svg>
                            </label>

                        </div>

                        <ul class="navbar-nav site-menu" style="margin-right: 16px;">
                        
			<li >
				<a href="/">
                                    <i class="fa fa-home fa-lg mr-2"></i>
                                    <span>首页</span>
                                </a>
				<ul class="sub-menu">
				
				</ul>
			    </li>
			
			</ul>

                        
                        <div class="rounded-circle weather">
                            <div id="he-plugin-simple" style="display: contents;"></div>
                            <script>WIDGET = {
                                    CONFIG: {
                                        "modules": "01234",
                                        "background": 5,
                                        "tmpColor": "008000",
                                        "tmpSize": 14,
                                        "cityColor": "008000",
                                        "citySize": 14,
                                        "aqiColor": "#008000",
                                        "aqiSize": 14,
                                        "weatherIconSize": 24,
                                        "alertIconSize": 18,
                                        "padding": "10px 10px 10px 10px",
                                        "shadow": "1",
                                        "language": "auto",
                                        "borderRadius": 5,
                                        "fixed": "false",
                                        "vertical": "middle",
                                        "horizontal": "left",
                                        "key": "085791e805a24491b43b06cf58ab31e7"
                                    }
                                }
                            </script>
                            <script src="https://widget.qweather.net/simple/static/js/he-simple-common.js?v=2.0"></script>
                        </div>
                        
                    </div>

                    <ul class="nav navbar-menu text-xs order-1 order-md-2">
                        
                        
                        <li class="nav-item mr-3 mr-lg-0 d-none d-lg-block">
                            <script>
                                fetch('https://v1.hitokoto.cn')
                                    .then(response => response.json())
                                    .then(data => {
                                    const hitokoto = document.getElementById('hitokoto_text')
                                    hitokoto.href = 'https://hitokoto.cn/?uuid=' + data.uuid
                                    hitokoto.innerText = data.hitokoto
                                    })
                                    .catch(console.error)
                            </script>                           
                            <div id="hitokoto"><a href="#" target="_blank" id="hitokoto_text">疏影横斜水清浅，暗香浮动月黄昏。</a></div>
                        </li>
                        
                        
                        <li class="nav-search ml-3 ml-md-4">
                            <a href="javascript:" data-toggle="modal" data-target="#search-modal"><i
                                    class="iconfont icon-search icon-2x"></i></a>
                        </li>
                        <li class="nav-item d-md-none mobile-menu ml-3 ml-md-4">
                            <a href="javascript:" id="sidebar-switch" data-toggle="modal"
                                data-target="#sidebar"><i class="iconfont icon-classification icon-2x"></i></a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
        <div class="placeholder" style="height:74px"></div>
    </div>




<body class="page-body boxed-container  io-grey-mode">
    <main role="main" class="flex-shrink-0">
    <div class="container">
        
        <div class="content">
            <style>
    body{
	    background: #f9f9f9;
	}

    h1, h2, h3, h4, h5, h6 {
        margin-top: 1.5rem;
        margin-bottom: 1.5rem;
    }


 
@media (min-width: 1000px) {
  .container, .container-sm {
    max-width: 800px;
  }
}

</style>

<div class="featured-post-content">

    <a href="/digest/" class="featured-post-title">
       AI 文摘
    </a>

</div>

<section class="blog-single">
  <div class="container">
    <div class="row">

      <div class="col-lg-12 order-1 order-lg-2">
        <article class="single-blog">
          <p class="title">你还缺scRNA-seq的workflow吗？</p>
            <br/>
          <ul class="meta">
            <li>
              By <a href=https://aibard123.com/about>AiBard123</a>
            </li>
            <li>
              <i class="fa fa-clock-o"></i>
              July 30, 2024 - 2 min read
            </li>
          </ul>

          <div class="_1NCGf">
              <img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8lxl2xSzJ6VULEIPiaZu0hte5Sumtv8mjxZk65LaSzyjxhU5icMicUcc1MQ5wRWjVvPTWxgnkdyoz1Q/640?wx_fmt=png&amp;from=appmsg" width="640" >
          </div>
            <br>
            <br>
            <br>
          
          <div class="single-blog-content">
            <p>作者： 生信菜鸟团  来源： <a href="https://mp.weixin.qq.com/s/P9h_YTMsSgDPniPZqgn-yg">生信菜鸟团</a></p>
<h4 id="前言">前言</h4>
<p>之前曾老师给我看了一位在pipebio工作的生信工程师Roman Hillje的scRNA-seq的workflow，今天整理一下分享给大家。</p>
<p>Roman Hillje的github主页：https://github.com/romanhaa</p>
<p>workflow：https://romanhaa.github.io/projects/scrnaseq_workflow/</p>
<p><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8lxl2xSzJ6VULEIPiaZu0htq0nO5ODMJamo7OeXFJ42m54vmEedGSa5UtFYr58Dkia8eWkgR6XCyqA/640?wx_fmt=png&amp;from=appmsg" alt=""></p>
<p>示例数据来源：<strong>GSE120221</strong>  (<a href="https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE120221">https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE120221</a>) 下的前三个样品:</p>
<ul>
<li>
<p>GSM3396161Bone marrow A</p>
</li>
<li>
<p>GSM3396162Bone marrow B</p>
</li>
<li>
<p>GSM3396163Bone marrow C1</p>
</li>
</ul>
<h4 id="1准备工作">1.准备工作</h4>
<pre><code>#1.1 加载R包  
rm(list = ls())  
library(tidyverse)  
library(Seurat)  
library(scran)  
library(patchwork)  
library(viridis)  
library(ggforce)  
library(gghalves)  
library(ggridges)  
library(scDblFinder)  
library(SingleR)  
library(intrinsicDimension)  
  
#1.2 设置可视化配色  
custom_colors &lt;- list()  
  
colors_dutch &lt;- c(  
  '#FFC312','#C4E538','#12CBC4','#FDA7DF','#ED4C67',  
  '#F79F1F','#A3CB38','#1289A7','#D980FA','#B53471',  
  '#EE5A24','#009432','#0652DD','#9980FA','#833471',  
  '#EA2027','#006266','#1B1464','#5758BB','#6F1E51'  
)  
  
colors_spanish &lt;- c(  
  '#40407a','#706fd3','#f7f1e3','#34ace0','#33d9b2',  
  '#2c2c54','#474787','#aaa69d','#227093','#218c74',  
  '#ff5252','#ff793f','#d1ccc0','#ffb142','#ffda79',  
  '#b33939','#cd6133','#84817a','#cc8e35','#ccae62'  
)  
  
custom_colors$discrete &lt;- c(colors_dutch, colors_spanish)  
  
custom_colors$cell_cycle &lt;- setNames(  
  c('#45aaf2', '#f1c40f', '#e74c3c', '#7f8c8d'),  
  c('G1',      'S',       'G2M',     '-')  
)  
  
#1.3 定义一些函数  
load10xData &lt;- function(  
    sample_name,  
    path,  
    max_number_of_cells = NULL  
) {  
    
  ## read transcript count matrix  
  transcript_counts &lt;- list.files(  
    path,  
    recursive = TRUE,  
    full.names = TRUE  
  ) %&gt;%  
    .[grep(., pattern = 'mtx')] %&gt;%  
    Matrix::readMM()  
    
  ## read cell barcodes and assign as column names of transcript count matrix  
  colnames(transcript_counts) &lt;- list.files(  
    path,  
    recursive = TRUE,  
    full.names = TRUE  
  ) %&gt;%  
    .[grep(., pattern = 'barcodes')] %&gt;%  
    .[grep(., pattern = 'tsv')] %&gt;%  
    read_tsv(col_names = FALSE, col_types = cols()) %&gt;%  
    pull(1) %&gt;%  
    gsub(., pattern = '-[0-9]{1,2}', replacement = '') %&gt;%  
    paste0(., '-', sample_name)  
    
  ## read gene names  
  gene_names &lt;- list.files(  
    path,  
    recursive = TRUE,  
    full.names = TRUE  
  ) %&gt;%  
    .[grep(., pattern = 'genes|features')] %&gt;%  
    read_tsv(col_names = FALSE, col_types = cols()) %&gt;%  
    pull(ifelse(ncol(.) &gt; 1, 2, 1))  
    
  ## if necessary, merge counts from different transcripts of the same gene  
  if ( any(duplicated(gene_names)) == TRUE ) {  
      
    ## get names of genes with multiple entries  
    duplicated_gene_names &lt;- unique(gene_names[which(duplicated(gene_names))])  
      
    ## log message  
    message(  
      glue::glue(  
        &quot;{format(Sys.time(), '[%Y-%m-%d %H:%M:%S]')} Summing up counts for &quot;,  
        &quot;{length(duplicated_gene_names)} genes with multiple entries.&quot;  
      )  
    )  
      
    ## go through genes with multiple entries  
    for ( i in duplicated_gene_names ) {  
        
      ## extract transcripts counts for current gene  
      tmp_counts &lt;- transcript_counts[which(gene_names == i),]  
        
      ## make sure at least 2 rows are present  
      if ( nrow(tmp_counts) &gt;= 2 ) {  
          
        ## sum up counts in each cell  
        tmp_counts_sum &lt;- Matrix::colSums(tmp_counts)  
          
        ## remove original counts from transcript matrix and the gene name from  
        ## the list of gene names  
        transcript_counts &lt;- transcript_counts[-c(which(gene_names == i)),]  
        gene_names &lt;- gene_names[-c(which(gene_names == i))]  
          
        ## add summed counts to end of transcript count matrix and current gene  
        ## name to end of gene names  
        transcript_counts &lt;- rbind(transcript_counts, tmp_counts_sum)  
        gene_names &lt;- c(gene_names, i)  
      }  
    }  
  }  
    
  ## assign gene names as row names  
  rownames(transcript_counts) &lt;- gene_names  
    
  ## down-sample cells if more cells than `max_number_of_cells` are present in  
  ## count matrix  
  if (  
    !is.null(max_number_of_cells) &amp;&amp;  
    is.numeric(max_number_of_cells) &amp;&amp;  
    max_number_of_cells &lt; ncol(transcript_counts)  
  ) {  
    temp_cells_to_keep &lt;- base::sample(1:ncol(transcript_counts), max_number_of_cells)  
    transcript_counts &lt;- transcript_counts[,temp_cells_to_keep]  
  }  
    
  ##  
  message(  
    glue::glue(  
      &quot;{format(Sys.time(), '[%Y-%m-%d %H:%M:%S]')} Loaded counts for sample &quot;  
    )  
  )  
    
  ##  
  return(transcript_counts)  
}  
  
#When provided with a list of transcript count matrices,   
#this function checks whether the gene names are the same in all the count matrices,   
#which is an important premise for merging them.  
  
#当提供许多待合并的转录组count矩阵后，这个函数检查所有count矩阵中基因名是否相同，  
#这是合并他们的重要前提  
  
sameGeneNames &lt;- function(counts) {  
    
  ## create place holder for gene names from each count matrix  
  gene_names &lt;- list()  
    
  ## go through count matrices  
  for ( i in names(counts) ) {  
      
    ## extract gene names  
    gene_names[[i]] &lt;- rownames(counts[[i]])  
  }  
    
  ## check if all gene names are the same (using the first matrix as a reference  
  ## for the others)  
  return(all(sapply(gene_names, FUN = identical, gene_names[[1]])))  
}  
  
#This function outputs a table of mean and median transcripts and expressed genes for every sample in our data set.  
#这个函数输出数据集中每个样本产生转录表达的平均数和中位数  
  
averagenCountnFeature &lt;- function(cells) {  
  output &lt;- tibble(  
    'sample' = character(),  
    'mean(nCount)' = numeric(),  
    'median(nCount)' = numeric(),  
    'mean(nFeature)' = numeric(),  
    'median(nFeature)' = numeric()  
  )  
  for ( i in levels(cells$sample) ) {  
    tmp &lt;- tibble(  
      'sample' = i,  
      'mean(nCount)' = cells %&gt;% filter(sample == i) %&gt;% pull(nCount) %&gt;% mean(),  
      'median(nCount)' = cells %&gt;% filter(sample == i) %&gt;% pull(nCount) %&gt;% median(),  
      'mean(nFeature)' = cells %&gt;% filter(sample == i) %&gt;% pull(nFeature) %&gt;% mean(),  
      'median(nFeature)' = cells %&gt;% filter(sample == i) %&gt;% pull(nFeature) %&gt;% median()  
    )  
    output &lt;- bind_rows(output, tmp)  
  }  
  return(output)  
}  
  
#1.4 创建文件夹  
dir.create('data')  
dir.create('plots')  
</code></pre>
<h4 id="2载入数据">2.载入数据</h4>
<p>首先用之前定义的load10xData函数读取10x样本。 我们这里使用参数max_number_of_cells
随机取2000个细胞为了快速演示这个流程</p>
<pre><code>#2.1 读入10x数据  
sample_names &lt;- list.dirs('RAW', recursive = FALSE) %&gt;% basename()  
  
transcripts &lt;- list(  
  raw = list()  
)  
  
for ( i in sample_names ) {  
  transcripts$raw[[i]] &lt;- load10xData(  
    i, paste0('RAW/', i, '/'),  
    max_number_of_cells = 2000  
  )  
}  
  
#2.2 合并样本  
#在合并count矩阵之前，需要检查他们的基因名是否相同  
sameGeneNames(transcripts$raw)  
# TRUE  
#本文数据来源的三个样本经过同样的上游处理  
#他们之间的基因名相同所以我们可以直接合并  
transcripts$raw$merged &lt;- do.call(cbind, transcripts$raw)  
  
dim(transcripts$raw$merged)  
save(transcripts,file = &quot;./data/raw_merged_count.RData&quot;)  
# 33660  6000  
  
#注意:如果基因名称不相同，有两种策略。  
#您可以将转录组count矩阵转换为数据框格式，然后使用full_join()函数合并它们。  
#根据你正在处理的数据集的大小，这可能会导致内存问题。  
#或者，你将缺失的、充满0计数的基因添加到缺失基因的矩阵中。  
#在合并之前，必须确保基因的顺序相同。  
#你可以在下面找到第一种方法的大纲:  
# for ( i in sample_names ) {  
#   gene_names &lt;- rownames(transcripts$raw[[i]])  
#   transcripts$raw[[i]] &lt;- as.data.frame(as.matrix(transcripts$raw[[i]]))  
#   transcripts$raw[[i]] &lt;- transcripts$raw[[i]] %&gt;%  
#     mutate(gene = gene_names) %&gt;%  
#     select(gene, everything())  
# }  
#   
# transcripts$raw$merged &lt;- full_join(transcripts$raw$A, transcripts$raw$B, by = &quot;gene&quot;) %&gt;%  
#   full_join(., transcripts$raw$E, by = &quot;gene&quot;)  
#   
# transcripts$raw$merged[ is.na(transcripts$raw$merged) ] &lt;- 0  
</code></pre>
<h4 id="3质控">3.质控</h4>
<p>在我们进行分析之前，我们将从合并的count矩阵中移除低质量的细胞，以及低表达的基因</p>
<pre><code>## 3.1 Filter cells过滤细胞  
### 3.1.1 Prepare data准备数据  
我们先获取转录组count，每个细胞表达的基因数量，以及每个细胞线粒体转录本占总的百分比  
load(&quot;./data/raw_merged_count.RData&quot;)  
cells &lt;- data.frame(  
  cell = colnames(transcripts$raw$merged),  
  sample = colnames(transcripts$raw$merged) %&gt;%  
    strsplit('-') %&gt;%  
    vapply(FUN.VALUE = character(1), `[`, 2) %&gt;%  
    factor(levels = sample_names),  
  nCount = colSums(transcripts$raw$merged),  
  nFeature = colSums(transcripts$raw$merged != 0)  
)  
  
#这里他给的代码载入了一个含有研究物种对应线粒体基因名的配置文件，  
#可我们没有啊，我们只能粗略根据&quot;^MT-&quot;找了  
  
#内存不够的话不要这样写  
transcripts$raw$merged -&gt; merged_count  
library(stringr)  
cells$percent_MT &lt;- apply(merged_count[str_detect(rownames(merged_count),&quot;^MT-&quot;),],2,sum)/apply(merged_count,2,sum)  
rm(merged_count)  
  
### 3.1.2 Doublets去除双细胞  
#使用scDblFinder找doublets  
sce &lt;- SingleCellExperiment(assays = list(counts = transcripts$raw$merged))  
#这里笔者遇到一个matrix报错：  
#程序包'as_cholmod_sparse'不提供'Matrix'这样的函数  
#太玄学了，重装irlba包和Matrix包就ok了  
# remove.packages(&quot;Matrix&quot;)  
# remove.packages(&quot;irlba&quot;)  
# BiocManager::install(&quot;irlba&quot;,force = T)  
# BiocManager::install(&quot;Matrix&quot;,force = T)  
#remotes::install_version(&quot;Matrix&quot;, version = &quot;1.6-1.1&quot;)  
sce &lt;- scDblFinder(sce)  
#&quot;SingleCellExperiment&quot;对象  
class(sce)  
#在multiplet_class列标注出单细胞还是双细胞  
cells$multiplet_class &lt;- colData(sce)$scDblFinder.class  
#可视化,各个样本中双细胞数目  
cells[cells$multiplet_class != 'singlet',&quot;sample&quot;] %&gt;% table %&gt;%  
  as.data.frame() -&gt;plotdf  
colnames(plotdf)&lt;-c(&quot;sample&quot;,&quot;count&quot;)  
  
p&lt;-ggplot(plotdf ,aes(x = sample, y = count, fill = sample)) +  
  geom_col(color = 'black') +  
  theme_bw() +  
  scale_fill_manual(values = custom_colors$discrete) +  
  scale_x_discrete(limits = rev(levels(cells$sample))) +  
  scale_y_continuous(name = 'Number of doublets', labels = scales::comma) +  
  theme(  
    axis.title.y = element_blank(),  
    panel.grid.major.y = element_blank(),  
    panel.grid.minor.y = element_blank(),  
    legend.position = 'none'  
  ) +  
  coord_flip()  
  
p  
  
ggsave(  
  'plots/qc_number_of_doublets_by_sample.png',  
  p, height = 3, width = 6  
)  
#接下来我们可视化单细胞和双细胞中nCount和nFeature的分布  
p1 &lt;- ggplot(cells, aes(x = multiplet_class, y = nCount, fill = multiplet_class)) +  
  geom_violin(draw_quantiles = c(0.5), scale = 'area', trim = FALSE) +  
  geom_jitter(aes(color=multiplet_class),width = 0.4,size=0.3,alpha=0.7)+  
  theme_bw() +  
  scale_fill_manual(values = custom_colors$discrete) +  
  scale_x_discrete(limits = rev(levels(cells$multiplet_class))) +  
  scale_y_continuous(labels = scales::comma) +  
  labs(title = 'Number of transcripts', subtitle = 'linear scale') +  
  theme(  
    axis.title = element_blank(),  
    panel.grid.major.y = element_blank(),  
    panel.grid.minor.y = element_blank(),  
    legend.position = 'none'  
  ) +  
  coord_flip()  
p2 &lt;- ggplot(cells, aes(x = multiplet_class, y = nCount, fill = multiplet_class)) +  
  geom_violin(draw_quantiles = c(0.5), scale = 'area', trim = FALSE) +  
  geom_jitter(aes(color=multiplet_class),width = 0.4,size=0.3,alpha=0.7)+  
  theme_bw() +  
  scale_fill_manual(values = custom_colors$discrete) +  
  scale_x_discrete(limits = rev(levels(cells$multiplet_class))) +  
  scale_y_log10(labels = scales::comma) +  
  labs(title = 'Number of transcripts', subtitle = 'log-scale') +  
  theme(  
    axis.title = element_blank(),  
    panel.grid.major.y = element_blank(),  
    panel.grid.minor.y = element_blank(),  
    legend.position = 'none'  
  ) +  
  coord_flip()  
p3 &lt;- ggplot(cells, aes(x = multiplet_class, y = nFeature, fill = multiplet_class)) +  
  geom_violin(draw_quantiles = c(0.5), scale = 'area', trim = FALSE) +  
  geom_jitter(aes(color=multiplet_class),width = 0.4,size=0.3,alpha=0.7)+  
  theme_bw() +  
  scale_fill_manual(values = custom_colors$discrete) +  
  scale_x_discrete(limits = rev(levels(cells$multiplet_class))) +  
  scale_y_continuous(labels = scales::comma) +  
  labs(title = 'Number of expressed genes', subtitle = 'linear scale') +  
  theme(  
    axis.title = element_blank(),  
    panel.grid.major.y = element_blank(),  
    panel.grid.minor.y = element_blank(),  
    legend.position = 'none'  
  ) +  
  coord_flip()  
p4 &lt;- ggplot(cells, aes(x = multiplet_class, y = nFeature, fill = multiplet_class)) +  
  geom_violin(draw_quantiles = c(0.5), scale = 'area', trim = FALSE) +  
  geom_jitter(aes(color=multiplet_class),width = 0.4,size=0.3,alpha=0.7)+  
  theme_bw() +  
  scale_fill_manual(values = custom_colors$discrete) +  
  scale_x_discrete(limits = rev(levels(cells$multiplet_class))) +  
  scale_y_log10(labels = scales::comma) +  
  labs(title = 'Number of expressed genes', subtitle = 'log-scale') +  
  theme(  
    axis.title = element_blank(),  
    panel.grid.major.y = element_blank(),  
    panel.grid.minor.y = element_blank(),  
    legend.position = 'none'  
  ) +  
  coord_flip()  
  
  
p1 + p3 +  
    p2 + p4 + plot_layout(ncol = 2)  
  
ggsave(  
  'plots/qc_ncount_nfeature_by_multiplet_class.png',  
  p1 + p3 +  
    p2 + p4 + plot_layout(ncol = 2),  
  height = 14, width = 20  
)  
#去除双细胞  
cells &lt;- cells[cells$multiplet_class == 'singlet',]  
</code></pre>
<p><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8lxl2xSzJ6VULEIPiaZu0htgoOA6u4wUq0zBgPqRCQ0hFcXTgpttKm9NcjSxt73NeyXL3GFIdz4Sw/640?wx_fmt=png&amp;from=appmsg" alt=""><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8lxl2xSzJ6VULEIPiaZu0htwT0VElojP0HqcoCISSu9zLPpPxAxUJE32ByNicyGnrOW2zKRywIOSBA/640?wx_fmt=png&amp;from=appmsg" alt=""></p>
<p>在去除任何细胞之前，我们先看看转录本count的分布，每个细胞表达的基因数，以及每个细胞线粒体转录本的百分比。这些分布可以用不同的可视化方式表示。哪一个看起来最好取决于个人习惯和数据集。原文有四种可视化方法，展现出大佬雄厚的ggplot2绘图功力，我选我最喜欢的一种放在下面。</p>
<pre><code>### 3.1.3 Before filtering  
  
p1 &lt;- ggplot(cells, aes(nCount, fill = sample)) +  
  geom_histogram(bins = 200) +  
  theme_bw() +  
  scale_fill_manual(values = custom_colors$discrete) +  
  scale_x_continuous(labels = scales::comma) +  
  labs(title = 'Number of transcripts', subtitle = 'linear scale', y = 'Number of cells') +  
  theme(legend.position = 'none', axis.title.x = element_blank())  
  
p2 &lt;- ggplot(cells, aes(nCount, fill = sample)) +  
  geom_histogram(bins = 200) +  
  theme_bw() +  
  scale_fill_manual(values = custom_colors$discrete) +  
  scale_x_log10(labels = scales::comma) +  
  labs(title = 'Number of transcripts', subtitle = 'log-scale', y = 'Number of cells') +  
  theme(legend.position = 'none', axis.title.x = element_blank())  
  
p3 &lt;- ggplot(cells, aes(nFeature, fill = sample)) +  
  geom_histogram(bins = 200) +  
  theme_bw() +  
  scale_fill_manual(values = custom_colors$discrete) +  
  scale_x_continuous(labels = scales::comma) +  
  labs(title = 'Number of expressed genes', subtitle = 'linear scale', y = 'Number of cells') +  
  theme(legend.position = 'none',axis.title.x = element_blank())  
  
p4 &lt;- ggplot(cells, aes(nFeature, fill = sample)) +  
  geom_histogram(bins = 200) +  
  theme_bw() +  
  scale_fill_manual(values = custom_colors$discrete) +  
  scale_x_log10(labels = scales::comma) +  
  labs(title = 'Number of expressed genes', subtitle = 'log-scale', y = 'Number of cells', fill = 'Sample') +  
  theme(legend.position = 'none', axis.title.x = element_blank())  
  
p5 &lt;- ggplot(cells, aes(percent_MT, fill = sample)) +  
  geom_histogram(bins = 200) +  
  theme_bw() +  
  scale_x_continuous(labels = scales::percent) +  
  scale_fill_manual(name = 'Sample', values = custom_colors$discrete) +  
  labs(title = 'Percent MT transcripts', subtitle = 'linear scale', y = 'Number of cells') +  
  theme(legend.position = 'right', axis.title.x = element_blank(), legend.text = element_text(size = 8))  
  
p1 + p3 + p5 +  
    p2 + p4 + plot_layout(ncol = 3)  
  
ggsave(  
  'plots/qc_histogram_ncount_nfeature_percentmt_before_filtering_3.png',  
  p1 + p3 + p5 +  
    p2 + p4 + plot_layout(ncol = 3),  
  height = 7, width = 10  
)  
</code></pre>
<p><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8lxl2xSzJ6VULEIPiaZu0hteZdtSdZ6mtALvIgKg25IsGOxsZWpTGr1hvibpyt0StaZjgKtFQahMVg/640?wx_fmt=png&amp;from=appmsg" alt=""></p>
<p>另一个有趣的关系是每个细胞中表达基因的数量比转录本的数量。这通常会产生如下所示的曲线。有时有许多细胞具有特定的模式，即表达很多基因和高转录本数量的细胞可能是垂死的细胞。</p>
<pre><code>p &lt;- ggplot(cells, aes(nCount, nFeature, color = percent_MT)) +  
  geom_point(size = 0.5) +  
  scale_x_continuous(name = 'Number of transcripts', labels = scales::comma) +  
  scale_y_continuous(name = 'Number of expressed genes', labels = scales::comma) +  
  theme_bw() +  
  scale_color_viridis(  
    name = 'Percent MT\ntranscripts',  
    limits = c(0,1),  
    labels = scales::percent,  
    guide = guide_colorbar(frame.colour = 'black', ticks.colour = 'black')  
  )  
  
p  
  
ggsave('plots/qc_nfeature_over_ncount_before_filtering.png', p, height = 4, width = 6)  
</code></pre>
<p><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8lxl2xSzJ6VULEIPiaZu0ht0gJFqcAoEH7zRaicZ6T5v2N5L3sibVzXbYhJODEQGo35wb0NsNrewnwQ/640?wx_fmt=png&amp;from=appmsg" alt=""></p>
<p>现在我们需要确定我们正在处理的矩阵的上下限。有很多种办法来做，一种就是肉眼看，另一种则是估计中位数和MAD(中位数绝对偏差)。如果你决定使用后者处理，一般建议保持在中位数附近的3-5MADs范围内。在本文中，我们将慷慨地接受任何低于中位数加上5倍的MAD。我们不需要下限，因为矩阵显然已经预先用每个细胞转录本和表达基因数量的可接受下限进行了过滤。</p>
<pre><code>### 3.1.4 Define thresholds确定阈值  
median_nCount &lt;- median(cells$nCount)  
# 4255  
mad_nCount &lt;- mad(cells$nCount)  
# 2630.874  
  
median_nFeature &lt;- median(cells$nFeature)  
# 803  
mad_nFeature &lt;- mad(cells$nFeature)  
# 544.1142  
  
median_percent_MT &lt;- median(cells$percent_MT)  
# 0.02760973  
mad_percent_MT &lt;- mad(cells$percent_MT)  
# 0.02103674  
  
thresholds_nCount &lt;- c(0, median_nCount + 5*mad_nCount)  
# 0.00 17409.37  
thresholds_nFeature &lt;- c(0, median_nFeature + 5*mad_nFeature)  
# 0.000 3523.571  
thresholds_percent_MT &lt;- c(0, median_percent_MT + 5*mad_percent_MT)  
# 0.0000000 0.1327934  
save(thresholds_nCount,thresholds_nFeature,thresholds_percent_MT,file = &quot;thresholds.RData&quot;)  
  
p1 &lt;- ggplot(cells, aes(nCount, fill = sample)) +  
  geom_histogram(bins = 200) +  
  geom_vline(xintercept = median_nCount, color = 'black') +  
  geom_vline(xintercept = thresholds_nCount, color = 'red') +  
  theme_bw() +  
  scale_fill_manual(values = custom_colors$discrete) +  
  scale_x_continuous(labels = scales::comma) +  
  labs(title = 'Number of transcripts', subtitle = 'linear scale', y = 'Number of cells') +  
  theme(legend.position = 'none', axis.title.x = element_blank())  
  
p2 &lt;- ggplot(cells, aes(nCount, fill = sample)) +  
  geom_histogram(bins = 200) +  
  geom_vline(xintercept = median_nCount, color = 'black') +  
  geom_vline(xintercept = thresholds_nCount, color = 'red') +  
  theme_bw() +  
  scale_fill_manual(values = custom_colors$discrete) +  
  scale_x_log10(labels = scales::comma) +  
  labs(title = 'Number of transcripts', subtitle = 'log-scale', y = 'Number of cells') +  
  theme(legend.position = 'none', axis.title.x = element_blank())  
  
p3 &lt;- ggplot(cells, aes(nFeature, fill = sample)) +  
  geom_histogram(bins = 200) +  
  geom_vline(xintercept = median_nFeature, color = 'black') +  
  geom_vline(xintercept = thresholds_nFeature, color = 'red') +  
  theme_bw() +  
  scale_fill_manual(values = custom_colors$discrete) +  
  scale_x_continuous(labels = scales::comma) +  
  labs(title = 'Number of expressed genes', subtitle = 'linear scale', y = 'Number of cells') +  
  theme(legend.position = 'none',axis.title.x = element_blank())  
  
p4 &lt;- ggplot(cells, aes(nFeature, fill = sample)) +  
  geom_histogram(bins = 200) +  
  geom_vline(xintercept = median_nFeature, color = 'black') +  
  geom_vline(xintercept = thresholds_nFeature, color = 'red') +  
  theme_bw() +  
  scale_fill_manual(values = custom_colors$discrete) +  
  scale_x_log10(labels = scales::comma) +  
  labs(title = 'Number of expressed genes', subtitle = 'log-scale', y = 'Number of cells', fill = 'Sample') +  
  theme(legend.position = 'none', axis.title.x = element_blank())  
  
p5 &lt;- ggplot(cells, aes(percent_MT, fill = sample)) +  
  geom_histogram(bins = 200) +  
  geom_vline(xintercept = median_percent_MT, color = 'black') +  
  geom_vline(xintercept = thresholds_percent_MT, color = 'red') +  
  theme_bw() +  
  scale_x_continuous(labels = scales::percent) +  
  scale_fill_manual(name = 'Sample', values = custom_colors$discrete) +  
  labs(title = 'Percent MT transcripts', subtitle = 'linear scale', y = 'Number of cells') +  
  theme(legend.position = 'right', axis.title.x = element_blank(), legend.text = element_text(size = 8))  
  
p1 + p3 + p5 +  
    p2 + p4 + plot_layout(ncol = 3)  
  
ggsave(  
  'plots/qc_histogram_ncount_nfeature_percentmt_thresholds.png',  
  p1 + p3 + p5 +  
    p2 + p4 + plot_layout(ncol = 3),  
  height = 7, width = 10  
)  
  
#对另一种表现方法的图加入阈值  
  
p &lt;- ggplot(cells, aes(nCount, nFeature, color = percent_MT)) +  
  geom_point(size = 0.5) +  
  geom_hline(yintercept = thresholds_nFeature, color = 'red') +  
  geom_vline(xintercept = thresholds_nCount, color = 'red') +  
  scale_x_continuous(name = 'Number of transcripts', labels = scales::comma) +  
  scale_y_continuous(name = 'Number of expressed genes', labels = scales::comma) +  
  theme_bw() +  
  scale_color_viridis(  
    name = 'Percent MT\ntranscripts',  
    limits = c(0,1),  
    labels = scales::percent,  
    guide = guide_colorbar(frame.colour = 'black', ticks.colour = 'black')  
  )  
  
p  
  
ggsave('plots/qc_nfeature_over_ncount_thresholds.png', p, height = 4, width = 6)  
```  
</code></pre>
<p><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8lxl2xSzJ6VULEIPiaZu0ht6zZzd6RIEbqkGfH67wR26AY1dJtHI5PSd5xLr29SplUSg0dMeOk8eQ/640?wx_fmt=png&amp;from=appmsg" alt=""><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8lxl2xSzJ6VULEIPiaZu0htm4nqZVibGznlojlhx1vicUgSVkpJlvcVUicppAaZ1VBE8rKPUGia0UWrGw/640?wx_fmt=png&amp;from=appmsg" alt=""></p>
<p>我们识别出低质量的细胞，现在进行过滤</p>
<pre><code>### 3.1.5 After filtering过滤  
cells_filtered &lt;- cells[cells$nCount &gt;= thresholds_nCount[1]&amp;  
    cells$nCount &lt;= thresholds_nCount[2]&amp;  
    cells$nFeature &gt;= thresholds_nFeature[1]&amp;  
    cells$nFeature &lt;= thresholds_nFeature[2]&amp;  
    cells$percent_MT &gt;= thresholds_percent_MT[1]&amp;  
    cells$percent_MT &lt;= thresholds_percent_MT[2],]  
  
p1 &lt;- ggplot(cells_filtered, aes(nCount, fill = sample)) +  
  geom_histogram(bins = 200) +  
  geom_vline(xintercept = median_nCount, color = 'black') +  
  geom_vline(xintercept = thresholds_nCount, color = 'red') +  
  theme_bw() +  
  scale_fill_manual(values = custom_colors$discrete) +  
  scale_x_continuous(labels = scales::comma) +  
  labs(title = 'Number of transcripts', subtitle = 'linear scale', y = 'Number of cells') +  
  theme(legend.position = 'none', axis.title.x = element_blank())  
  
p2 &lt;- ggplot(cells_filtered, aes(nCount, fill = sample)) +  
  geom_histogram(bins = 200) +  
  geom_vline(xintercept = median_nCount, color = 'black') +  
  geom_vline(xintercept = thresholds_nCount, color = 'red') +  
  theme_bw() +  
  scale_fill_manual(values = custom_colors$discrete) +  
  scale_x_log10(labels = scales::comma) +  
  labs(title = 'Number of transcripts', subtitle = 'log-scale', y = 'Number of cells') +  
  theme(legend.position = 'none', axis.title.x = element_blank())  
  
p3 &lt;- ggplot(cells_filtered, aes(nFeature, fill = sample)) +  
  geom_histogram(bins = 200) +  
  geom_vline(xintercept = median_nFeature, color = 'black') +  
  geom_vline(xintercept = thresholds_nFeature, color = 'red') +  
  theme_bw() +  
  scale_fill_manual(values = custom_colors$discrete) +  
  scale_x_continuous(labels = scales::comma) +  
  labs(title = 'Number of expressed genes', subtitle = 'linear scale', y = 'Number of cells') +  
  theme(legend.position = 'none',axis.title.x = element_blank())  
  
p4 &lt;- ggplot(cells_filtered, aes(nFeature, fill = sample)) +  
  geom_histogram(bins = 200) +  
  geom_vline(xintercept = median_nFeature, color = 'black') +  
  geom_vline(xintercept = thresholds_nFeature, color = 'red') +  
  theme_bw() +  
  scale_fill_manual(values = custom_colors$discrete) +  
  scale_x_log10(labels = scales::comma) +  
  labs(title = 'Number of expressed genes', subtitle = 'log-scale', y = 'Number of cells', fill = 'Sample') +  
  theme(legend.position = 'none', axis.title.x = element_blank())  
  
p5 &lt;- ggplot(cells_filtered, aes(percent_MT, fill = sample)) +  
  geom_histogram(bins = 200) +  
  geom_vline(xintercept = median_percent_MT, color = 'black') +  
  geom_vline(xintercept = thresholds_percent_MT, color = 'red') +  
  theme_bw() +  
  scale_x_continuous(labels = scales::percent) +  
  scale_fill_manual(name = 'Sample', values = custom_colors$discrete) +  
  labs(title = 'Percent MT transcripts', subtitle = 'linear scale', y = 'Number of cells') +  
  theme(legend.position = 'right', axis.title.x = element_blank(), legend.text = element_text(size = 8))  
  
p1 + p3 + p5 +  
    p2 + p4 + plot_layout(ncol = 3)  
  
ggsave(  
  'plots/qc_histogram_ncount_nfeature_percentmt_filtered.png',  
  p1 + p3 + p5 +  
    p2 + p4 + plot_layout(ncol = 3),  
  height = 7, width = 10  
)  
</code></pre>
<p><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8lxl2xSzJ6VULEIPiaZu0htacJrRRdrq9Y5cHqGJ1UmYQ9SjrOPiaHgWF6y7IJyNDkrxZS9h7vgacg/640?wx_fmt=png&amp;from=appmsg" alt=""><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8lxl2xSzJ6VULEIPiaZu0htORDor9MWSkyLsc5FY0vdJH7XibFhgWSWiauO4H1QRsYwXGjbzQF6jj3A/640?wx_fmt=png&amp;from=appmsg" alt=""></p>
<p>如前文提到，我们应当过滤掉在小于五个细胞中表达的基因</p>
<pre><code>## 3.2 Filter genes过滤基因  
genes &lt;- data.frame(  
  gene = rownames(transcripts$raw$merged),  
  count = Matrix::rowSums(transcripts$raw$merged),  
  cells = Matrix::rowSums(transcripts$raw$merged != 0)  
)  
  
genes_to_keep &lt;- genes[genes$cells &gt;= 5,&quot;gene&quot;]  
length(genes_to_keep)  
#33000个过滤到16000个  
  
## 3.3 Generate filtered transcript matrix生成过滤后的转录本矩阵  
transcripts$raw$filtered &lt;- transcripts$raw$merged[genes_to_keep,cells_to_keep]  
save(transcripts,file = &quot;./data/filtered_transcripts_list.RData&quot;)  
  
cells_per_sample_after_filtering &lt;- data.frame(  
  sample = character(),  
  before = numeric(),  
  after = numeric()  
)  
  
for ( i in sample_names ) {  
  tmp &lt;- data.frame(  
    sample = i,  
    before = grep(colnames(transcripts$raw$merged), pattern = paste0('-', i)) %&gt;% length(),  
    after = grep(colnames(transcripts$raw$filtered), pattern = paste0('-', i)) %&gt;% length()  
  )  
  cells_per_sample_after_filtering &lt;- rbind(cells_per_sample_after_filtering, tmp)  
}  
  
knitr::kable(cells_per_sample_after_filtering)  
#在下表中，我们可以看到过滤前后每个样品中有多少细胞:  
</code></pre>
<h4 id="4生成seurat对象">4.生成Seurat对象</h4>
<pre><code>#准备好转录组count矩阵后，我们现在可以初始化我们的Seurat对象。之后，我们在meta data中存储每个样本赋值。  
seurat &lt;- CreateSeuratObject(  
  counts = transcripts$raw$filtered,  
  min.cells = 0,  
  min.features = 0  
)  
  
seurat@meta.data$sample &lt;- Cells(seurat) %&gt;%  
  strsplit('-') %&gt;%  
  vapply(FUN.VALUE = character(1), `[`, 2) %&gt;%  
  factor(levels = sample_names)  
  
#为了确保万无一失，让我们再看一次样本中每个细胞转录本和表达基因的分布。  
temp_labels &lt;- seurat@meta.data$sample %&gt;%  
  table %&gt;% as.data.frame()  
colnames(temp_labels) &lt;- c(&quot;sample&quot;,&quot;n&quot;)  
  
p1 &lt;- ggplot() +  
  geom_half_violin(  
    data = seurat@meta.data, aes(sample, nCount_RNA, fill = sample),  
    side = 'l', show.legend = FALSE, trim = FALSE  
  ) +  
  geom_half_boxplot(  
    data = seurat@meta.data, aes(sample, nCount_RNA, fill = sample),  
    side = 'r', outlier.color = NA, width = 0.4, show.legend = FALSE  
  ) +  
  geom_text(  
    data = temp_labels,  
    aes(x = sample, y = -Inf, label = paste0('n = ', format(n, big.mark = ',', trim = TRUE)), vjust = -1),  
    color = 'black', size = 2.8  
  ) +  
  scale_color_manual(values = custom_colors$discrete) +  
  scale_fill_manual(values = custom_colors$discrete) +  
  scale_y_continuous(labels = scales::comma, expand = c(0.08,0)) +  
  theme_bw() +  
  labs(x = '', y = 'Number of transcripts') +  
  theme(  
    panel.grid.major.x = element_blank(),  
    axis.title.x = element_blank()  
  )  
  
p2 &lt;- ggplot() +  
  geom_half_violin(  
    data = seurat@meta.data, aes(sample, nFeature_RNA, fill = sample),  
    side = 'l', show.legend = FALSE, trim = FALSE  
  ) +  
  geom_half_boxplot(  
    data = seurat@meta.data, aes(sample, nFeature_RNA, fill = sample),  
    side = 'r', outlier.color = NA, width = 0.4, show.legend = FALSE  
  ) +  
  geom_text(  
    data = temp_labels,  
    aes(x = sample, y = -Inf, label = paste0('n = ', format(n, big.mark = ',', trim = TRUE)), vjust = -1),  
    color = 'black', size = 2.8  
  ) +  
  scale_color_manual(values = custom_colors$discrete) +  
  scale_fill_manual(values = custom_colors$discrete) +  
  scale_y_continuous(  
    name = 'Number of expressed genes',  
    labels = scales::comma, expand = c(0.08,0)  
  ) +  
  theme_bw() +  
  theme(  
    panel.grid.major.x = element_blank(),  
    axis.title.x = element_blank()  
  )  
  
p1 + p2 + plot_layout(ncol = 2)  
  
ggsave(  
  'plots/ncount_nfeature_by_sample.png',  
  p1 + p2 + plot_layout(ncol = 2), height = 4, width = 10  
)  
</code></pre>
<p><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8lxl2xSzJ6VULEIPiaZu0htlHQhd7ic7YwZ1ytoZG6MsVAkI4f0gBMerkSKACo7uNsDvn8Oz0n1WEg/640?wx_fmt=png&amp;from=appmsg" alt=""></p>
<h4 id="5normalize-expression-data归一化">5.Normalize expression data归一化</h4>
<p>接下来，我们将原始转录本count归一化(以便每个细胞具有相同数量的转录本)并使用对数刻度。这可以用不同的方法和不同的工具来完成。Seurat包中的SCTransform()
和NormalizeData()
方法以及scran中的logNormCounts()
函数有着很好的运行效果。</p>
<p>这个函数调用sctransform::vst
。sctransform包可从 <a href="https://github.com/satijalab/sctransform">https://github.com/satijalab/sctransform</a> 获得。可使用此函数作为NormalizeData、FindVariableFeatures、ScaleData workflow的替代方法。结果保存在新的assay中(默认命名为SCT)，counts为校正后counts，data为log1p(counts)，scale.data为Pearson残差。sctransform::vst
的中间结果保存在新的assay的misc槽中。</p>
<pre><code>if(!require(glmGamPoi)) {  
  BiocManager::install('glmGamPoi')  
}  
library(glmGamPoi)  
seurat &lt;- SCTransform(seurat, assay = 'RNA')  
save(seurat,file = &quot;SCT_seurat.RData&quot;)  
</code></pre>
<h4 id="6-data-integration-数据整合">6. Data integration 数据整合</h4>
<p>在一些情况下，在不同预处理之后显示有明显批次效应，整合数据集则是有意义的。同样，有许多方法可以执行此任务。Seurat包中内置的数据整合过程已经被证明有很好的表现，我个人也有过很好的使用经验。对于这里分析的样本，我们不需要它，因此将跳过这一部分。</p>
<h4 id="7-principal-component-analysis-主成分分析">7. Principal component analysis 主成分分析</h4>
<p>主成分分析(PCA)经常被用作数据集降维的第一步。这里，我们计算前50个主成分。然后，我们必须选择用于继续分析的主成分数量。在最近的一篇论文中Germain等人建议使用intrinsicDimension包中的maxLikGlobalDimEst()
函数来测试数据集的维数。为此，还必须为参数k选择一个值。根据作者的经验，10-20范围内的值给出了合理且没有太大差异的结果。在下面的PCA结果图中，作者突出显示了maxLikGlobalDimEst()
(蓝线)的输出值，它在这里接近8。在作者看来，这个估计偏低了，所以将继续使用前15的主成分(红线)。此外，通常情况下，与使用太少的主成分相比，使用更多的主成分要好得多。</p>
<pre><code>seurat &lt;- RunPCA(seurat, assay = 'SCT', npcs = 50)  
  
intrinsicDimension::maxLikGlobalDimEst(seurat@reductions$pca@cell.embeddings, k = 10)  
# 8.202795   
  
p &lt;- data.frame(  
    PC = 1:50,  
    stdev = seurat@reductions$pca@stdev  
  ) %&gt;%  
  ggplot(aes(PC, stdev)) +  
  geom_point() +  
  geom_vline(xintercept = 8, color = 'blue') +  
  geom_vline(xintercept = 15, color = 'red') +  
  theme_bw() +  
  labs(x = 'Principal components', y = 'Standard deviation')  
  
p  
  
ggsave('plots/principal_components.png', p, height = 4, width = 5)  
</code></pre>
<p><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8lxl2xSzJ6VULEIPiaZu0htMAYlBiazCIDiarfVAbe3aY9L9RDhBOdj6eKkCP6OvH3M2BVB6lCR9URw/640?wx_fmt=png&amp;from=appmsg" alt=""></p>
<h4 id="8-clustering聚类">8 Clustering聚类</h4>
<p>鉴定具有相似转录谱的细胞亚群</p>
<pre><code>## 8.1 Define cluster聚类  
#我们使用Seurat的FindNeighbors和FindClusters聚类我们做的数据集中的细胞  
seurat &lt;- FindNeighbors(seurat, reduction = 'pca', dims = 1:15)  
seurat &lt;- FindClusters(seurat, resolution = 0.8)  
  
## 8.2 Number of transcripts and expressed genes  
如前文我们对样本执行过的操作，我们检查每一个聚类中的平均转录本和表达的基因数量。  
temp_labels &lt;- seurat@meta.data[,&quot;seurat_clusters&quot;] %&gt;%   
  table %&gt;% as.data.frame  
colnames(temp_labels)&lt;-c(&quot;seurat_clusters&quot;,&quot;n&quot;)  
  
p1 &lt;- ggplot() +  
  geom_half_violin(  
    data = seurat@meta.data, aes(seurat_clusters, nCount_RNA, fill = seurat_clusters),  
    side = 'l', show.legend = FALSE, trim = FALSE  
  ) +  
  geom_half_boxplot(  
    data = seurat@meta.data, aes(seurat_clusters, nCount_RNA, fill = seurat_clusters),  
    side = 'r', outlier.color = NA, width = 0.4, show.legend = FALSE  
  ) +  
  geom_text(  
    data = temp_labels,  
    aes(x = seurat_clusters, y = -Inf, label = paste0('n = ', format(n, big.mark = ',', trim = TRUE)), vjust = -1),  
    color = 'black', size = 2.8  
  ) +  
  scale_color_manual(values = custom_colors$discrete) +  
  scale_fill_manual(values = custom_colors$discrete) +  
  scale_y_continuous(name = 'Number of transcripts', labels = scales::comma, expand = c(0.08, 0)) +  
  theme_bw() +  
  theme(  
    panel.grid.major.x = element_blank(),  
    axis.title.x = element_blank()  
  )  
  
p2 &lt;- ggplot() +  
  geom_half_violin(  
    data = seurat@meta.data, aes(seurat_clusters, nFeature_RNA, fill = seurat_clusters),  
    side = 'l', show.legend = FALSE, trim = FALSE  
  ) +  
  geom_half_boxplot(  
    data = seurat@meta.data, aes(seurat_clusters, nFeature_RNA, fill = seurat_clusters),  
    side = 'r', outlier.color = NA, width = 0.4, show.legend = FALSE  
  ) +  
  geom_text(  
    data = temp_labels,  
    aes(x = seurat_clusters, y = -Inf, label = paste0('n = ', format(n, big.mark = ',', trim = TRUE)), vjust = -1),  
    color = 'black', size = 2.8  
  ) +  
  scale_color_manual(values = custom_colors$discrete) +  
  scale_fill_manual(values = custom_colors$discrete) +  
  scale_y_continuous(name = 'Number of expressed genes', labels = scales::comma, expand = c(0.08, 0)) +  
  theme_bw() +  
  theme(  
    panel.grid.major.x = element_blank(),  
    axis.title.x = element_blank()  
  )  
  
p1 + p2 + plot_layout(ncol = 1)  
  
ggsave(  
  'plots/ncount_nfeature_by_cluster.png',  
  p1 + p2 + plot_layout(ncol = 1),  
  height = 7, width = 14  
)  
</code></pre>
<p><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8lxl2xSzJ6VULEIPiaZu0htORZYrgtX39ThPW5xebGLZ86Cu7IicDL56Jj6ASLFJOt5B1UZSXQNeyg/640?wx_fmt=png&amp;from=appmsg" alt=""></p>
<h4 id="9cell-cycle-analysis细胞周期分析">9.Cell cycle analysis细胞周期分析</h4>
<p>使用Seurat包的CellCycleScoring()
函数，我们可以为每个细胞分配细胞周期：G1, S, G2M</p>
<pre><code>## 9.1 Infer cell cycle status推断细胞周期状态  
seurat &lt;- CellCycleScoring(  
  seurat,  
  assay = 'SCT',  
  s.features = cc.genes$s.genes,  
  g2m.features = cc.genes$g2m.genes  
)  
  
seurat@meta.data$cell_cycle_seurat &lt;- seurat@meta.data$Phase  
seurat@meta.data$Phase &lt;- NULL  
#字符串转因子  
seurat@meta.data$cell_cycle_seurat &lt;- factor(  
  seurat@meta.data$cell_cycle_seurat, levels = c('G1', 'S', 'G2M')  
)  
  
## 9.2 Composition of samples and clusters by cell cycle样本和聚类中细胞的细胞周期组成  
#现在检查每个样本和聚类中的细胞周期阶段分布  
#样本中：  
table_samples_by_cell_cycle&lt;-data.frame()  
for(i in unique(seurat@meta.data$sample)){  
  seurat@meta.data[seurat@meta.data$sample==i,&quot;cell_cycle_seurat&quot;] %&gt;% table -&gt; nCycle  
  c(i,sum(nCycle),nCycle) -&gt;nCycle  
  names(nCycle)[1:2]&lt;-c(&quot;sample&quot;,&quot;total_cell_count&quot;)  
  rbind(table_samples_by_cell_cycle,nCycle)-&gt;table_samples_by_cell_cycle  
}  
colnames(table_samples_by_cell_cycle)&lt;-names(nCycle)  
for (i in 2:5) {  
  as.numeric(table_samples_by_cell_cycle[,i])-&gt;table_samples_by_cell_cycle[,i]  
}  
  
knitr::kable(table_samples_by_cell_cycle)  
  
#聚类中：  
table_clusters_by_cell_cycle&lt;-data.frame()  
for(i in unique(seurat@meta.data$seurat_clusters)){  
  seurat@meta.data[seurat@meta.data$seurat_clusters==i,&quot;cell_cycle_seurat&quot;] %&gt;% table -&gt; nCycle  
  c(i,sum(nCycle),nCycle) -&gt;nCycle  
  names(nCycle)[1:2]&lt;-c(&quot;cluster&quot;,&quot;total_cell_count&quot;)  
  rbind(table_clusters_by_cell_cycle,nCycle)-&gt;table_clusters_by_cell_cycle  
}  
colnames(table_clusters_by_cell_cycle)&lt;-names(nCycle)  
  
for (i in 1:5) {  
  as.numeric(table_clusters_by_cell_cycle[,i])-&gt;table_clusters_by_cell_cycle[,i]  
}  
  
table_clusters_by_cell_cycle[order(table_clusters_by_cell_cycle$cluster,decreasing = F),]-&gt;table_clusters_by_cell_cycle  
rownames(table_clusters_by_cell_cycle)&lt;-NULL  
  
knitr::kable(table_clusters_by_cell_cycle)  
  
#不同阶段细胞所占比例  
temp_labels &lt;- seurat@meta.data$sample %&gt;% table %&gt;% as.data.frame  
colnames(temp_labels)&lt;-c(&quot;sample&quot;,&quot;n&quot;)  
  
p1 &lt;- table_samples_by_cell_cycle %&gt;%  
  select(-c('total_cell_count')) %&gt;%  
  reshape2::melt(id.vars = 'sample') %&gt;%  
  mutate(sample = factor(sample, levels = levels(seurat@meta.data$sample))) %&gt;%  
  ggplot(aes(sample, value)) +  
  geom_bar(aes(fill = variable), position = 'fill', stat = 'identity') +  
  geom_text(  
    data = temp_labels,  
    aes(x = sample, y = Inf, label = paste0('n = ', format(n, big.mark = ',', trim = TRUE)), vjust = -1),  
    color = 'black', size = 2.8  
  ) +  
  scale_fill_manual(name = 'Cell cycle', values = custom_colors$cell_cycle) +  
  scale_y_continuous(name = 'Percentage [%]', labels = scales::percent_format(), expand = c(0.01,0)) +  
  coord_cartesian(clip = 'off') +  
  theme_bw() +  
  theme(  
    legend.position = 'none',  
    plot.title = element_text(hjust = 0.5),  
    text = element_text(size = 16),  
    panel.grid.major = element_blank(),  
    panel.grid.minor = element_blank(),  
    axis.title.x = element_blank(),  
    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1),  
    plot.margin = margin(t = 20, r = 0, b = 0, l = 0, unit = 'pt')  
  )  
  
p1  
  
ggsave(  
  'plots/composition_samples_clusters_by_cell_cycle_by_percent.png',  
  p1 + p2 +  
  plot_layout(ncol = 2, widths = c(  
    seurat@meta.data$sample %&gt;% unique() %&gt;% length(),  
    seurat@meta.data$seurat_clusters %&gt;% unique() %&gt;% length()  
  )),  
  width = 18, height = 8  
)  
  
save(seurat,file = &quot;Cyclin_seurat.RData&quot;)  
</code></pre>
<p><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8lxl2xSzJ6VULEIPiaZu0hte5Sumtv8mjxZk65LaSzyjxhU5icMicUcc1MQ5wRWjVvPTWxgnkdyoz1Q/640?wx_fmt=png&amp;from=appmsg" alt=""></p>
<h4 id="10dimensional-reduction降维">10.Dimensional reduction降维</h4>
<p>在下文中我们讲数据集中细胞的表达谱投影到二维或三维中展示，通常使用t-SNE或UMAP的方法</p>
<pre><code>##10.1 t-SNE图  
library(ggnetwork)  
load(&quot;Cyclin_seurat.RData&quot;)  
SCT_snn &lt;- seurat@graphs$SCT_snn %&gt;%  
  as.matrix() %&gt;%  
  ggnetwork() %&gt;%  
  left_join(seurat@meta.data %&gt;% mutate(vertex.names = rownames(.)), by = 'vertex.names')  
  
p1 &lt;- ggplot(SCT_snn, aes(x = x, y = y, xend = xend, yend = yend)) +  
  geom_edges(color = 'grey50', alpha = 0.05) +  
  geom_nodes(aes(color = sample), size = 0.5) +  
  scale_color_manual(  
    name = 'Sample', values = custom_colors$discrete,  
    guide = guide_legend(ncol = 1, override.aes = list(size = 2))  
  ) +  
  theme_blank() +  
  theme(legend.position = 'left') +  
  annotate(  
    geom = 'text', x = Inf, y = -Inf,  
    label = paste0('n = ', format(nrow(seurat@meta.data), big.mark = ',', trim = TRUE)),  
    vjust = -1.5, hjust = 1.25, color = 'black', size = 2.5  
  )  
  
p2 &lt;- ggplot(SCT_snn, aes(x = x, y = y, xend = xend, yend = yend)) +  
  geom_edges(color = 'grey50', alpha = 0.05) +  
  geom_nodes(aes(color = seurat_clusters), size = 0.5) +  
  scale_color_manual(  
    name = 'Cluster', values = custom_colors$discrete,  
    guide = guide_legend(ncol = 1, override.aes = list(size = 2))  
  ) +  
  theme_blank() +  
  theme(legend.position = 'right') +  
  annotate(  
    geom = 'text', x = Inf, y = -Inf,  
    label = paste0('n = ', format(nrow(seurat@meta.data), big.mark = ',', trim = TRUE)),  
    vjust = -1.5, hjust = 1.25, color = 'black', size = 2.5  
  )  
  
ggsave(  
  'plots/snn_graph_by_sample_cluster.png',  
  p1 + p2 + plot_layout(ncol = 2),  
  height = 5, width = 11  
)  
</code></pre>
<p><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8lxl2xSzJ6VULEIPiaZu0htQS1YdNFk74awLZx1tJNJR1hRZsxBic2EGRajyJ1lbVWOnkPusHicDJYQ/640?wx_fmt=png&amp;from=appmsg" alt=""></p>
<pre><code>## 10.2 UMAP  
### 10.2.1 Calculate UMAP计算UMAP  
#我们使用与前文用于聚类一致的15个主成分进行UMAP计算  
seurat &lt;- RunUMAP(  
  seurat,  
  reduction.name = 'UMAP',  
  reduction = 'pca',  
  dims = 1:15,  
  n.components = 2,  
  seed.use = 100  
)  
  
### 10.2.2 Overview预览  
#在计算完UMAP之后，我们分别根据转录本数量，样本来源，聚类结果，和细胞周期对其进行上色  
  
plot_umap_by_nCount &lt;- bind_cols(seurat@meta.data, as.data.frame(seurat@reductions$UMAP@cell.embeddings)) %&gt;%  
  ggplot(aes(UMAP_1, UMAP_2, color = nCount_RNA)) +  
  geom_point(size = 0.2) +  
  theme_bw() +  
  scale_color_viridis(  
    guide = guide_colorbar(frame.colour = 'black', ticks.colour = 'black'),  
    labels = scales::comma,  
  ) +  
  labs(color = 'Number of\ntranscripts') +  
  theme(legend.position = 'left') +  
  coord_fixed() +  
  annotate(  
    geom = 'text', x = Inf, y = -Inf,  
    label = paste0('n = ', format(nrow(seurat@meta.data), big.mark = ',', trim = TRUE)),  
    vjust = -1.5, hjust = 1.25, color = 'black', size = 2.5  
  )  
  
plot_umap_by_sample &lt;- bind_cols(seurat@meta.data, as.data.frame(seurat@reductions$UMAP@cell.embeddings)) %&gt;%  
  ggplot(aes(UMAP_1, UMAP_2, color = sample)) +  
  geom_point(size = 0.2) +  
  theme_bw() +  
  scale_color_manual(values = custom_colors$discrete) +  
  labs(color = 'Sample') +  
  guides(colour = guide_legend(override.aes = list(size = 2))) +  
  theme(legend.position = 'right') +  
  coord_fixed() +  
  annotate(  
    geom = 'text', x = Inf, y = -Inf,  
    label = paste0('n = ', format(nrow(seurat@meta.data), big.mark = ',', trim = TRUE)),  
    vjust = -1.5, hjust = 1.25, color = 'black', size = 2.5  
  )  
  
plot_umap_by_cluster &lt;- bind_cols(seurat@meta.data, as.data.frame(seurat@reductions$UMAP@cell.embeddings)) %&gt;%  
  ggplot(aes(UMAP_1, UMAP_2, color = seurat_clusters)) +  
  geom_point(size = 0.2) +  
  theme_bw() +  
  scale_color_manual(  
    name = 'Cluster', values = custom_colors$discrete,  
    guide = guide_legend(ncol = 2, override.aes = list(size = 2))  
  ) +  
  theme(legend.position = 'left') +  
  coord_fixed() +  
  annotate(  
    geom = 'text', x = Inf, y = -Inf,  
    label = paste0('n = ', format(nrow(seurat@meta.data), big.mark = ',', trim = TRUE)),  
    vjust = -1.5, hjust = 1.25, color = 'black', size = 2.5  
  )  
  
plot_umap_by_cell_cycle &lt;- bind_cols(seurat@meta.data, as.data.frame(seurat@reductions$UMAP@cell.embeddings)) %&gt;%  
  ggplot(aes(UMAP_1, UMAP_2, color = cell_cycle_seurat)) +  
  geom_point(size = 0.2) +  
  theme_bw() +  
  scale_color_manual(values = custom_colors$cell_cycle) +  
  labs(color = 'Cell cycle') +  
  guides(colour = guide_legend(override.aes = list(size = 2))) +  
  theme(legend.position = 'right') +  
  coord_fixed() +  
  annotate(  
    geom = 'text', x = Inf, y = -Inf,  
    label = paste0('n = ', format(nrow(seurat@meta.data), big.mark = ',', trim = TRUE)),  
    vjust = -1.5, hjust = 1.25, color = 'black', size = 2.5  
  )  
  
ggsave(  
  'plots/umap.png',  
  plot_umap_by_nCount + plot_umap_by_sample +  
  plot_umap_by_cluster + plot_umap_by_cell_cycle +  
  plot_layout(ncol = 2),  
  height = 6,  
  width = 8.5  
)  
</code></pre>
<p><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8lxl2xSzJ6VULEIPiaZu0hte80ZDlNEN4bW23F42f5yVDLg23aw1Qg8FkqBuyg1oY5zeoU4ax9Y0Q/640?wx_fmt=png&amp;from=appmsg" alt=""></p>
<pre><code>### 10.2.3 Samples样本间UMAP  
#为了探究不同样本的结果是否能较好重合，我们根据样本划分板块再次做UMAP。  
temp_labels &lt;- seurat@meta.data %&gt;%  
  group_by(sample) %&gt;%  
  tally()  
  
p &lt;- bind_cols(seurat@meta.data, as.data.frame(seurat@reductions$UMAP@cell.embeddings)) %&gt;%  
  ggplot(aes(UMAP_1, UMAP_2, color = sample)) +  
  geom_point(size = 0.2, show.legend = FALSE) +  
  geom_text(  
    data = temp_labels,  
    aes(x = Inf, y = -Inf, label = paste0('n = ', format(n, big.mark = ',', trim = TRUE)), vjust = -1.5, hjust = 1.25),  
    color = 'black', size = 2.8  
  ) +  
  theme_bw() +  
  scale_color_manual(values = custom_colors$discrete) +  
  coord_fixed() +  
  theme(  
    legend.position = 'none',  
    strip.text = element_text(face = 'bold', size = 10)  
  ) +  
  facet_wrap(~sample, ncol = 5)  
  
ggsave(  
  'plots/umap_by_sample_split.png',  
  p,  
  height = 4,  
  width = 10  
)  
  
### 10.2.4 聚类  
#对于聚类，我们在每个聚类的几何中心添个标签或自己的注释。  
UMAP_centers_cluster &lt;- tibble(  
    UMAP_1 = as.data.frame(seurat@reductions$UMAP@cell.embeddings)$UMAP_1,  
    UMAP_2 = as.data.frame(seurat@reductions$UMAP@cell.embeddings)$UMAP_2,  
    cluster = seurat@meta.data$seurat_clusters  
  ) %&gt;%  
  group_by(cluster) %&gt;%  
  summarize(x = median(UMAP_1), y = median(UMAP_2))  
  
p &lt;- bind_cols(seurat@meta.data, as.data.frame(seurat@reductions$UMAP@cell.embeddings)) %&gt;%  
  ggplot(aes(UMAP_1, UMAP_2, color = seurat_clusters)) +  
  geom_point(size = 0.2) +  
  geom_label(  
    data = UMAP_centers_cluster,  
    mapping = aes(x, y, label = cluster),  
    size = 4.5,  
    fill = 'white',  
    color = 'black',  
    fontface = 'bold',  
    alpha = 0.5,  
    label.size = 0,  
    show.legend = FALSE  
  ) +  
  theme_bw() +  
  scale_color_manual(  
    name = 'Cluster', values = custom_colors$discrete,  
    guide = guide_legend(override.aes = list(size = 2))  
  ) +  
  theme(legend.position = 'right') +  
  coord_fixed() +  
  annotate(  
    geom = 'text', x = Inf, y = -Inf,  
    label = paste0('n = ', format(nrow(seurat@meta.data), big.mark = ',', trim = TRUE)),  
    vjust = -1.5, hjust = 1.25, color = 'black', size = 2.5  
  )  
  
ggsave(  
  'plots/umap_by_clusters.png',  
  p, height = 5.5, width = 5.5  
)  
</code></pre>
<p><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8lxl2xSzJ6VULEIPiaZu0htwJButwcYl1MzdFWhNphC1F8bX0P5NevrdQiaU07P8TsS0zpicDb6x9lw/640?wx_fmt=png&amp;from=appmsg" alt=""><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8lxl2xSzJ6VULEIPiaZu0htgl24ZQ2MvmEhiallvSl1rViauMEdAm1ESsd0W9iaGRMrxcc17wsZwMFrA/640?wx_fmt=png&amp;from=appmsg" alt=""></p>
<h4 id="11-cell-type-annotation-with-singler使用singler进行细胞类型注释">11 Cell type annotation with SingleR使用SingleR进行细胞类型注释</h4>
<p>细胞类型的推断有多种软件包可以实现，或者根据自己生物学背景进行手动注释。作者使用SingleR包进行了自动注释</p>
<pre><code>##### 11.1 Assign labels分配标签  
#首先我们给每个细胞分配了标签作为参考。然后提取标签和分配分数，并将它们添加到Seurat对象中。  
library(SingleR)  
  
singler_ref &lt;- celldex::BlueprintEncodeData()  
  
singler_results_blueprintencode_main &lt;- SingleR::SingleR(  
  test = GetAssayData(seurat, assay = 'SCT', layer = 'data'),  
  ref = singler_ref,  
  labels = singler_ref@colData@listData$label.main  
)  
  
saveRDS(singler_results_blueprintencode_main, &quot;data/singler_results_blueprintencode_main.rds&quot;)  
  
p &lt;- plotScoreHeatmap(  
    singler_results_blueprintencode_main,  
    show.labels = TRUE,  
    annotation_col = data.frame(  
      donor = seurat@meta.data$sample,  
      row.names = rownames(singler_results_blueprintencode_main)  
    )  
  )  
  
p  
  
ggsave(  
  'plots/singler_score_heatmap_blueprintencode_main.png', p,  
  height = 11, width = 14  
)  
  
seurat@meta.data$cell_type_singler_blueprintencode_main &lt;- singler_results_blueprintencode_main@listData$labels  
  
singler_scores &lt;- singler_results_blueprintencode_main@listData$scores %&gt;%  
  as_tibble() %&gt;%  
  dplyr::mutate(assigned_score = NA)  
  
for ( i in seq_len(nrow(singler_scores)) ) {  
  singler_scores$assigned_score[i] &lt;- singler_scores[[singler_results_blueprintencode_main@listData$labels[i]]][i]  
}  
  
seurat@meta.data$cell_type_singler_blueprintencode_main_score &lt;- singler_scores$assigned_score  
  
save(seurat,file=&quot;labels_assinged_seurat.Rdata&quot;)  
  
## 11.2 Assignment score by sample, cluster and cell type  
#在这里，我们绘制了每个样本、聚类和细胞类型的分配打分分布。  
load(&quot;labels_assinged_seurat.Rdata&quot;)  
temp_labels &lt;- seurat@meta.data %&gt;%  
  group_by(sample) %&gt;%  
  tally()  
as.data.frame(temp_labels) -&gt; temp_labels  
  
p1 &lt;- ggplot() +  
  geom_half_violin(  
    data = seurat@meta.data,  
    aes(  
      x = sample,  
      y = cell_type_singler_blueprintencode_main_score,  
      fill = sample  
    ),  
    side = 'l', show.legend = FALSE, trim = FALSE  
  ) +  
  geom_half_boxplot(  
    data = seurat@meta.data,  
    aes(  
      x = sample,  
      y = cell_type_singler_blueprintencode_main_score,  
      fill = sample  
    ),  
    side = 'r', outlier.color = NA, width = 0.4, show.legend = FALSE  
  ) +  
  geom_text(  
    data = temp_labels,  
    aes(  
      x = sample,  
      y = -Inf,  
      label = paste0('n = ', format(n, big.mark = ',', trim = TRUE)),  
      vjust = -1  
    ),  
    color = 'black', size = 2.8  
  ) +  
  scale_color_manual(values = custom_colors$discrete) +  
  scale_fill_manual(values = custom_colors$discrete) +  
  scale_y_continuous(  
    name = 'Assignment score',  
    labels = scales::comma,  
    limits = c(0,1)  
  ) +  
  theme_bw() +  
  labs(title = 'Samples') +  
  theme(  
    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1),  
    axis.title.x = element_blank(),  
    panel.grid.major.x = element_blank()  
  )  
  
temp_labels &lt;- seurat@meta.data %&gt;%  
  group_by(seurat_clusters) %&gt;%  
  tally()  
as.data.frame(temp_labels) -&gt; temp_labels  
  
p2 &lt;- ggplot() +  
  geom_half_violin(  
    data = seurat@meta.data,  
    aes(  
      x = seurat_clusters,  
      y = cell_type_singler_blueprintencode_main_score,  
      fill = seurat_clusters  
    ),  
    side = 'l', show.legend = FALSE, trim = FALSE  
  ) +  
  geom_half_boxplot(  
    data = seurat@meta.data,  
    aes(  
      x = seurat_clusters,  
      y = cell_type_singler_blueprintencode_main_score,  
      fill = seurat_clusters  
    ),  
    side = 'r', outlier.color = NA, width = 0.4, show.legend = FALSE  
  ) +  
  geom_text(  
    data = temp_labels,  
    aes(  
      x = seurat_clusters,  
      y = -Inf,  
      label = paste0('n = ', format(n, big.mark = ',', trim = TRUE)),  
      vjust = -1  
    ),  
    color = 'black', size = 2.8  
  ) +  
  scale_color_manual(values = custom_colors$discrete) +  
  scale_fill_manual(values = custom_colors$discrete) +  
  scale_y_continuous(  
    name = 'Assignment score',  
    labels = scales::comma,  
    limits = c(0,1)  
  ) +  
  labs(title = 'Clusters') +  
  theme_bw() +  
  theme(  
    axis.title.x = element_blank(),  
    panel.grid.major.x = element_blank()  
  )  
  
temp_labels &lt;- seurat@meta.data %&gt;%  
  group_by(cell_type_singler_blueprintencode_main) %&gt;%  
  tally()  
as.data.frame(temp_labels) -&gt; temp_labels  
  
temp_labels[temp_labels[,1]!=&quot;Fibroblasts&quot;,] -&gt; temp_labels  
  
#table(seurat@meta.data$cell_type_singler_blueprintencode_main)  
#DC类细胞只有一个画不了图，得删掉  
data.frame(seurat@meta.data$cell_type_singler_blueprintencode_main,  
seurat@meta.data$cell_type_singler_blueprintencode_main_score) -&gt; tmpPlotDf  
tmpPlotDf[tmpPlotDf[,1]!=&quot;DC&quot;,] -&gt; tmpPlotDf  
table(tmpPlotDf[,1])  
as.character(tmpPlotDf[,1]) -&gt; tmpPlotDf[,1]  
  
p3 &lt;- ggplot() +  
  geom_half_violin(  
    data = tmpPlotDf, #seurat@meta.data  
    aes(  
      x = seurat.meta.data.cell_type_singler_blueprintencode_main,  
      y = seurat.meta.data.cell_type_singler_blueprintencode_main_score,  
      fill = seurat.meta.data.cell_type_singler_blueprintencode_main  
    ),  
    side = 'l', show.legend = FALSE, trim = FALSE,  
  ) +  
  geom_half_boxplot(  
    data = tmpPlotDf,  
    aes(  
      x = seurat.meta.data.cell_type_singler_blueprintencode_main,  
      y = seurat.meta.data.cell_type_singler_blueprintencode_main_score,  
      fill = seurat.meta.data.cell_type_singler_blueprintencode_main  
    ),  
    side = 'r', outlier.color = NA, width = 0.4, show.legend = FALSE  
  ) +  
  geom_text(  
    data = temp_labels,  
    aes(  
      x = cell_type_singler_blueprintencode_main,  
      y = -Inf,  
      label = paste0('n = ', format(n, big.mark = ',', trim = TRUE)),  
      vjust = -1  
    ),  
    color = 'black', size = 2.8  
  ) +  
  scale_color_manual(values = custom_colors$discrete) +  
  scale_fill_manual(values = custom_colors$discrete) +  
  scale_y_continuous(  
    name = 'Assignment score',  
    labels = scales::comma,  
    limits = c(0,1)  
  ) +  
  labs(title = 'Cell types') +  
  theme_bw() +  
  theme(  
    axis.title.x = element_blank(),  
    panel.grid.major.x = element_blank()  
  )  
  
(p1 | p3) / p2 + plot_layout(ncol = 1)  
  
#若出现以下报错，说明数据不足以画小提琴图，可能是某个种类细胞只有一个，剔除后就正常了  
# #Error in `geom_half_violin()`:  
# ! Problem while converting geom to grob.  
# ℹ Error occurred in the 1st layer.  
# Caused by error in `if ((is_panel &amp; (side[1] == &quot;l&quot;)) | is_group) ...`:  
# ! 需要TRUE/FALSE值的地方不可以用缺少值  
# Run `rlang::last_trace()` to see where the error occurred.  
# Warning message:  
# Groups with fewer than two datapoints have been dropped.  
# ℹ Set `drop = FALSE` to consider such groups for position adjustment purposes.   
  
ggsave(  
  'plots/singler_blueprintencode_main_assignment_scores_by_sample_cluster_cell_type.png',  
  (p1 | p3) / p2 + plot_layout(ncol = 1), height = 13, width = 16  
)  
</code></pre>
<p><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8lxl2xSzJ6VULEIPiaZu0htWpymsnI65Dro6T7wibUicwEYEnYO9TN4a69S6kezsTwHwP0df9MzZ3Cg/640?wx_fmt=png&amp;from=appmsg" alt=""><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8lxl2xSzJ6VULEIPiaZu0htS1X3z4z0mxZhDZvQNlFN2OHUarUC6bzdqYjQibDYndCtMhia2bPpnaCQ/640?wx_fmt=png&amp;from=appmsg" alt=""></p>
<p>我们然后检查样本和聚类在细胞类型方面是怎样构成的</p>
<pre><code>## 11.3 Composition of samples and clusters by cell  
table_samples_by_cell_type &lt;- seurat@meta.data %&gt;%  
  dplyr::group_by(sample, cell_type_singler_blueprintencode_main) %&gt;%  
  dplyr::summarize(count = n()) %&gt;%  
  tidyr::spread(cell_type_singler_blueprintencode_main, count, fill = 0) %&gt;%  
  dplyr::ungroup() %&gt;%  
  dplyr::mutate(total_cell_count = rowSums(.[c(2:ncol(.))])) %&gt;%  
  dplyr::select(c(&quot;sample&quot;, &quot;total_cell_count&quot;, dplyr::everything()))  
  
table_samples_by_cell_type %&gt;% knitr::kable()  
  
table_clusters_by_cell_type &lt;- seurat@meta.data %&gt;%  
  dplyr::group_by(seurat_clusters, cell_type_singler_blueprintencode_main) %&gt;%  
  dplyr::rename(cluster = seurat_clusters) %&gt;%  
  dplyr::summarize(count = n()) %&gt;%  
  tidyr::spread(cell_type_singler_blueprintencode_main, count, fill = 0) %&gt;%  
  dplyr::ungroup() %&gt;%  
  dplyr::mutate(total_cell_count = rowSums(.[c(2:ncol(.))])) %&gt;%  
  dplyr::select(c(&quot;cluster&quot;, &quot;total_cell_count&quot;, dplyr::everything()))  
  
table_clusters_by_cell_type %&gt;% knitr::kable()  
  
#下图是按样本/聚类的细胞百分比组成。  
temp_labels &lt;- seurat@meta.data %&gt;%  
  group_by(sample) %&gt;%  
  tally()  
  
p1 &lt;- table_samples_by_cell_type %&gt;%  
  select(-c('total_cell_count')) %&gt;%  
  reshape2::melt(id.vars = 'sample') %&gt;%  
  mutate(sample = factor(sample, levels = levels(seurat@meta.data$sample))) %&gt;%  
  ggplot(aes(sample, value)) +  
  geom_bar(aes(fill = variable), position = 'fill', stat = 'identity', show.legend = FALSE) +  
  geom_text(  
    data = temp_labels,  
    aes(  
      x = sample,  
      y = Inf,  
      label = paste0('n = ', format(n, big.mark = ',', trim = TRUE)),  
      vjust = -1  
    ),  
    color = 'black', size = 2.8  
  ) +  
  scale_fill_manual(name = 'Cell type', values = custom_colors$discrete) +  
  scale_y_continuous(  
    name = 'Percentage [%]',  
    labels = scales::percent_format(),  
    expand = c(0.01,0)  
  ) +  
  coord_cartesian(clip = 'off') +  
  theme_bw() +  
  theme(  
    legend.position = 'none',  
    plot.title = element_text(hjust = 0.5),  
    text = element_text(size = 16),  
    panel.grid.major = element_blank(),  
    panel.grid.minor = element_blank(),  
    axis.title.x = element_blank(),  
    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1),  
    plot.margin = margin(t = 20, r = 0, b = 0, l = 0, unit = 'pt')  
  )  
  
temp_labels &lt;- seurat@meta.data %&gt;%  
  group_by(seurat_clusters) %&gt;%  
  tally() %&gt;%  
  dplyr::rename('cluster' = seurat_clusters)  
  
p2 &lt;- table_clusters_by_cell_type %&gt;%  
  select(-c('total_cell_count')) %&gt;%  
  reshape2::melt(id.vars = 'cluster') %&gt;%  
  mutate(cluster = factor(cluster, levels = levels(seurat@meta.data$seurat_clusters))) %&gt;%  
  ggplot(aes(cluster, value)) +  
  geom_bar(aes(fill = variable), position = 'fill', stat = 'identity') +  
  geom_text(  
    data = temp_labels,  
    aes(  
      x = cluster,  
      y = Inf,  
      label = paste0('n = ', format(n, big.mark = ',', trim = TRUE)),  
      vjust = -1  
    ),  
    color = 'black', size = 2.8  
  ) +  
  scale_fill_manual(name = 'Cell type', values = custom_colors$discrete) +  
  scale_y_continuous(  
    name = 'Percentage [%]',  
    labels = scales::percent_format(),  
    expand = c(0.01,0)  
  ) +  
  coord_cartesian(clip = 'off') +  
  theme_bw() +  
  theme(  
    legend.position = 'right',  
    plot.title = element_text(hjust = 0.5),  
    text = element_text(size = 16),  
    panel.grid.major = element_blank(),  
    panel.grid.minor = element_blank(),  
    axis.title = element_blank(),  
    plot.margin = margin(t = 20, r = 0, b = 0, l = 10, unit = 'pt')  
  )  
  
p1 + p2 +  
  plot_layout(ncol = 2, widths = c(  
    seurat@meta.data$sample %&gt;% unique() %&gt;% length(),  
    seurat@meta.data$seurat_clusters %&gt;% unique() %&gt;% length()  
  ))  
  
ggsave(  
  'plots/composition_samples_clusters_by_cell_type_singler_blueprintencode_main_by_percent.png',  
  p1 + p2 +  
  plot_layout(ncol = 2, widths = c(  
    seurat@meta.data$sample %&gt;% unique() %&gt;% length(),  
    seurat@meta.data$seurat_clusters %&gt;% unique() %&gt;% length()  
  )),  
  width = 18, height = 8  
)  
</code></pre>
<p><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8lxl2xSzJ6VULEIPiaZu0htuuAC8icL6XosFicuVFJjeuJWoRxeiccT6Lq5KX3K7oLSQcC3wWKzn96wA/640?wx_fmt=png&amp;from=appmsg" alt=""></p>
<h4 id="冲积图">冲积图</h4>
<p>看细胞类型在样本中的分布</p>
<pre><code>### 11.3.1 Alluvial plots冲积图  
## get sample and cluster names  
samples &lt;- levels(seurat@meta.data$sample)  
clusters &lt;- levels(seurat@meta.data$seurat_clusters)  
  
## create named vector holding the color assignments for both samples and  
## clusters  
color_assignments &lt;- setNames(  
  c(custom_colors$discrete[1:length(samples)], custom_colors$discrete[1:length(clusters)]),  
  c(samples,clusters)  
)  
  
## prepare data for the plot; factor() calls are necessary for the right order  
## of columns (first samples then clusters) and boxes within each column (  
## cluster 1, 2, 3, ..., not 1, 10, 11, ...)  
data &lt;- seurat@meta.data %&gt;%  
  group_by(sample,seurat_clusters) %&gt;%  
  tally() %&gt;%  
  ungroup() %&gt;%  
  gather_set_data(1:2) %&gt;%  
  dplyr::mutate(  
    x = factor(x, levels = unique(x)),  
    y = factor(y, levels = unique(y))  
  )  
  
DataFrame(data)  
  
data_labels &lt;- tibble(  
    group = c(  
      rep('sample', length(samples)),  
      rep('seurat_clusters', length(clusters))  
    )  
 ) %&gt;%  
  mutate(  
    hjust = ifelse(group == 'sample', 1, 0),  
    nudge_x = ifelse(group == 'sample', -0.1, 0.1)  
  )  
  
DataFrame(data_labels)  
  
## create plot  
p1 &lt;- ggplot(data, aes(x, id = id, split = y, value = n)) +  
  geom_parallel_sets(aes(fill = seurat_clusters), alpha = 0.75, axis.width = 0.15) +  
  geom_parallel_sets_axes(aes(fill = y), color = 'black', axis.width = 0.1) +  
  geom_text(  
    aes(y = n, split = y), stat = 'parallel_sets_axes', fontface = 'bold',  
    hjust = data_labels$hjust, nudge_x = data_labels$nudge_x  
  ) +  
  scale_x_discrete(labels = c('Sample','Cluster')) +  
  scale_fill_manual(values = color_assignments) +  
  theme_bw() +  
  theme(  
    legend.position = 'none',  
    axis.title = element_blank(),  
    axis.text.x = element_text(face = 'bold', colour = 'black', size = 15),  
    axis.text.y = element_blank(),  
    axis.ticks = element_blank(),  
    panel.grid.major = element_blank(),  
    panel.grid.minor = element_blank(),  
    panel.border = element_blank()  
  )  
```  
  
聚类结果对细胞类型  
```{r}  
clusters &lt;- levels(seurat@meta.data$seurat_clusters)  
cell_types &lt;- sort(unique(seurat@meta.data$cell_type_singler_blueprintencode_main))  
  
color_assignments &lt;- setNames(  
  c(custom_colors$discrete[1:length(clusters)], custom_colors$discrete[1:length(cell_types)]),  
  c(clusters,cell_types)  
)  
  
data &lt;- seurat@meta.data %&gt;%  
  dplyr::rename(cell_type = cell_type_singler_blueprintencode_main) %&gt;%  
  dplyr::mutate(cell_type = factor(cell_type, levels = cell_types)) %&gt;%  
  group_by(seurat_clusters, cell_type) %&gt;%  
  tally() %&gt;%  
  ungroup() %&gt;%  
  gather_set_data(1:2) %&gt;%  
  dplyr::mutate(  
    x = factor(x, levels = unique(x)),  
    y = factor(y, levels = c(clusters,cell_types))  
  )  
  
data_labels &lt;- tibble(  
    group = c(  
      rep('seurat_clusters', length(clusters)),  
      rep('cell_type', length(cell_types))  
    )  
 ) %&gt;%  
  mutate(  
    hjust = ifelse(group == 'seurat_clusters', 1, 0),  
    nudge_x = ifelse(group == 'seurat_clusters', -0.1, 0.1)  
  )  
  
p2 &lt;- ggplot(data, aes(x, id = id, split = y, value = n)) +  
  geom_parallel_sets(aes(fill = seurat_clusters), alpha = 0.75, axis.width = 0.15) +  
  geom_parallel_sets_axes(aes(fill = y), color = 'black', axis.width = 0.1) +  
  geom_text(  
    aes(y = n, split = y), stat = 'parallel_sets_axes', fontface = 'bold',  
    hjust = data_labels$hjust, nudge_x = data_labels$nudge_x  
  ) +  
  scale_x_discrete(labels = c('Cluster','Cell type')) +  
  scale_fill_manual(values = color_assignments) +  
  theme_bw() +  
  theme(  
    legend.position = 'none',  
    axis.title = element_blank(),  
    axis.text.x = element_text(face = 'bold', colour = 'black', size = 15),  
    axis.text.y = element_blank(),  
    axis.ticks = element_blank(),  
    panel.grid.major = element_blank(),  
    panel.grid.minor = element_blank(),  
    panel.border = element_blank()  
  )  
p1 + p2 + plot_layout(ncol = 2)  
  
ggsave(  
  'plots/samples_clusters_cell_types_alluvial.png',  
  p1 + p2 + plot_layout(ncol = 2),  
  height = 6, width = 8  
)  
</code></pre>
<p><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8lxl2xSzJ6VULEIPiaZu0htBw4tMdqCs9fzIr7jWlNYm3t4PDyOJ72Pdicl22n7pRn7qh8asOKEA6Q/640?wx_fmt=png&amp;from=appmsg" alt=""></p>
<p>类似于根据聚类结果做UMAP，我们在UMAP中加入细胞类型标签</p>
<pre><code>## 11.4 UMAP by cell type根据细胞类型画UMAP  
UMAP_centers_cell_type &lt;- tibble(  
    UMAP_1 = as.data.frame(seurat@reductions$UMAP@cell.embeddings)$UMAP_1,  
    UMAP_2 = as.data.frame(seurat@reductions$UMAP@cell.embeddings)$UMAP_2,  
    cell_type = seurat@meta.data$cell_type_singler_blueprintencode_main  
  ) %&gt;%  
  group_by(cell_type) %&gt;%  
  summarize(x = median(UMAP_1), y = median(UMAP_2))  
  
p &lt;- bind_cols(seurat@meta.data, as.data.frame(seurat@reductions$UMAP@cell.embeddings)) %&gt;%  
  ggplot(aes(UMAP_1, UMAP_2, color = cell_type_singler_blueprintencode_main)) +  
  geom_point(size = 0.2) +  
  geom_label(  
    data = UMAP_centers_cell_type,  
    mapping = aes(x, y, label = cell_type),  
    size = 3.5,  
    fill = 'white',  
    color = 'black',  
    fontface = 'bold',  
    alpha = 0.5,  
    label.size = 0,  
    show.legend = FALSE  
  ) +  
  theme_bw() +  
  expand_limits(x = c(-22,15)) +  
  scale_color_manual(values = custom_colors$discrete) +  
  labs(color = 'Cell type') +  
  guides(colour = guide_legend(override.aes = list(size = 2))) +  
  theme(legend.position = 'right') +  
  coord_fixed() +  
  annotate(  
    geom = 'text', x = Inf, y = -Inf,  
    label = paste0('n = ', format(nrow(seurat@meta.data), big.mark = ',', trim = TRUE)),  
    vjust = -1.5, hjust = 1.25, color = 'black', size = 2.5  
  )  
  
p  
  
ggsave(  
  'plots/umap_by_cell_type_singler_blueprintencode_main.png',  
  p,  
  height = 4,  
  width = 6  
)  
</code></pre>
<p><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8lxl2xSzJ6VULEIPiaZu0htFIvPjGUKvVFF7qYVEFwOl7J8CN5qHAvuRa3MoKM11FF4dLibGHHZ5zA/640?wx_fmt=png&amp;from=appmsg" alt=""></p>
<p>为了了解UMAP中的细胞类型是否重叠(这在之前的图中很难看到)，我们并按细胞类型拆分画板绘制了UMAP图。</p>
<pre><code>temp_labels &lt;- seurat@meta.data %&gt;%  
  group_by(cell_type_singler_blueprintencode_main) %&gt;%  
  tally()  
  
p &lt;- bind_cols(seurat@meta.data, as.data.frame(seurat@reductions$UMAP@cell.embeddings)) %&gt;%  
  ggplot(aes(UMAP_1, UMAP_2, color = cell_type_singler_blueprintencode_main)) +  
  geom_point(size = 0.2, show.legend = FALSE) +  
  geom_text(  
    data = temp_labels,  
    aes(  
      x = Inf,  
      y = -Inf,  
      label = paste0('n = ', format(n, big.mark = ',', trim = TRUE)),  
      vjust = -1.5,  
      hjust = 1.25  
    ),  
    color = 'black', size = 2.8  
  ) +  
  theme_bw() +  
  scale_color_manual(values = custom_colors$discrete) +  
  labs(color = 'Cell type') +  
  guides(colour = guide_legend(override.aes = list(size = 2))) +  
  coord_fixed() +  
  facet_wrap(~cell_type_singler_blueprintencode_main, ncol = 4) +  
  theme(  
    legend.position = 'right',  
    strip.text = element_text(face = 'bold', size = 10)  
  )  
  
p  
  
ggsave(  
  'plots/umap_by_cell_type_singler_blueprintencode_main_split.png',  
  p, height = 5, width = 8  
)  
</code></pre>
<p><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8lxl2xSzJ6VULEIPiaZu0ht6mJNHRqpBIvNmtYS8aibMgibeYCMxVQYhQpaTblGFD8lSboALOdND9HQ/640?wx_fmt=png&amp;from=appmsg" alt=""></p>
<p>我们最后做一次UMAP，根据细胞注释时的分配分数</p>
<pre><code>## 11.5 UMAP by assignment score根据分配分数进行UMAP  
p &lt;- bind_cols(seurat@meta.data, as.data.frame(seurat@reductions$UMAP@cell.embeddings)) %&gt;%  
  ggplot(aes(UMAP_1, UMAP_2, color = cell_type_singler_blueprintencode_main_score)) +  
  geom_point(size = 0.2) +  
  theme_bw() +  
  scale_color_viridis(  
    name = 'Score', limits = c(0,1), oob = scales::squish,  
    guide = guide_colorbar(frame.colour = 'black', ticks.colour = 'black')  
  ) +  
  labs(color = 'Cell type') +  
  theme(legend.position = 'right') +  
  coord_fixed() +  
  annotate(  
    geom = 'text', x = Inf, y = -Inf,  
    label = paste0('n = ', format(nrow(seurat@meta.data), big.mark = ',', trim = TRUE)),  
    vjust = -1.5, hjust = 1.25, color = 'black', size = 2.5  
  )  
  
p  
  
ggsave(  
  'plots/umap_by_cell_type_singler_blueprintencode_main_score.png',  
  p,  
  height = 5,  
  width = 5.5  
)  
</code></pre>
<p><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8lxl2xSzJ6VULEIPiaZu0ht2vAxm4lAdsGGwHH98ia7aEKsAY8qu6iazOgVeubdC3E504uE8Whfcfsg/640?wx_fmt=png&amp;from=appmsg" alt=""></p>
<p>后续的进阶分析可以在seurat对象上进行，这里篇幅有限就不做赘述了，感兴趣的可可以跟着原github的workflow做一做。但是因为他是基于seurat4的workflow作者还没有更新，所以需要进行修改才能跑通。下期会更新后续的marker基因的点图、热图，以及GSVA分析等。</p>
<p>更多AI工具，参考<a href="https://aibard123.com/">Github-AiBard123</a>，<a href="https://aibard123.com/">国内AiBard123</a></p>



          </div>

可关注我们的公众号：每天AI新工具

<p><img src="/images/aitools/2024/03/qrcode_for_gh_dde1b429630d_258.jpg" alt=""></p>

        </article>

      </div>
    </div>
  </div>
</section>
        </div>
    </div>
    </main>




<script type='text/javascript' src='/assets/js/jquery.ui.touch-punch.min-0.2.2.js' id='jqueryui-touch-js'></script>
<script type='text/javascript' src='/assets/js/clipboard.min-5.6.2.js' id='clipboard-js'></script>
<script type='text/javascript' src='/assets/js/tooltip-extend.js' id='iplaycode-nav-js'></script>
<script type='text/javascript' id='popper-js-extra'>
 

var theme = {"ajaxurl":"","addico":"https:\/\/nav.baidu.cn\/wp-content\/themes\/onenav\/images\/add.png","order":"asc","formpostion":"top","defaultclass":"io-grey-mode","isCustomize":"1","icourl":"","icopng":".png","urlformat":"1","customizemax":"10","newWindow":"0","lazyload":"1","minNav":"1","loading":"1","hotWords":"baidu","classColumns":" col-sm-6 col-md-4 col-xl-5a col-xxl-6a ","apikey":"TWpBeU1UVTNOekk1TWpVMEIvZ1M2bFVIQllUMmxsV1dZelkxQTVPVzB3UW04eldGQmxhM3BNWW14bVNtWk4="};
 
</script>
<script type='text/javascript' src='/assets/js/popper.min.js' id='popper-js'></script>
<script type='text/javascript' src='/assets/js/bootstrap.min-4.3.1.js' id='bootstrap-js'></script>
<script type='text/javascript' src='/assets/js/theia-sticky-sidebar-1.5.0.js' id='sidebar-js'></script>
<script type='text/javascript' src='/assets/js/lazyload.min-12.4.0.js' id='lazyload-js'></script>
<script type='text/javascript' src='/assets/js/fancybox.min-3.5.7.js' id='lightbox-js-js'></script>

<script type='text/javascript' src='/assets/js/app-anim.js' id='appanim-js'></script>

<script type="text/javascript">
    $(document).ready(function(){
        var siteWelcome = $('#loading');
        siteWelcome.addClass('close');
        setTimeout(function() {
            siteWelcome.remove();
        }, 600);
    });
</script>
<script>        
    $(document).ready(function(){
        setTimeout(function () {
            if ($('a.smooth[href="' + window.location.hash + '"]')[0]) {
                $('a.smooth[href="' + window.location.hash + '"]').click();
            }else if (window.location.hash != '') {
                $("html, body").animate({
                    scrollTop: $(window.location.hash).offset().top - 90
                }, {
                    duration: 500,
                    easing: "swing"
                });
            }
        }, 300);
        $(document).on('click','a.smooth',function(ev) {
            if($('#sidebar').hasClass('show') && !$(this).hasClass('change-href')){
                $('#sidebar').modal('toggle');
            }
            if($(this).attr("href").substr(0, 1) == "#"){
                $("html, body").animate({
                    scrollTop: $($(this).attr("href")).offset().top - 90
                }, {
                    duration: 500,
                    easing: "swing"
                });
            }
            if($(this).hasClass('go-search-btn')){
                $('#search-text').focus();
            }
            if(!$(this).hasClass('change-href')){
                var menu =  $("a"+$(this).attr("href"));
                menu.click();
                toTarget(menu.parent().parent(),true,true);
            }
        });
        $(document).on('click','a.tab-noajax',function(ev) {
            var url = $(this).data('link');
            if(url)
                $(this).parents('.d-flex.flex-fill.flex-tab').children('.btn-move.tab-move').show().attr('href', url);
            else
                $(this).parents('.d-flex.flex-fill.flex-tab').children('.btn-move.tab-move').hide();
        });
        
    });
</script>

<script>

(function(){
    if(document.cookie.replace(/(?:(?:^|.*;\s*)night\s*\=\s*([^;]*).*$)|^.*$/, "$1") === ''){
        if(new Date().getHours() > 22 || new Date().getHours() < 6){
            document.body.classList.remove('io-black-mode');
            document.body.classList.add('io-grey-mode');
            document.cookie = "night=1;path=/";
            console.log('夜间模式开启');
        }else{
            document.body.classList.remove('night');
            document.cookie = "night=0;path=/";
            console.log('夜间模式关闭');
        }
    }else{
        var night = document.cookie.replace(/(?:(?:^|.*;\s*)night\s*\=\s*([^;]*).*$)|^.*$/, "$1") || '0';
        if(night == '0'){
            document.body.classList.remove('night');
        }else if(night == '1'){
            document.body.classList.add('night');
        }
    }
})();

$("#search-bg").css("background", "linear-gradient(#e2c4c4, #d8d8d8)");   
function switchNightMode(){
    var night = document.cookie.replace(/(?:(?:^|.*;\s*)night\s*\=\s*([^;]*).*$)|^.*$/, "$1") || '0';
    if(night == '0'){
	$("#search-bg").css("background", "linear-gradient(#e2c4c4, #d8d8d8)");
        document.body.classList.remove('io-grey-mode');
        document.body.classList.add('io-black-mode');
        document.cookie = "night=1;path=/"
        console.log(' ');
        $(".switch-dark-mode").attr("data-original-title","日间模式");
        $(".mode-ico").removeClass("icon-night");
        $(".mode-ico").addClass("icon-light");
    }else{
	$("#search-bg").css("background", "linear-gradient(#4f4040, #1b1d1f)");
        document.body.classList.remove('io-black-mode');
        document.body.classList.add('io-grey-mode');
        document.cookie = "night=0;path=/"
        console.log(' ');
        $(".switch-dark-mode").attr("data-original-title","夜间模式");
        $(".mode-ico").removeClass("icon-light");
        $(".mode-ico").addClass("icon-night");
    }
}
</script>


<script>
    var newsContainer = document.getElementById('news-container');
    var newsItems = document.getElementsByClassName('news-item');
    var currentItem = 0;

    setInterval(function() {
        
        newsItems[currentItem].classList.remove('show');
        newsItems[currentItem].style.transform = 'translateY(-20px)';
        
        currentItem = (currentItem + 1) % newsItems.length;
        newsItems[currentItem].style.transform = 'translateY(' + (newsContainer.offsetHeight - 20) + 'px)';
        setTimeout(function() {
            newsItems[currentItem].classList.add('show');
        }, 500);
    }, 8000);
</script>

</body>
</html>


