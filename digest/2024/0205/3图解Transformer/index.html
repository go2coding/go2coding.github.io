

<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1" />
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta name="theme-color" content="#f9f9f9" />

	<title>3图解Transformer 作者： 人工智能大讲堂 来源： 人工智能大讲堂 大语言模型之所以能理解人类语言，生成高质量文本，离不开模型的帮助，本文将图解Transformer：一种基于注意力机制的神经网络架构。能捕获长距离依赖关系以及并行计算，Transformer已经成为当  | AiBard123| ai工具网址导航,ai最新产品</title>
	<link rel="shortcut icon" href="/assets/images/favicon.png" />
    <meta name="keywords" content="chatgpt,AI,AI聊天,AI文本生成,AI绘画,AI编程,AI电商" />
    <meta name="description" content="AiBard123 网址导航 | 免费chatgpt 汇集各类先进的人工智能产品，旨在帮助用户更快速地了解和使用这些产品,轻松地浏览不同领域的AI产品，包括语音识别、图像处理、自然语言处理。" />
    
    <meta name="baidu-site-verification" content="codeva-cCAOSG8MBO" />
    
    <link rel="stylesheet" id="block-library-css"
        href="/assets/css/block-library.min-5.6.2.css" type="text/css" media="all" />
    <link rel="stylesheet" id="iconfont-css" href="/assets/css/iconfont-3.03029.1.css"
        type="text/css" media="all" />

    
    <link href="/scss/style.min.css" rel="stylesheet" />
    
		    <link rel="stylesheet" id="iowen-css" href="/assets/css/style-3.03029.1.css"
        type="text/css" media="all" />
    <link rel="stylesheet" id="custom-css" href="/assets/css/custom-style.css"
        type="text/css" media="all" />
		
		<link rel="stylesheet" href=/plugins/font-awesome/css/font-awesome.min.css />


    <link rel="stylesheet" id="fortawesome-css" href="/assets/fontawesome-5.15.4/css/all.min.css" type="text/css" />


    <script type="text/javascript" src="/assets/js/jquery.min-3.2.1.js" id="jquery-js"></script>
    <script type="text/javascript" src="/assets/js/content-search.js"  id="content-search-js"></script>

    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2073588164294660"
     crossorigin="anonymous"></script>

	
    <script>
        

		var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?8450bc732b2a86f7e4aec4ebd9fd8252";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();

        
    </script>
    

    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-7071W80M2K"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-7071W80M2K');
    </script>

</head>


    <div class="page-container">
	
	<div id="sidebar" class="sticky sidebar-nav fade animate-nav" style="width: 170px">
        
            <div class="modal-dialog h-100 sidebar-nav-inner">
                <div class="sidebar-logo border-bottom border-color">
                    
                    <div class="logo overflow-hidden">
                        <a href="https://aibard123.com/" class="logo-expanded">
                            <img src="/assets/images/bt8-expand-light.png" height="40" class="logo-light"
                                alt="AiBard123| ai工具网址导航,ai最新产品">
                            <img src="/assets/images/bt8-expand-dark.png" height="40" class="logo-dark d-none"
                                alt="AiBard123| ai工具网址导航,ai最新产品">
                        </a>
                        <a href="https://aibard123.com/" class="logo-collapsed">
                            <img src="/assets/images/bt.png" height="40" class="logo-light"
                                alt="AiBard123| ai工具网址导航,ai最新产品">
                            <img src="/assets/images/bt.png" height="40" class="logo-dark d-none"
                                alt="AiBard123| ai工具网址导航,ai最新产品">
                        </a>
                    </div>
                    
                </div>
                <div class="sidebar-menu flex-fill">
                    <div class="sidebar-scroll">
                        <div class="sidebar-menu-inner">
                            <ul>
                                
                                    
                                    <li class="sidebar-item">
                                        <a href="/#00834a9dd147b04c5d53d4368cdb0b57" class="smooth">
                                            <i class="fas fa-sun fa-lg fa-lg icon-fw icon-lg mr-2"></i>
                                            <span>本月热门</span>
                                        </a>
                                    </li>
                                    
                                
                                    
                                    <li class="sidebar-item">
                                        <a href="/#db0311e7ecfedd24d157f0ceb4a0897f" class="smooth">
                                            <i class="fas fa-star-and-crescent fa-lg fa-lg icon-fw icon-lg mr-2"></i>
                                            <span>热门网站</span>
                                        </a>
                                    </li>
                                    
                                
                                    
                                    <li class="sidebar-item">
                                        <a href="/#21b5cbb2c769010fec3ce029a5f8a4a3" class="smooth">
                                            <i class="far fa-star fa-lg icon-fw icon-lg mr-2"></i>
                                            <span>国内热门</span>
                                        </a>
                                    </li>
                                    
                                
                                    
                                    <li class="sidebar-item">
                                        <a href="/#8310718935e8ec25ce0350de01e3f7dc" class="smooth">
                                            <i class="fas fa-phone fa-lg fa-lg icon-fw icon-lg mr-2"></i>
                                            <span>对话工具</span>
                                        </a>
                                    </li>
                                    
                                
                                    
                                    <li class="sidebar-item">
                                        <a href="/#d58e850d9115797306c2edf61ac6ddd8" class="smooth">
                                            <i class="fas fa-newspaper fa-lg fa-lg icon-fw icon-lg mr-2"></i>
                                            <span>写作</span>
                                        </a>
                                    </li>
                                    
                                
                                    
                                    <li class="sidebar-item">
                                        <a href="/#2a7418a5f8f1ca4e054364a9300657df" class="smooth">
                                            <i class="fas fa-image fa-lg fa-lg icon-fw icon-lg mr-2"></i>
                                            <span>图像生成</span>
                                        </a>
                                    </li>
                                    
                                
                                    
                                    <li class="sidebar-item">
                                        <a href="/#7808a68ee1b34dab43011429a12de19e" class="smooth">
                                            <i class="fas fa-image fa-lg fa-lg icon-fw icon-lg mr-2"></i>
                                            <span>图像处理</span>
                                        </a>
                                    </li>
                                    
                                
                                    
                                    <li class="sidebar-item">
                                        <a href="/#6729afc51f5ac49a828812fa0eb0c82f" class="smooth">
                                            <i class="fas fa-video fa-lg fa-lg icon-fw icon-lg mr-2"></i>
                                            <span>音视频</span>
                                        </a>
                                    </li>
                                    
                                
                                    
                                    <li class="sidebar-item">
                                        <a href="/#e5ce844860451fff3faf3d8f8894971d" class="smooth">
                                            <i class="fas fa-music fa-lg fa-lg icon-fw icon-lg mr-2"></i>
                                            <span>音乐生成</span>
                                        </a>
                                    </li>
                                    
                                
                                    
                                    <li class="sidebar-item">
                                        <a href="/#db53804b7d726967c58fcc8c9ca03d27" class="smooth">
                                            <i class="fas fa-language fa-lg fa-lg icon-fw icon-lg mr-2"></i>
                                            <span>办公</span>
                                        </a>
                                    </li>
                                    
                                
                                    
                                    <li class="sidebar-item">
                                        <a href="/#47b7af9547e034d28fe6f6d439968ac8" class="smooth">
                                            <i class="fas fa-copy fa-lg fa-lg icon-fw icon-lg mr-2"></i>
                                            <span>提示词</span>
                                        </a>
                                    </li>
                                    
                                
                                    
                                    <li class="sidebar-item">
                                        <a href="/#41282bf95e43c64d579757573a03cdde" class="smooth">
                                            <i class="fas fa-code fa-lg fa-lg icon-fw icon-lg mr-2"></i>
                                            <span>编程</span>
                                        </a>
                                    </li>
                                    
                                
                                    
                                    <li class="sidebar-item">
                                        <a href="/#fd71852fd52d5e18ef4f9a252f1eac58" class="smooth">
                                            <i class="fas fa-search fa-lg fa-lg icon-fw icon-lg mr-2"></i>
                                            <span>AI搜索</span>
                                        </a>
                                    </li>
                                    
                                
                                    
                                    <li class="sidebar-item">
                                        <a href="/#81b1637fbe47625dbdf2094acd3b6683" class="smooth">
                                            <i class="fas fa-language fa-lg fa-lg icon-fw icon-lg mr-2"></i>
                                            <span>文本翻译</span>
                                        </a>
                                    </li>
                                    
                                
                                    
                                    <li class="sidebar-item">
                                        <a href="/#2e9ba3fa6e1ed0e9311b3e97f97f9a40" class="smooth">
                                            <i class="fas fa-book fa-lg fa-lg icon-fw icon-lg mr-2"></i>
                                            <span>学习网站</span>
                                        </a>
                                    </li>
                                    
                                
                            </ul>           
                        </div>
                    </div>
                </div>
                <div class="border-top py-2 border-color">
                    <div class="flex-bottom">
                        <ul>
			    <li id="menu-item-212"
                                 class="menu-item menu-item-type-custom menu-item-object-custom menu-item-212 sidebar-item">
                                 <a href="#friendlink" class="smooth">
                                     <i class="fab fa-staylinked icon-fw icon-lg mr-2"></i>
                                     <span>友情链接</span>
                                 </a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>


<div class="flex-fill grid-bg">
    <div class="big-header-banner">
        <div id="header" class="page-header sticky">
            <div class="navbar navbar-expand-md">
                <div class="container-fluid p-0">

                    <a href="" class="navbar-brand d-md-none" title="AiBard123| ai工具网址导航,ai最新产品">
                        <img src="/assets/images/bt.png" class="logo-light"
                            alt="AiBard123| ai工具网址导航,ai最新产品">
                        <img src="/assets/images/bt.png" class="logo-dark d-none"
                            alt="AiBard123| ai工具网址导航,ai最新产品">
                    </a>

                    <div class="collapse navbar-collapse order-2 order-md-1">
                        <div class="header-mini-btn">
                            <label>
                                <input id="mini-button" type="checkbox">
                                <svg viewbox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                                    <path class="line--1" d="M0 40h62c18 0 18-20-17 5L31 55"></path>
                                    <path class="line--2" d="M0 50h80"></path>
                                    <path class="line--3" d="M0 60h62c18 0 18 20-17-5L31 45"></path>
                                </svg>
                            </label>

                        </div>

                        <ul class="navbar-nav site-menu" style="margin-right: 16px;">
                        
			<li >
				<a href="/">
                                    <i class="fa fa-home fa-lg mr-2"></i>
                                    <span>首页</span>
                                </a>
				<ul class="sub-menu">
				
				</ul>
			    </li>
			
			</ul>

                        
                        <div class="rounded-circle weather">
                            <div id="he-plugin-simple" style="display: contents;"></div>
                            <script>WIDGET = {
                                    CONFIG: {
                                        "modules": "01234",
                                        "background": 5,
                                        "tmpColor": "008000",
                                        "tmpSize": 14,
                                        "cityColor": "008000",
                                        "citySize": 14,
                                        "aqiColor": "#008000",
                                        "aqiSize": 14,
                                        "weatherIconSize": 24,
                                        "alertIconSize": 18,
                                        "padding": "10px 10px 10px 10px",
                                        "shadow": "1",
                                        "language": "auto",
                                        "borderRadius": 5,
                                        "fixed": "false",
                                        "vertical": "middle",
                                        "horizontal": "left",
                                        "key": "085791e805a24491b43b06cf58ab31e7"
                                    }
                                }
                            </script>
                            <script src="https://widget.qweather.net/simple/static/js/he-simple-common.js?v=2.0"></script>
                        </div>
                        
                    </div>

                    <ul class="nav navbar-menu text-xs order-1 order-md-2">
                        
                        
                        <li class="nav-item mr-3 mr-lg-0 d-none d-lg-block">
                            <script>
                                fetch('https://v1.hitokoto.cn')
                                    .then(response => response.json())
                                    .then(data => {
                                    const hitokoto = document.getElementById('hitokoto_text')
                                    hitokoto.href = 'https://hitokoto.cn/?uuid=' + data.uuid
                                    hitokoto.innerText = data.hitokoto
                                    })
                                    .catch(console.error)
                            </script>                           
                            <div id="hitokoto"><a href="#" target="_blank" id="hitokoto_text">疏影横斜水清浅，暗香浮动月黄昏。</a></div>
                        </li>
                        
                        
                        <li class="nav-search ml-3 ml-md-4">
                            <a href="javascript:" data-toggle="modal" data-target="#search-modal"><i
                                    class="iconfont icon-search icon-2x"></i></a>
                        </li>
                        <li class="nav-item d-md-none mobile-menu ml-3 ml-md-4">
                            <a href="javascript:" id="sidebar-switch" data-toggle="modal"
                                data-target="#sidebar"><i class="iconfont icon-classification icon-2x"></i></a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
        <div class="placeholder" style="height:74px"></div>
    </div>




<body class="page-body boxed-container  io-grey-mode">
    <main role="main" class="flex-shrink-0">
    <div class="container">
        
        <div class="content">
            <style>
    body{
	    background: #f9f9f9;
	}

    h1, h2, h3, h4, h5, h6 {
        margin-top: 1.5rem;
        margin-bottom: 1.5rem;
    }


 
@media (min-width: 1000px) {
  .container, .container-sm {
    max-width: 800px;
  }
}

</style>

<div class="featured-post-content">

    <a href="/digest/" class="featured-post-title">
       AI 文摘
    </a>

</div>

<section class="blog-single">
  <div class="container">
    <div class="row">

      <div class="col-lg-12 order-1 order-lg-2">
        <article class="single-blog">
          <p class="title">3图解Transformer</p>
            <br/>
          <ul class="meta">
            <li>
              By <a href=https://aibard123.com/about>AiBard123</a>
            </li>
            <li>
              <i class="fa fa-clock-o"></i>
              February 5, 2024 - 2 min read
            </li>
          </ul>

          <div class="_1NCGf">
              <img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/sz_mmbiz_png/gWS53OdTR9SQgRzua7JiasvAE8BT5Ig9icqvUd3agJrVjlIqZa7pA4TlHgLbdceQKznoKxsnUzWn9507jenaKbnw/640?wx_fmt=png&amp;from=appmsg" width="640" >
          </div>
            <br>
            <br>
            <br>
          
          <div class="single-blog-content">
            <p>作者： 人工智能大讲堂  来源： <a href="https://mp.weixin.qq.com/s/yqZXHMsh4VReX12XfuaF_Q">人工智能大讲堂</a></p>
<p><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/mmbiz_png/bL2iaicTYdZn7icw7LibtnTP0eLcdtIdic5fjuKfQPEVYqvxnu41XMSOA08e7W5L8EWg7Waa2g3Eric7YYxGcYrLeGeg/640?wx_fmt=png&amp;from=appmsg&amp;wxfrom=13&amp;tp=wxpic" alt=""></p>
<p>大语言模型之所以能理解人类语言，生成高质量文本，离不开模型的帮助，本文将图解Transformer：一种基于注意力机制的神经网络架构。能捕获长距离依赖关系以及并行计算，Transformer已经成为当下NLP任务以及大语言模型的首选架构。</p>
<p>本系列还有图解Tokenization，Word2Vec，GPT2，Bert。</p>
<p>这篇文章主要来自下面这篇博客，也会附加我自己的理解。</p>
<p><a href="https://jalammar.github.io/illustrated-transformer/">https://jalammar.github.io/illustrated-transformer/</a></p>
<p><strong>正文</strong></p>
<p>在之前的文章中，我们讲了现代神经网络常用的一种方法——Attention机制。</p>
<p><a href="https://jalammar.github.io/visualizing-neural-machine-translation-mechanics-of-seq2seq-models-with-attention/">https://jalammar.github.io/visualizing-neural-machine-translation-mechanics-of-seq2seq-models-with-attention/</a></p>
<p>注意力机制能够学习输入序列的不同部分的相关性，从而使模型能够更好地理解和处理输入信息。</p>
<p>今天就让我们把它拆解开看一下它是如何运行的。</p>
<hr>
<pre><code>Transformer是在这篇论文中提出的：
https://arxiv.org/abs/1706.03762
  

官方版TensorFlow实现：
https://github.com/tensorflow/tensor2tensor
  

哈佛大学NLP组Pytorch实现：
http://nlp.seas.harvard.edu/2018/04/03/attention.html
</code></pre>
<p>在本文中，我们会逐个概念进行介绍，希望能帮助没接触过Transformer的人能够更容易的理解。</p>
<p><strong>从整体看</strong></p>
<p>我们先把整个Transformer模型看作是一个黑盒。在机器翻译中，它可以把句子从一种语言翻译成另一种语言。</p>
<p><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/sz_mmbiz_png/gWS53OdTR9SQgRzua7JiasvAE8BT5Ig9iclwr95mLh4kETg9tsib7QKCxEK5aNCKtUEokicbGgpicsdTVVQV1mUaC7g/640?wx_fmt=png&amp;from=appmsg" alt=""></p>
<p>打开这个黑盒，我们首先可以看到一个编码器（encoder）模块和一个解码器（decoder）模块，以及二者之间存在某种关联。</p>
<p><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/sz_mmbiz_png/gWS53OdTR9SQgRzua7JiasvAE8BT5Ig9icNqDJN3P5OuIuNIP6mRA1CoH1ibQicoBWqhVY5ABiaia6NaAJmNKIb297zg/640?wx_fmt=png&amp;from=appmsg" alt=""></p>
<p>再往近看一下，编码器模块是6个encoder组件堆在一起，同样解码器模块也是6个decoder组件堆在一起。（为什么选6个呢？没有什么原因，论文原文就是这么写的，你也可以换成别的层数）</p>
<p><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/sz_mmbiz_png/gWS53OdTR9SQgRzua7JiasvAE8BT5Ig9icqYylfzc0llkXicAufBmNZp2f8S1CjYrgZPiaZr0sjvnvjWS4mjdcsRIw/640?wx_fmt=png&amp;from=appmsg" alt=""></p>
<p>6个编码器组件的结构是相同的（但是他们之间的权重是不共享的），每个编码器都可以分为2个子层。</p>
<p><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/sz_mmbiz_png/gWS53OdTR9SQgRzua7JiasvAE8BT5Ig9ic3YY4UtTUDYHW1CDqRMNFCJ2q8xdZSt9dkYuu0sHNtH4uvavGs3fafw/640?wx_fmt=png&amp;from=appmsg" alt=""></p>
<p>编码器的输入首先会进入一个自注意力层，这个注意力层的作用是：当要编码某个特定的词汇的时候，它会关注句子中的其他词汇。之后会进行详细讲解。</p>
<p>自注意力层的输出会传递给一个前馈神经网络，进行非线性变换，增加模型的表达能力和学习能力。</p>
<p>解码器组件也含有前面编码器中提到的两个层，区别在于这两个层之间还夹了一个注意力层，多出来的这个自注意力层的作用是让解码器能够注意到输入句子中相关的部分（和seq2seq中的attention一样的作用）。</p>
<p><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/sz_mmbiz_png/gWS53OdTR9SQgRzua7JiasvAE8BT5Ig9icnDaaia5UrHiaW9qiasVvxMm9OYkRRHxFAwxhJDLrgicSONqDTibN1gzDQCw/640?wx_fmt=png&amp;from=appmsg" alt=""></p>
<p>注意，对于一些只有解码器的模型，例如GPT，就没有Encoder-Decoder Attention。</p>
<p><strong>图解张量</strong></p>
<p>现在我们已经了解了模型的主要结构。接下来我们要看张量或者向量是如何在这些组件之间流动的，也就是在一个已经训练好的Transformer模型中，输入是怎么变为输出的呢？</p>
<p>与其它NLP任务一样，我们首先需要把输入文本转换成Token，然后将每个Token通过词嵌入（embedding）转化为对应的向量。</p>
<p>注意，将token转换成词嵌入向量是通过一个词嵌入矩阵完成的，通常也包括一个位置矩阵，对于一些大模型，例如ChatGPT，Bert等，它们通常会提供预训练好的词嵌入矩阵和位置矩阵，以及相应的tokenization方法和字典，这样能保证训练和推理时使用相同的tokenization方法和字典，这样才能保证输入和输出的一致性。</p>
<p><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/sz_mmbiz_png/gWS53OdTR9Q3ia6rT1LjkL0ibicViaic903ibiapWiaGAd2pPmmVefxdE7xzibfYoTpRTSjQXgfKA4s59QOIuFSW8w2ofeA/640?wx_fmt=png&amp;from=appmsg" alt=""></p>
<p>在原文中每个词的嵌入向量是512维，这里为了便于理解，就用这几个格子进行表示。</p>
<p>最底下的那个编码器接收的是嵌入向量，之后的编码器接收的是前一个编码器的输出。</p>
<p>注意，使用不同的词嵌入方法，词嵌入向量的维度也是不一样的。</p>
<hr>
<pre><code>Word2Vec 中 Skip-Gram 和 CBOW 模型词向量的默认维度是100或300维。
GloVe 词向量常见的维度有50维、100维、200维和300维。
BERT 中词向量的维度等于其transformer block的隐层大小,通常是768或1024。
ELMo 使用双层LSTM结构学习词向量,每个LSTM输出向量的维度不同,最终拼接为1024维。
</code></pre>
<p>输入词的个数也是个超参数，一般来说是训练集中最长的那个句子的长度。</p>
<hr>
<pre><code>GPT1：512个单词
GPT2：1024个单词
GPT3：2048个单词
ChatGPT：4096个单词
</code></pre>
<p>当我们的输入序列经过词嵌入之后得到的向量会依次通过编码器组件中的两个层。</p>
<p><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/sz_mmbiz_png/gWS53OdTR9SQgRzua7JiasvAE8BT5Ig9iczqPpUrODx9SnSW9wH9Bc3qLFhQzehJ8FMXLaJ9EQf8kOHSrfLbRV9Q/640?wx_fmt=png&amp;from=appmsg" alt=""></p>
<p>在这里，我们开始看到Transformer的一个关键属性，即每个位置上的单词在编码器中有各自的流通方向。在自注意力层中，这些路径之间存在依赖关系。前馈神经网络中没有这些依赖关系，然而，所有路径在前向计算过程中都是并行的。</p>
<p>接下来，我们用一个短句（Thinking Machine）作为例子，看看在编码器的每个子层中发生了什么。</p>
<p><strong>现在我们来看一下编码器</strong></p>
<p>上边我们已经说了，每个编码器组件接受一组向量作为输入。在其内部，输入向量先通过一个自注意力层，再经过一个前馈神经网络，最后将其将输出给下一个编码器组件。</p>
<p><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/sz_mmbiz_png/gWS53OdTR9SQgRzua7JiasvAE8BT5Ig9ic8jt8xb7fujk9FQvE5ADcKDECaT1If47vPobDMatT7Draibap22nGeeg/640?wx_fmt=png&amp;from=appmsg" alt=""></p>
<p><strong>不同位置上的单词都要经过自注意力层的处理，之后都会经过一个完全相同的前馈神经网络。</strong></p>
<p><strong>自注意力</strong></p>
<p>不要一看“self-attention”就觉得这是个每个人都很很熟悉的词，其实我个人感觉，在看《Attention is all you need》之前我都没有真正理解自注意力机制。现在让我们看一下自注意力机制。</p>
<p>假设我们要翻译下边这句话：</p>
<p>”The animal didn&rsquo;t cross the street because it was too tired”</p>
<p>这里it指的是什么？是street还是animal？人理解起来很容易，但是对算法来讲就不那么容易了。</p>
<p>当模型处理it这个词的时候，自注意力会让it和animal关联起来。</p>
<p>当模型编码每个位置上的单词的时候，自注意力的作用就是：看一看输入句子中其他位置的单词，试图寻找一种对当前单词更好的编码方式。</p>
<p>如果你熟悉RNNs模型，回想一下RNN如何处理当前时间步的隐藏状态：将之前的隐藏状态与当前位置的输入结合起来。</p>
<p>在Transformer中，自注意力机制也可以将其他相关单词的“理解”融入到我们当前处理的单词中。</p>
<p><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/sz_mmbiz_png/gWS53OdTR9SQgRzua7JiasvAE8BT5Ig9ic7Cib3ucXslIrkXE5cbeRG5MRIVmqEI3bpv6NenhPkUaWuen9icCd5m2g/640?wx_fmt=png&amp;from=appmsg" alt=""></p>
<p><strong>当我们在最后一个encoder组建中对it进行编码的时候，注意力机制会更关注The animal，并将其融入到it的编码中。</strong></p>
<p><strong>细说自注意力机制</strong></p>
<p>先画图用向量解释一下自注意力是怎么算的，之后再看一下实际实现中是怎么用矩阵算的。</p>
<p><strong>第一步</strong>  对编码器的每个输入向量都计算三个向量，就是对每个输入向量都算一个query、key、value向量。</p>
<p>如何计算这三个向量？</p>
<p>把输入的词嵌入向量与三个权重矩阵相乘。权重矩阵是模型训练阶段训练出来的。</p>
<p>注意，这三个向量维度是64，比嵌入向量的维度小，嵌入向量、编码器的输入输出维度都是512。这三个向量不是必须比编码器输入输出的维数小，这样做主要是为了让多头注意力的计算更稳定。</p>
<p>一般这三个向量的维度=输入特征维度/头的个数。如果有8个注意力头，那么q,k,v的维度就是512/8=64.</p>
<p><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/sz_mmbiz_png/gWS53OdTR9SQgRzua7JiasvAE8BT5Ig9iccsTU8MRFhyqCzQuhPhq4DM31ltUlwbkjVTy5GH98rzs0jNEAGWKAoQ/640?wx_fmt=png&amp;from=appmsg" alt=""></p>
<p><strong>将x1和WQ权重矩阵相乘得到q1, 就得到与该单词x1相关的查询（query）。按这样的方法，最终我们给输入的每一个单词都计算出一个“query”、一个 “key&quot;和一个 “value&quot;。</strong></p>
<p>什么是 “query”、“key”、“value” 向量？</p>
<p>这三个向量是计算注意力时的抽象概念，继续往下看注意力计算过程，看完了就懂了。</p>
<p><strong>第二步</strong>  计算注意力得分。</p>
<p>假设我们现在在计算输入中第一个单词Thinking的自注意力。我们需要使用自注意力给输入句子中的每个单词打分，这个分数决定当我们编码某个位置的单词的时候，应该对其他位置上的单词给予多少关注度。</p>
<p>这个得分是query和key的点乘积得出来的。</p>
<p>举个栗子，我们要算第一个位置的注意力得分的时候就要将第一个单词的query和其他的key依次相乘，在这里就是q1和k1相乘，第二个分数就是q1和k2相乘。</p>
<p><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/sz_mmbiz_png/gWS53OdTR9SQgRzua7JiasvAE8BT5Ig9ickkvkmxdUXy2a8yoyFbNJEbnJAqibTRjzibAaSS9HDFd2fCdgicazsPQZA/640?wx_fmt=png&amp;from=appmsg" alt=""></p>
<p><strong>第三步</strong> 将计算获得的注意力分数除以8。</p>
<p>为什么选8？是因为key向量的维度是64，取其平方根，这样让梯度计算的时候更稳定。默认是这么设置的，当然也可以用其他值。</p>
<p><strong>第四步</strong>  除8之后将结果扔进softmax计算，使结果归一化，softmax之后注意力分数相加等于1，并且都是正数。</p>
<p><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/sz_mmbiz_png/gWS53OdTR9SQgRzua7JiasvAE8BT5Ig9ic3eoIFacBQTtjsMuVnYydk2h35UfLYxVFiaoTh8Cw1qictnUSUFXv3M0A/640?wx_fmt=png&amp;from=appmsg" alt=""></p>
<p>这个softmax之后的注意力分数表示 在计算当前位置的时候，其他单词受到的关注度的大小。显然在当前位置的单词肯定有一个高分，但是有时候也会注意到与当前单词相关的其他词汇。</p>
<p><strong>第五步</strong>  将每个value向量乘以注意力分数。</p>
<p>这是为了留下我们想要关注的单词的value，并把其他不相关的单词丢掉。</p>
<p><strong>第六步</strong>  将上一步的结果相加，输出本位置的注意力结果。</p>
<p><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/sz_mmbiz_png/gWS53OdTR9SQgRzua7JiasvAE8BT5Ig9icaH8YILXdRND1g6nmicjOTDyb3LX4ia4qatuIjh7hDZ4icxqFoWTBJ57MQ/640?wx_fmt=png&amp;from=appmsg" alt=""></p>
<p>这就是自注意力的计算。计算得到的向量直接传递给前馈神经网络。但是为了处理的更迅速，实际是用矩阵进行计算的。接下来我们看一下怎么用矩阵计算。</p>
<p><strong>用矩阵计算self-attention</strong></p>
<p>计算Query, Key, Value矩阵。直接把输入的向量打包成一个矩阵X，再把它乘以训练好的WQ 、WK、WV。</p>
<p><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/sz_mmbiz_png/gWS53OdTR9SQgRzua7JiasvAE8BT5Ig9ic9lLPQtVbq2dSZ09sHDMSp4CT5EkzurVlOvM0BnqD6iao0KSjq2HBcRA/640?wx_fmt=png&amp;from=appmsg" alt=""></p>
<p><strong>X矩阵中的一行相当于输入句子中的一个单词。我们看一下维度的差异：原文中嵌入矩阵的长度为 512 , q、k、v 矩阵的长度为 64 ；在这里我们分别用 4 个格子表示和3个格子表示。</strong></p>
<p>最终，我们就可以利用矩阵将之前的第二步到第六步压缩到一个公式中一步到位获得最终的注意力结果Z。</p>
<p><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/sz_mmbiz_png/gWS53OdTR9SQgRzua7JiasvAE8BT5Ig9icNQzn61PibTHcibXB0ZiaibNzv2CXNYAGFwBsz3bgLz9YtOm4N8YkLsA7oQ/640?wx_fmt=png&amp;from=appmsg" alt=""></p>
<p><strong>多头注意力</strong></p>
<p>论文进一步改进了自注意力层，增加了一个机制，也就是多头注意力机制。这样做有两个好处：</p>
<p>1.它扩展了模型专注于不同位置的能力。</p>
<p>在上面例子里只计算一个自注意力的的例子中，编码“Thinking”的时候，虽然最后Z1或多或少包含了其他位置单词的信息，但是它实际编码中还是被“Thinking”单词本身所支配。</p>
<p>如果我们翻译一个句子，比如“The animal didn’t cross the street because it was too tired”，我们会想知道“it”指的是哪个词，这时模型的“多头”注意力机制会起到作用。</p>
<p>2.它给了注意层多个“表示子空间”。</p>
<p>就是在多头注意力中同时用多个不同的WQ、WK、WV权重矩阵(Transformer使用8个头部，因此我们最终会得到8个计算结果)，每个权重都是随机初始化的。经过训练每个WQ、WK、WV都能将输入的矩阵投影到不同的表示子空间。</p>
<p><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/sz_mmbiz_png/gWS53OdTR9SQgRzua7JiasvAE8BT5Ig9ic6J86lSr5B8AlUFbujjBWaRK9yJq5TbYyTsxchUibzThZ2iaZUnlDbBiaA/640?wx_fmt=png&amp;from=appmsg" alt=""></p>
<p><strong>在多头注意力中, 我们给每个头单独的权重矩阵, 从而产生不同的Q、 K 、V 矩阵。</strong></p>
<p>Transformer中的一个多头注意力（有8个head）的计算，就相当于用自注意力做8次不同的计算，并得到8个不同的结果Z。</p>
<p><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/sz_mmbiz_png/gWS53OdTR9SQgRzua7JiasvAE8BT5Ig9icSIze8XQoN6ySLVR6yVHDOnnY8t7KJichn1LPDm37cZyEzoEzR9ic2BIw/640?wx_fmt=png&amp;from=appmsg" alt=""></p>
<p>但是这会存在一点问题，多头注意力出来的结果会进入一个前馈神经网络，这个前馈神经网络可不能一下接收8个注意力矩阵，它的输入需要是单个矩阵（矩阵中每个行向量对应一个单词），所以我们需要一种方法把这8个压缩成一个矩阵。</p>
<p>怎么做呢？我们将这些矩阵连接起来，然后将乘以一个附加的权重矩阵W O 。</p>
<p><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/sz_mmbiz_png/gWS53OdTR9SQgRzua7JiasvAE8BT5Ig9icqvUd3agJrVjlIqZa7pA4TlHgLbdceQKznoKxsnUzWn9507jenaKbnw/640?wx_fmt=png&amp;from=appmsg" alt=""></p>
<p>以上就是多头自注意力的全部内容。让我们把多头注意力上述内容 放到一张图里看一下子：</p>
<p><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/sz_mmbiz_png/gWS53OdTR9SQgRzua7JiasvAE8BT5Ig9icNSX0JXs3FUwbZ6fvTRRIYZqjGJpAfMhia6j8XEric411jdpVVJUH2TKA/640?wx_fmt=png&amp;from=appmsg" alt=""></p>
<p>现在我们已经看过什么是多头注意力了，让我们回顾一下之前的一个例子，再看一下编码“it”的时候每个头的关注点都在哪里：</p>
<p><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/sz_mmbiz_png/gWS53OdTR9SQgRzua7JiasvAE8BT5Ig9iceDLbZz7Tg7xr2J9CQdMJC1iaoNfl6qyVULMxeENRhbBoJ7jhNRhNl9A/640?wx_fmt=png&amp;from=appmsg" alt=""></p>
<p><strong>编码it，用两个head的时候：其中一个更关注the animal，另一个更关注tired。<strong><strong>此时该模型对it的编码。除了it本身的表达之外，同时也包含了the animal和tired的相关信息</strong></strong></strong></p>
<p>如果我们把所有的头的注意力都可视化一下，就是下图这样，但是看起来事情好像突然又复杂了。</p>
<p><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/sz_mmbiz_png/gWS53OdTR9SQgRzua7JiasvAE8BT5Ig9icz7lXXxnkMicE6KLzHdjJYwiaTh8b6jgRZaGWoOuh8shKSMyOic9Blo7bQ/640?wx_fmt=png&amp;from=appmsg" alt=""></p>
<p><strong>使用位置编码表示序列的位置</strong></p>
<p>到现在我们还没提到过如何表示输入序列中词汇的位置。</p>
<p>Transformer在每个输入的嵌入向量中添加了位置向量。这些位置向量遵循某些特定的模式，这有助于模型确定每个单词的位置或不同单词之间的距离。将这些值添加到嵌入矩阵中，一旦它们被投射到Q、K、V中，就可以在计算点积注意力时提供有意义的距离信息。</p>
<p><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/sz_mmbiz_png/gWS53OdTR9SQgRzua7JiasvAE8BT5Ig9icENjVpYDd6KgYphWLfDO3l312fDXyGteZeibSESHpSq8Gvr5xZ8auBXg/640?wx_fmt=png&amp;from=appmsg" alt=""></p>
<p><strong>为了让模型能知道单词的顺序，我们添加了位置编码，位置编码是遵循某些特定模式的。</strong></p>
<p>位置编码向量和嵌入向量的维度是一样的，比如下边都是四个格子：</p>
<p><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/sz_mmbiz_png/gWS53OdTR9SQgRzua7JiasvAE8BT5Ig9icO8ymBex2iazXTvIDTc2CFEHvqHiasKhR1rvTfNoOibib7fuF1rGvFBb6icQ/640?wx_fmt=png&amp;from=appmsg" alt=""></p>
<p><strong>举个例子，当嵌入向量的长度为4的时候，位置编码长度也是4</strong></p>
<p>一直说位置向量遵循某个模式，这个模式到底是什么。</p>
<p>在下面的图中，每一行对应一个位置编码。所以第一行就是我们输入序列中第一个单词的位置编码，之后我们要把它加到词嵌入向量上。</p>
<p>看个可视化的图：</p>
<p><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/sz_mmbiz_png/gWS53OdTR9SQgRzua7JiasvAE8BT5Ig9icH3r9PztGJ4FibyRicKmNDXaMQASW1STGHiaWzC7S25TviaJqaZ7HumSS8w/640?wx_fmt=png&amp;from=appmsg" alt=""></p>
<p>这里表示的是一个句子有20个词，词嵌入向量的长度为512。</p>
<p>可以看到图像从中间一分为二，因为左半部分是由正弦函数生成的。右半部分由余弦函数生成。</p>
<p>然后将它们二者拼接起来，形成了每个位置的位置编码。</p>
<p>你可以在get_timing_signal_1d()中看到生成位置编码的代码。</p>
<p>这不是位置编码的唯一方法。但是使用正余弦编码有诸多好处，具体可以看这里：Transforme 结构：位置编码详解</p>
<p>但是需要注意注意一点，上图的可视化是官方Tensor2Tensor库中的实现方法，将sin和cos拼接起来。但是和论文原文写的不一样，论文原文的3.5节写了位置编码的公式，论文不是将两个函数concat起来，而是将sin和cos交替使用。论文中公式的写法可以看这个代码：transformer_positional_encoding_graph，其可视化结果如下：</p>
<p><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/sz_mmbiz_png/gWS53OdTR9Q3ia6rT1LjkL0ibicViaic903ibianCcf35iasw8emF3QVPiaOmKZoAeh7L7BAXJUczW5QI6OxyQU21Fbv1nQ/640?wx_fmt=png&amp;from=appmsg" alt=""></p>
<p>这里表示的是一个句子有10个词，词嵌入向量的长度为64。</p>
<p><strong>残差</strong></p>
<p>在继续往下讲之前，我们还需再提一下编码器中的一个细节：每个编码器中的每个子层（自注意力层、前馈神经网络）都有一个残差连接，之后是做了一个层归一化（layer-normalization）。</p>
<p><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/sz_mmbiz_png/gWS53OdTR9SQgRzua7JiasvAE8BT5Ig9icolGDlVO54fxas8crAx8geqzJefsLFE3uF2IcNEEE13pwZPLSSnaiaDw/640?wx_fmt=png&amp;from=appmsg" alt=""></p>
<p>将过程中的向量相加和layer-norm可视化如下所示：</p>
<p><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/sz_mmbiz_png/gWS53OdTR9SQgRzua7JiasvAE8BT5Ig9iclljObcI53BuPyGrH1uw7z4WMKf2Dvicvd2T22jTb9Q8XghZPHFHGNIQ/640?wx_fmt=png&amp;from=appmsg" alt=""></p>
<p>当然在解码器子层中也是这样的。</p>
<p>我们现在画一个有两个编码器和解码器的Transformer，那就是下图这样的：</p>
<p><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/sz_mmbiz_png/gWS53OdTR9SQgRzua7JiasvAE8BT5Ig9icibmHlgoeCvNvMHl3SXhPGPANMtCgicBIYYgibnZtwIxLWCV1tozz6eiaCQ/640?wx_fmt=png&amp;from=appmsg" alt=""></p>
<p><strong>解码器</strong></p>
<p>现在我们已经介绍了编码器的大部分概念，（因为encoder的decoder组件差不多）我们基本上也知道了解码器的组件是如何工作的。那让我们直接看看二者是如何协同工作的。</p>
<p>编码器首先处理输入序列，将最后一个编码器组件的输出转换为一组注意向量K和V。每个解码器组件将在“encoder-decoder attention”层中使用编码器传过来的K和V，这有助于解码器将注意力集中在输入序列中的适当位置：</p>
<p><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/sz_mmbiz_gif/gWS53OdTR9Q3ia6rT1LjkL0ibicViaic903ibiadLgR7mLayMicCZoQdR6icPnnsOb6vrDE2GGCPQQica8gIA0ic1aBUibvX9A/640?wx_fmt=gif&amp;from=appmsg" alt=""></p>
<p>完成编码阶段后，我们开始进行解码阶段。</p>
<p>在解码阶段每一轮计算都只往外蹦一个输出，在本例中是输出一个翻译之后的英语单词。</p>
<p>输出步骤会一直重复，直到遇到句子结束符 表明transformer的解码器已完成输出。</p>
<p>每一步的输出都会在下一个时间步喂给给底部解码器，解码器会像编码器一样运算并输出结果（每次往外蹦一个词）。</p>
<p>跟编码器一样，在解码器中我们也为其添加位置编码，以指示每个单词的位置。</p>
<p><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/sz_mmbiz_gif/gWS53OdTR9Q3ia6rT1LjkL0ibicViaic903ibiabkCZwF3ibLqsmPr5G3OwbIoWaOoGMlicJtmwCCdx68icbOwI38AkMnNtg/640?wx_fmt=gif&amp;from=appmsg" alt=""></p>
<p>解码器中的自注意力层和编码器中的不太一样：</p>
<p>在解码器中，自注意力层只允许关注已输出位置的信息。实现方法是在自注意力层的softmax之前进行mask，将未输出位置的信息设为极小值。</p>
<p>“encoder-decoder attention”层的工作原理和前边的多头自注意力差不多，但是Q、K、V的来源不用，Q是从下层创建的（比如解码器的输入和下层decoder组件的输出），但是其K和V是来自编码器最后一个组件的输出结果。</p>
<p><strong>最后的线性层和softmax层</strong></p>
<p>Decoder输出的是一个浮点型向量，如何把它变成一个词？</p>
<p>这就是最后一个线性层和softmax要做的事情。</p>
<p>线性层就是一个简单的全连接神经网络，它将解码器生成的向量映射到logits向量中。</p>
<p>假设我们的模型词汇表是10000个英语单词，它们是从训练数据集中学习的。那logits向量维数也是10000，每一维对应一个单词的分数。</p>
<p>然后，softmax层将这些分数转化为概率（全部为正值，加起来等于1.0），选择其中概率最大的位置的词汇作为当前时间步的输出。</p>
<p><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/sz_mmbiz_png/gWS53OdTR9SQgRzua7JiasvAE8BT5Ig9icV7T3KAeMKY0ZYJWCTNicOAUovN0rLluXq4jRlf6WR3W03NrqC78GAeQ/640?wx_fmt=png&amp;from=appmsg" alt=""></p>
<p>这张图从下往上看，假设具体上的那个向量是解码器的输出，然后将其转换为最终输出的单词。</p>
<p><strong>训练过程概述</strong></p>
<p>现在我们已经了解了Transformer的整个前向传播的过程，那我们继续看一下训练过程。</p>
<p>在训练期间，未经训练的模型会进行相同的前向传播过程。由于我们是在有标记的训练数据集上训练它，所以我们可以将其输出与实际的输出进行比较。</p>
<p>为了便于理解，我们假设预处理阶段得到的词汇表只包含六个单词（“a”, “am”, “i”, “thanks”, “student”, “<eos>”）。</p>
<p><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/sz_mmbiz_png/gWS53OdTR9SQgRzua7JiasvAE8BT5Ig9icMeKib1mBWtT11EIJVicNjDBdID7hynQWeOhoXtQutUyAPnefLNDVic5jA/640?wx_fmt=png&amp;from=appmsg" alt=""></p>
<p>注意这个词汇表是在预处理阶段就创建的，在训练之前就已经得到了。</p>
<p>一旦我们定义好了词汇表，我们就可以使用长度相同的向量（独热码，one-hot 向量）来表示词汇表中的每个单词。例如，我们可以用以下向量表示单词“am”：</p>
<p><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/sz_mmbiz_png/gWS53OdTR9SQgRzua7JiasvAE8BT5Ig9icK2K98N1OjcedsluxuWglBlk3PMIuek7VCHro2KU5HK40Cukl7dlkVg/640?wx_fmt=png&amp;from=appmsg" alt=""></p>
<p>接下来让我们讨论一下模型的损失函数，损失函数是我们在训练阶段优化模型的指标，通过损失函数，可以帮助我们获得一个准确的、我们想要的模型。</p>
<p><strong>损失函数</strong></p>
<p>假设我们正要训练我们的模型。</p>
<p>假设现在是训练阶段的第一步，我们用一个简单的例子（一个句子就一个词）来训练模型：把 “merci” 翻译成 “thanks”。</p>
<p>这意味着，我们希望输出是表示“谢谢”的概率分布。但由于这个模型还没有经过训练，所以目前还不太可能实现。</p>
<p><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/sz_mmbiz_png/gWS53OdTR9SQgRzua7JiasvAE8BT5Ig9icGKUIQHQG5XNPniasu4bUGGqsVkbDmjyct3CygJiaVSkebZUAaSCITVsw/640?wx_fmt=png&amp;from=appmsg" alt=""></p>
<p>由于模型的参数都是随机初始化的，未经训练的模型为每个单词生成任意的概率分布。</p>
<p>我们可以将其与实际输出进行比较，然后使用反向传播调整模型的权重，使输出更接近我们所需要的值。</p>
<p>如何比较两种概率分布？在这个例子中我们只是将二者相减。实际应用中的损失函数请查看交叉熵损失和Kullback–Leibler散度。</p>
<p>上述只是最最简单的一个例子。现在我们来使用一个短句子（一个词的句子升级到三三个词的句子了），比如输入 “je suis étudiant” 预期的翻译结果为：“i am a student”。</p>
<p>所以我们希望模型不是一次输出一个词的概率分布了，能不能连续输出概率分布，最好满足下边要求：</p>
<ul>
<li>
<p>每个概率分布向量长度都和词汇表长度一样。我们的例子中词汇表长度是6，实际操作中一般是30000或50000。</p>
</li>
<li>
<p>在我们的例子中第一个概率分布应该在与单词“i”相关的位置上具有最高的概率</p>
</li>
<li>
<p>第二种概率分布在与单词“am”相关的单元处具有最高的概率</p>
</li>
<li>
<p>以此类推，直到最后输出分布指示“<eos>”符号。除了单词本身之外，单词表中也应该包含诸如“<eos>”的信息，这样softmax之后指向“<eos>”位置，标志解码器输出结束。</p>
</li>
</ul>
<p><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/sz_mmbiz_png/gWS53OdTR9SQgRzua7JiasvAE8BT5Ig9iciam09cVt2mCyG31J2Y1VpycIvbs5VkNPUr1KarIrtPFFiabxj7Azay1A/640?wx_fmt=png&amp;from=appmsg" alt=""></p>
<p>对应上面的单词表，我们可以看出这里的one-hot向量是我们训练之后想要达到的目标。</p>
<p>在足够大的数据集上训练模型足够长的时间后，我们希望生成的概率分布如下所示：</p>
<p><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/sz_mmbiz_png/gWS53OdTR9SQgRzua7JiasvAE8BT5Ig9icBzOdw1PjwSRPgLt9N0RYAYWFO4kcPexzvniaLwObMjG4dVL9qIcC5Nw/640?wx_fmt=png&amp;from=appmsg" alt=""></p>
<p>这个是我们训练之后最终得到的结果。当然这个概率并不能表明某个词是否是训练集之中的词汇。</p>
<p>在这里你可以看到softmax的一个特性，就是即使其他单词并不是本时间步的输出，</p>
<p>也会有一丁点的概率存在，这一特性有助于帮助模型进行训练。</p>
<p>模型一次产生一个输出，在这么多候选中我们如何获得我们想要的输出呢？现在有两种处理结果的方法：</p>
<p>一种是贪心算法（greedy decoding）：模型每次都选择分布概率最高的位置，输出其对应的单词。</p>
<p>另一种方法是束搜索（beam search）：保留概率最高前两个单词（例如，“I”和“a”），然后在下一步继续选择两个概率最高的值，以此类推，在这里我们把束搜索的宽度设置为2，当然你也可以设置其他的束搜索宽度。</p>
<p><strong>参考：</strong></p>
<p>**<a href="http://mp.weixin.qq.com/s?__biz=Mzg5MzY2MjMxMg==&amp;mid=2247513685&amp;idx=1&amp;sn=71914087ef33791bdb8c52e56f369bfb&amp;chksm=c0299352f75e1a44116b367ab706bc646039741013033650adeede0fa2f281d2185a3893a8f0&amp;scene=21#wechat_redirect">[1]图解！逐步理解Transformers的数学原理</a></p>
<p><strong><a href="http://mp.weixin.qq.com/s?__biz=Mzg5MzY2MjMxMg==&amp;mid=2247513685&amp;idx=1&amp;sn=71914087ef33791bdb8c52e56f369bfb&amp;chksm=c0299352f75e1a44116b367ab706bc646039741013033650adeede0fa2f281d2185a3893a8f0&amp;scene=21#wechat_redirect">[2]</a></strong> <a href="http://mp.weixin.qq.com/s?__biz=Mzg5MzY2MjMxMg==&amp;mid=2247514904&amp;idx=1&amp;sn=74e9c04483e78432c72c5a814af7fb94&amp;chksm=c0299e1ff75e17097126fc4f8f43e0d3a290e8eb485ee790e36fe5cc37a4fe6ba3acc1b54d5b&amp;scene=21#wechat_redirect">【LLM】万字通俗讲解大语言模型内部运行原理</a></p>
<p>[3]https://blog.csdn.net/yujianmin1990/article/details/85221271</p>
<p>更多AI工具，参考<a href="https://aibard123.com/">Github-AiBard123</a>，<a href="https://aibard123.com/">国内AiBard123</a></p>



          </div>

可关注我们的公众号：每天AI新工具

<p><img src="/images/aitools/2024/03/qrcode_for_gh_dde1b429630d_258.jpg" alt=""></p>

        </article>

      </div>
    </div>
  </div>
</section>
        </div>
    </div>
    </main>




<script type='text/javascript' src='/assets/js/jquery.ui.touch-punch.min-0.2.2.js' id='jqueryui-touch-js'></script>
<script type='text/javascript' src='/assets/js/clipboard.min-5.6.2.js' id='clipboard-js'></script>
<script type='text/javascript' src='/assets/js/tooltip-extend.js' id='iplaycode-nav-js'></script>
<script type='text/javascript' id='popper-js-extra'>
 

var theme = {"ajaxurl":"","addico":"https:\/\/nav.baidu.cn\/wp-content\/themes\/onenav\/images\/add.png","order":"asc","formpostion":"top","defaultclass":"io-grey-mode","isCustomize":"1","icourl":"","icopng":".png","urlformat":"1","customizemax":"10","newWindow":"0","lazyload":"1","minNav":"1","loading":"1","hotWords":"baidu","classColumns":" col-sm-6 col-md-4 col-xl-5a col-xxl-6a ","apikey":"TWpBeU1UVTNOekk1TWpVMEIvZ1M2bFVIQllUMmxsV1dZelkxQTVPVzB3UW04eldGQmxhM3BNWW14bVNtWk4="};
 
</script>
<script type='text/javascript' src='/assets/js/popper.min.js' id='popper-js'></script>
<script type='text/javascript' src='/assets/js/bootstrap.min-4.3.1.js' id='bootstrap-js'></script>
<script type='text/javascript' src='/assets/js/theia-sticky-sidebar-1.5.0.js' id='sidebar-js'></script>
<script type='text/javascript' src='/assets/js/lazyload.min-12.4.0.js' id='lazyload-js'></script>
<script type='text/javascript' src='/assets/js/fancybox.min-3.5.7.js' id='lightbox-js-js'></script>

<script type='text/javascript' src='/assets/js/app-anim.js' id='appanim-js'></script>

<script type="text/javascript">
    $(document).ready(function(){
        var siteWelcome = $('#loading');
        siteWelcome.addClass('close');
        setTimeout(function() {
            siteWelcome.remove();
        }, 600);
    });
</script>
<script>        
    $(document).ready(function(){
        setTimeout(function () {
            if ($('a.smooth[href="' + window.location.hash + '"]')[0]) {
                $('a.smooth[href="' + window.location.hash + '"]').click();
            }else if (window.location.hash != '') {
                $("html, body").animate({
                    scrollTop: $(window.location.hash).offset().top - 90
                }, {
                    duration: 500,
                    easing: "swing"
                });
            }
        }, 300);
        $(document).on('click','a.smooth',function(ev) {
            if($('#sidebar').hasClass('show') && !$(this).hasClass('change-href')){
                $('#sidebar').modal('toggle');
            }
            if($(this).attr("href").substr(0, 1) == "#"){
                $("html, body").animate({
                    scrollTop: $($(this).attr("href")).offset().top - 90
                }, {
                    duration: 500,
                    easing: "swing"
                });
            }
            if($(this).hasClass('go-search-btn')){
                $('#search-text').focus();
            }
            if(!$(this).hasClass('change-href')){
                var menu =  $("a"+$(this).attr("href"));
                menu.click();
                toTarget(menu.parent().parent(),true,true);
            }
        });
        $(document).on('click','a.tab-noajax',function(ev) {
            var url = $(this).data('link');
            if(url)
                $(this).parents('.d-flex.flex-fill.flex-tab').children('.btn-move.tab-move').show().attr('href', url);
            else
                $(this).parents('.d-flex.flex-fill.flex-tab').children('.btn-move.tab-move').hide();
        });
        
    });
</script>

<script>

(function(){
    if(document.cookie.replace(/(?:(?:^|.*;\s*)night\s*\=\s*([^;]*).*$)|^.*$/, "$1") === ''){
        if(new Date().getHours() > 22 || new Date().getHours() < 6){
            document.body.classList.remove('io-black-mode');
            document.body.classList.add('io-grey-mode');
            document.cookie = "night=1;path=/";
            console.log('夜间模式开启');
        }else{
            document.body.classList.remove('night');
            document.cookie = "night=0;path=/";
            console.log('夜间模式关闭');
        }
    }else{
        var night = document.cookie.replace(/(?:(?:^|.*;\s*)night\s*\=\s*([^;]*).*$)|^.*$/, "$1") || '0';
        if(night == '0'){
            document.body.classList.remove('night');
        }else if(night == '1'){
            document.body.classList.add('night');
        }
    }
})();

$("#search-bg").css("background", "linear-gradient(#e2c4c4, #d8d8d8)");   
function switchNightMode(){
    var night = document.cookie.replace(/(?:(?:^|.*;\s*)night\s*\=\s*([^;]*).*$)|^.*$/, "$1") || '0';
    if(night == '0'){
	$("#search-bg").css("background", "linear-gradient(#e2c4c4, #d8d8d8)");
        document.body.classList.remove('io-grey-mode');
        document.body.classList.add('io-black-mode');
        document.cookie = "night=1;path=/"
        console.log(' ');
        $(".switch-dark-mode").attr("data-original-title","日间模式");
        $(".mode-ico").removeClass("icon-night");
        $(".mode-ico").addClass("icon-light");
    }else{
	$("#search-bg").css("background", "linear-gradient(#4f4040, #1b1d1f)");
        document.body.classList.remove('io-black-mode');
        document.body.classList.add('io-grey-mode');
        document.cookie = "night=0;path=/"
        console.log(' ');
        $(".switch-dark-mode").attr("data-original-title","夜间模式");
        $(".mode-ico").removeClass("icon-light");
        $(".mode-ico").addClass("icon-night");
    }
}
</script>


<script>
    var newsContainer = document.getElementById('news-container');
    var newsItems = document.getElementsByClassName('news-item');
    var currentItem = 0;

    setInterval(function() {
        
        newsItems[currentItem].classList.remove('show');
        newsItems[currentItem].style.transform = 'translateY(-20px)';
        
        currentItem = (currentItem + 1) % newsItems.length;
        newsItems[currentItem].style.transform = 'translateY(' + (newsContainer.offsetHeight - 20) + 'px)';
        setTimeout(function() {
            newsItems[currentItem].classList.add('show');
        }, 500);
    }, 8000);
</script>

</body>
</html>


