

<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1" />
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta name="theme-color" content="#f9f9f9" />

	<title>Hopperæ¶æ„ç‰¹æ€§ï¼šDistributedSharedMemory ä½œè€…ï¼š åƒæœå†»ä¸åæœå†»çš® æ¥æºï¼š åƒæœå†»ä¸åæœå†»çš® ####**ã€ç‚¹å‡»ã€‘åŠ å…¥å¤§æ¨¡å‹æŠ€æœ¯äº¤æµç¾¤** åŸæ–‡ï¼šhttps://zhuanlan.zhihu.com/p/708645371 æœ€è¿‘ FlashAttention3 çˆ†ç«ï¼Œçœ‹äº†ä¸‹å…¶ä¸­çš„æŠ€æœ¯æŠ¥å‘Šï¼Œå‘ç°å¤§é‡ä½¿ç”¨äº† NV Hopper æ¶æ„çš„æ–°ç‰¹æ€§ã€‚Ho  | AiBard123| aiå·¥å…·ç½‘å€å¯¼èˆª,aiæœ€æ–°äº§å“</title>
	<link rel="shortcut icon" href="/assets/images/favicon.png" />
    <meta name="keywords" content="chatgpt,AI,AIèŠå¤©,AIæ–‡æœ¬ç”Ÿæˆ,AIç»˜ç”»,AIç¼–ç¨‹,AIç”µå•†" />
    <meta name="description" content="AiBard123 ç½‘å€å¯¼èˆª | å…è´¹chatgpt æ±‡é›†å„ç±»å…ˆè¿›çš„äººå·¥æ™ºèƒ½äº§å“ï¼Œæ—¨åœ¨å¸®åŠ©ç”¨æˆ·æ›´å¿«é€Ÿåœ°äº†è§£å’Œä½¿ç”¨è¿™äº›äº§å“,è½»æ¾åœ°æµè§ˆä¸åŒé¢†åŸŸçš„AIäº§å“ï¼ŒåŒ…æ‹¬è¯­éŸ³è¯†åˆ«ã€å›¾åƒå¤„ç†ã€è‡ªç„¶è¯­è¨€å¤„ç†ã€‚" />
    
    <meta name="baidu-site-verification" content="codeva-cCAOSG8MBO" />
    
    <link rel="stylesheet" id="block-library-css"
        href="/assets/css/block-library.min-5.6.2.css" type="text/css" media="all" />
    <link rel="stylesheet" id="iconfont-css" href="/assets/css/iconfont-3.03029.1.css"
        type="text/css" media="all" />

    
    <link href="/scss/style.min.css" rel="stylesheet" />
    
		    <link rel="stylesheet" id="iowen-css" href="/assets/css/style-3.03029.1.css"
        type="text/css" media="all" />
    <link rel="stylesheet" id="custom-css" href="/assets/css/custom-style.css"
        type="text/css" media="all" />
		
		<link rel="stylesheet" href=/plugins/font-awesome/css/font-awesome.min.css />


    <link rel="stylesheet" id="fortawesome-css" href="/assets/fontawesome-5.15.4/css/all.min.css" type="text/css" />


    <script type="text/javascript" src="/assets/js/jquery.min-3.2.1.js" id="jquery-js"></script>
    <script type="text/javascript" src="/assets/js/content-search.js"  id="content-search-js"></script>

    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2073588164294660"
     crossorigin="anonymous"></script>

	
    <script>
        

		var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?8450bc732b2a86f7e4aec4ebd9fd8252";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();

        
    </script>
    

    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-7071W80M2K"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-7071W80M2K');
    </script>

</head>


    <div class="page-container">
	
	<div id="sidebar" class="sticky sidebar-nav fade animate-nav" style="width: 170px">
        
            <div class="modal-dialog h-100 sidebar-nav-inner">
                <div class="sidebar-logo border-bottom border-color">
                    
                    <div class="logo overflow-hidden">
                        <a href="https://aibard123.com/" class="logo-expanded">
                            <img src="/assets/images/bt8-expand-light.png" height="40" class="logo-light"
                                alt="AiBard123| aiå·¥å…·ç½‘å€å¯¼èˆª,aiæœ€æ–°äº§å“">
                            <img src="/assets/images/bt8-expand-dark.png" height="40" class="logo-dark d-none"
                                alt="AiBard123| aiå·¥å…·ç½‘å€å¯¼èˆª,aiæœ€æ–°äº§å“">
                        </a>
                        <a href="https://aibard123.com/" class="logo-collapsed">
                            <img src="/assets/images/bt.png" height="40" class="logo-light"
                                alt="AiBard123| aiå·¥å…·ç½‘å€å¯¼èˆª,aiæœ€æ–°äº§å“">
                            <img src="/assets/images/bt.png" height="40" class="logo-dark d-none"
                                alt="AiBard123| aiå·¥å…·ç½‘å€å¯¼èˆª,aiæœ€æ–°äº§å“">
                        </a>
                    </div>
                    
                </div>
                <div class="sidebar-menu flex-fill">
                    <div class="sidebar-scroll">
                        <div class="sidebar-menu-inner">
                            <ul>
                                
                                    
                                    <li class="sidebar-item">
                                        <a href="/#00834a9dd147b04c5d53d4368cdb0b57" class="smooth">
                                            <i class="fas fa-sun fa-lg fa-lg icon-fw icon-lg mr-2"></i>
                                            <span>æœ¬æœˆçƒ­é—¨</span>
                                        </a>
                                    </li>
                                    
                                
                                    
                                    <li class="sidebar-item">
                                        <a href="/#db0311e7ecfedd24d157f0ceb4a0897f" class="smooth">
                                            <i class="fas fa-star-and-crescent fa-lg fa-lg icon-fw icon-lg mr-2"></i>
                                            <span>çƒ­é—¨ç½‘ç«™</span>
                                        </a>
                                    </li>
                                    
                                
                                    
                                    <li class="sidebar-item">
                                        <a href="/#21b5cbb2c769010fec3ce029a5f8a4a3" class="smooth">
                                            <i class="far fa-star fa-lg icon-fw icon-lg mr-2"></i>
                                            <span>å›½å†…çƒ­é—¨</span>
                                        </a>
                                    </li>
                                    
                                
                                    
                                    <li class="sidebar-item">
                                        <a href="/#8310718935e8ec25ce0350de01e3f7dc" class="smooth">
                                            <i class="fas fa-phone fa-lg fa-lg icon-fw icon-lg mr-2"></i>
                                            <span>å¯¹è¯å·¥å…·</span>
                                        </a>
                                    </li>
                                    
                                
                                    
                                    <li class="sidebar-item">
                                        <a href="/#d58e850d9115797306c2edf61ac6ddd8" class="smooth">
                                            <i class="fas fa-newspaper fa-lg fa-lg icon-fw icon-lg mr-2"></i>
                                            <span>å†™ä½œ</span>
                                        </a>
                                    </li>
                                    
                                
                                    
                                    <li class="sidebar-item">
                                        <a href="/#2a7418a5f8f1ca4e054364a9300657df" class="smooth">
                                            <i class="fas fa-image fa-lg fa-lg icon-fw icon-lg mr-2"></i>
                                            <span>å›¾åƒç”Ÿæˆ</span>
                                        </a>
                                    </li>
                                    
                                
                                    
                                    <li class="sidebar-item">
                                        <a href="/#7808a68ee1b34dab43011429a12de19e" class="smooth">
                                            <i class="fas fa-image fa-lg fa-lg icon-fw icon-lg mr-2"></i>
                                            <span>å›¾åƒå¤„ç†</span>
                                        </a>
                                    </li>
                                    
                                
                                    
                                    <li class="sidebar-item">
                                        <a href="/#6729afc51f5ac49a828812fa0eb0c82f" class="smooth">
                                            <i class="fas fa-video fa-lg fa-lg icon-fw icon-lg mr-2"></i>
                                            <span>éŸ³è§†é¢‘</span>
                                        </a>
                                    </li>
                                    
                                
                                    
                                    <li class="sidebar-item">
                                        <a href="/#e5ce844860451fff3faf3d8f8894971d" class="smooth">
                                            <i class="fas fa-music fa-lg fa-lg icon-fw icon-lg mr-2"></i>
                                            <span>éŸ³ä¹ç”Ÿæˆ</span>
                                        </a>
                                    </li>
                                    
                                
                                    
                                    <li class="sidebar-item">
                                        <a href="/#db53804b7d726967c58fcc8c9ca03d27" class="smooth">
                                            <i class="fas fa-language fa-lg fa-lg icon-fw icon-lg mr-2"></i>
                                            <span>åŠå…¬</span>
                                        </a>
                                    </li>
                                    
                                
                                    
                                    <li class="sidebar-item">
                                        <a href="/#47b7af9547e034d28fe6f6d439968ac8" class="smooth">
                                            <i class="fas fa-copy fa-lg fa-lg icon-fw icon-lg mr-2"></i>
                                            <span>æç¤ºè¯</span>
                                        </a>
                                    </li>
                                    
                                
                                    
                                    <li class="sidebar-item">
                                        <a href="/#41282bf95e43c64d579757573a03cdde" class="smooth">
                                            <i class="fas fa-code fa-lg fa-lg icon-fw icon-lg mr-2"></i>
                                            <span>ç¼–ç¨‹</span>
                                        </a>
                                    </li>
                                    
                                
                                    
                                    <li class="sidebar-item">
                                        <a href="/#fd71852fd52d5e18ef4f9a252f1eac58" class="smooth">
                                            <i class="fas fa-search fa-lg fa-lg icon-fw icon-lg mr-2"></i>
                                            <span>AIæœç´¢</span>
                                        </a>
                                    </li>
                                    
                                
                                    
                                    <li class="sidebar-item">
                                        <a href="/#81b1637fbe47625dbdf2094acd3b6683" class="smooth">
                                            <i class="fas fa-language fa-lg fa-lg icon-fw icon-lg mr-2"></i>
                                            <span>æ–‡æœ¬ç¿»è¯‘</span>
                                        </a>
                                    </li>
                                    
                                
                                    
                                    <li class="sidebar-item">
                                        <a href="/#2e9ba3fa6e1ed0e9311b3e97f97f9a40" class="smooth">
                                            <i class="fas fa-book fa-lg fa-lg icon-fw icon-lg mr-2"></i>
                                            <span>å­¦ä¹ ç½‘ç«™</span>
                                        </a>
                                    </li>
                                    
                                
                            </ul>           
                        </div>
                    </div>
                </div>
                <div class="border-top py-2 border-color">
                    <div class="flex-bottom">
                        <ul>
			    <li id="menu-item-212"
                                 class="menu-item menu-item-type-custom menu-item-object-custom menu-item-212 sidebar-item">
                                 <a href="#friendlink" class="smooth">
                                     <i class="fab fa-staylinked icon-fw icon-lg mr-2"></i>
                                     <span>å‹æƒ…é“¾æ¥</span>
                                 </a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>


<div class="flex-fill grid-bg">
    <div class="big-header-banner">
        <div id="header" class="page-header sticky">
            <div class="navbar navbar-expand-md">
                <div class="container-fluid p-0">

                    <a href="" class="navbar-brand d-md-none" title="AiBard123| aiå·¥å…·ç½‘å€å¯¼èˆª,aiæœ€æ–°äº§å“">
                        <img src="/assets/images/bt.png" class="logo-light"
                            alt="AiBard123| aiå·¥å…·ç½‘å€å¯¼èˆª,aiæœ€æ–°äº§å“">
                        <img src="/assets/images/bt.png" class="logo-dark d-none"
                            alt="AiBard123| aiå·¥å…·ç½‘å€å¯¼èˆª,aiæœ€æ–°äº§å“">
                    </a>

                    <div class="collapse navbar-collapse order-2 order-md-1">
                        <div class="header-mini-btn">
                            <label>
                                <input id="mini-button" type="checkbox">
                                <svg viewbox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                                    <path class="line--1" d="M0 40h62c18 0 18-20-17 5L31 55"></path>
                                    <path class="line--2" d="M0 50h80"></path>
                                    <path class="line--3" d="M0 60h62c18 0 18 20-17-5L31 45"></path>
                                </svg>
                            </label>

                        </div>

                        <ul class="navbar-nav site-menu" style="margin-right: 16px;">
                        
			<li >
				<a href="/">
                                    <i class="fa fa-home fa-lg mr-2"></i>
                                    <span>é¦–é¡µ</span>
                                </a>
				<ul class="sub-menu">
				
				</ul>
			    </li>
			
			</ul>

                        
                        <div class="rounded-circle weather">
                            <div id="he-plugin-simple" style="display: contents;"></div>
                            <script>WIDGET = {
                                    CONFIG: {
                                        "modules": "01234",
                                        "background": 5,
                                        "tmpColor": "008000",
                                        "tmpSize": 14,
                                        "cityColor": "008000",
                                        "citySize": 14,
                                        "aqiColor": "#008000",
                                        "aqiSize": 14,
                                        "weatherIconSize": 24,
                                        "alertIconSize": 18,
                                        "padding": "10px 10px 10px 10px",
                                        "shadow": "1",
                                        "language": "auto",
                                        "borderRadius": 5,
                                        "fixed": "false",
                                        "vertical": "middle",
                                        "horizontal": "left",
                                        "key": "085791e805a24491b43b06cf58ab31e7"
                                    }
                                }
                            </script>
                            <script src="https://widget.qweather.net/simple/static/js/he-simple-common.js?v=2.0"></script>
                        </div>
                        
                    </div>

                    <ul class="nav navbar-menu text-xs order-1 order-md-2">
                        
                        
                        <li class="nav-item mr-3 mr-lg-0 d-none d-lg-block">
                            <script>
                                fetch('https://v1.hitokoto.cn')
                                    .then(response => response.json())
                                    .then(data => {
                                    const hitokoto = document.getElementById('hitokoto_text')
                                    hitokoto.href = 'https://hitokoto.cn/?uuid=' + data.uuid
                                    hitokoto.innerText = data.hitokoto
                                    })
                                    .catch(console.error)
                            </script>                           
                            <div id="hitokoto"><a href="#" target="_blank" id="hitokoto_text">ç–å½±æ¨ªæ–œæ°´æ¸…æµ…ï¼Œæš—é¦™æµ®åŠ¨æœˆé»„æ˜ã€‚</a></div>
                        </li>
                        
                        
                        <li class="nav-search ml-3 ml-md-4">
                            <a href="javascript:" data-toggle="modal" data-target="#search-modal"><i
                                    class="iconfont icon-search icon-2x"></i></a>
                        </li>
                        <li class="nav-item d-md-none mobile-menu ml-3 ml-md-4">
                            <a href="javascript:" id="sidebar-switch" data-toggle="modal"
                                data-target="#sidebar"><i class="iconfont icon-classification icon-2x"></i></a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
        <div class="placeholder" style="height:74px"></div>
    </div>




<body class="page-body boxed-container  io-grey-mode">
    <main role="main" class="flex-shrink-0">
    <div class="container">
        
        <div class="content">
            <style>
    body{
	    background: #f9f9f9;
	}

    h1, h2, h3, h4, h5, h6 {
        margin-top: 1.5rem;
        margin-bottom: 1.5rem;
    }


 
@media (min-width: 1000px) {
  .container, .container-sm {
    max-width: 800px;
  }
}

</style>

<div class="featured-post-content">

    <a href="/digest/" class="featured-post-title">
       AI æ–‡æ‘˜
    </a>

</div>

<section class="blog-single">
  <div class="container">
    <div class="row">

      <div class="col-lg-12 order-1 order-lg-2">
        <article class="single-blog">
          <p class="title">Hopperæ¶æ„ç‰¹æ€§ï¼šDistributedSharedMemory</p>
            <br/>
          <ul class="meta">
            <li>
              By <a href=https://aibard123.com/about>AiBard123</a>
            </li>
            <li>
              <i class="fa fa-clock-o"></i>
              August 12, 2024 - 2 min read
            </li>
          </ul>

          <div class="_1NCGf">
              <img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/mmbiz_jpg/yXChImmsky9Rm1NBP69PH2pzKNpGp4ZQ50mInguW2sM39eMebiascfnWVibf5VhSaQbfYYClJcB1musdCk6baBjw/640?wx_fmt=other&amp;from=appmsg" width="640" >
          </div>
            <br>
            <br>
            <br>
          
          <div class="single-blog-content">
            <p>ä½œè€…ï¼š åƒæœå†»ä¸åæœå†»çš®  æ¥æºï¼š <a href="https://mp.weixin.qq.com/s/iwDiqv3sgzSR2wt0ExafFg">åƒæœå†»ä¸åæœå†»çš®</a></p>
<p>####**<a href="http://mp.weixin.qq.com/s?__biz=MzU3Mzg5ODgxMg==&amp;mid=2247485828&amp;idx=1&amp;sn=7355c99bc907b972773f795cea9326c8&amp;chksm=fd3be0d7ca4c69c10d842b0150a754178f9bd7691ec1e8a64c7a441822ca45833e718a9008bd&amp;scene=21#wechat_redirect">ã€ç‚¹å‡»ã€‘åŠ å…¥å¤§æ¨¡å‹æŠ€æœ¯äº¤æµç¾¤** </a></p>
<p>åŸæ–‡ï¼šhttps://zhuanlan.zhihu.com/p/708645371</p>
<p>æœ€è¿‘ FlashAttention3 çˆ†ç«ï¼Œçœ‹äº†ä¸‹å…¶ä¸­çš„æŠ€æœ¯æŠ¥å‘Šï¼Œå‘ç°å¤§é‡ä½¿ç”¨äº† NV Hopper æ¶æ„çš„æ–°ç‰¹æ€§ã€‚Hooper æ¶æ„å›´ç»•å½±å“å¹¶è¡Œç¨‹åºæ€§èƒ½çš„ä¸¤ä¸ªå…³é”®å› ç´ è¿›è¡Œè®¾è®¡ï¼Œåˆ†åˆ«æ˜¯æ•°æ®å±€éƒ¨æ€§ä»¥åŠå¼‚æ­¥æ‰§è¡Œã€‚æ‰€ä»¥ Hopper æ¶æ„ï¼ˆhttps://developer.nvidia.com/blog/nvidia-hopper-architecture-in-depthï¼‰é’ˆå¯¹è¿™ä¸¤ä¸ªå…³é”®å› ç´ ï¼Œåœ¨è½¯ä»¶å±‚æä¾›äº†ä¸¤æ–¹é¢çš„ç¼–ç¨‹èƒ½åŠ›ï¼š</p>
<ol>
<li>
<p>æ–°çº¿ç¨‹ã€æ˜¾å­˜å±‚æ¬¡ï¼šé€šè¿‡æ–°å¢ Thread Block Cluster è¿™ä¸€çº¿ç¨‹å±‚æ¬¡ï¼Œæä¾›è·¨ Thread Block çš„ Shared Memory è®¿é—®ã€‚å¼€å‘è€…å¯ä»¥åŸºäº Thread Block Cluster ï¼Œåˆ©ç”¨ Distributed Shared Memory å®ç°é«˜æ•ˆçš„å¤š Thread Block çš„ååŒè¿è¡Œï¼›</p>
</li>
<li>
<p>è®¿å­˜è®¡ç®—å¼‚æ­¥æ‰§è¡Œï¼šHopper åœ¨ç¡¬ä»¶å±‚æä¾›äº† TMA å•å…ƒï¼Œåœ¨è½¯ä»¶å±‚å¯ä»¥é€šè¿‡ cuda::memcpy_async ä½¿ç”¨ TMA å•å…ƒå®ç°å¼‚æ­¥çš„ Global Memory å’Œ Shared Memory ä¹‹é—´çš„æ‹·è´ã€‚</p>
</li>
</ol>
<p>æœ¬æ–‡ä¸»è¦å­¦ä¹  Thread Block Clustersï¼Œç ”ç©¶å¦‚ä½•åŸºäº Distributed Shared Memory å®ç°å¤š Thread Block çš„ååŒè¿è¡Œã€‚</p>
<h4 id="1-thread-block-clusters-çš„å‰ä¸–ä»Šç”Ÿ">1. Thread Block Clusters çš„å‰ä¸–ä»Šç”Ÿ</h4>
<h4 id="11-hooper-æ¶æ„å‰çš„-gpu-çº¿ç¨‹ç»“æ„">1.1 Hooper æ¶æ„å‰çš„ GPU çº¿ç¨‹ç»“æ„</h4>
<p>ä¸€ç›´ä»¥æ¥ï¼ŒGPU çš„çº¿ç¨‹ç»“æ„éƒ½æ˜¯ä¸‰å±‚ç»“æ„ï¼Œè‡ªåº•å‘ä¸Šåˆ†åˆ«æ˜¯ Threadï¼ˆçº¿ç¨‹ï¼‰ã€Thread Blockï¼ˆçº¿ç¨‹å—ï¼‰ä»¥åŠ Gridï¼ˆç½‘æ ¼ï¼‰ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚Grid æ˜¯æœ€ä¸Šå±‚çš„ç»“æ„ï¼ŒGrid ä¸­æ‰€æœ‰çº¿ç¨‹å¯ä»¥è®¿é—® Global Memory çš„å†…å®¹ã€‚ä¸€ä¸ª Grid ç”±å¤šä¸ªä¸åŒçš„ Thread Block ç»„æˆï¼Œ æ¯ä¸ª Thread Block æœ‰ä¸€å— Shared Memoryï¼ŒåŒä¸€ä¸ª Thread Block ä¸­çš„æ‰€æœ‰çº¿ç¨‹å¯ä»¥é€šè¿‡ Shared Memory äº¤æ¢æ•°æ®ï¼Œåœ¨è½¯ä»¶å±‚å¯ä»¥é€šè¿‡__syncthreads()ç­‰ API å®ç°åŒæ­¥æ“ä½œã€‚</p>
<p><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/mmbiz_jpg/yXChImmsky9Rm1NBP69PH2pzKNpGp4ZQzG7rbiae3ENWUaN6S6KcnPgcb2oxDPPEVmmuyaX75pIbUTjdaOItMfA/640?wx_fmt=other&amp;from=appmsg" alt=""></p>
<p>ä¸çº¿ç¨‹å±‚æ¬¡å¯¹åº”çš„æ˜¯æ˜¾å­˜å±‚æ¬¡ï¼Œä¸åŒå±‚æ¬¡çš„çº¿ç¨‹å¯ä»¥è®¿é—®ä¸åŒå±‚æ¬¡çš„æ˜¾å­˜ã€‚å¦‚ä¸Šæ‰€è¿°ï¼ŒGridã€Thread Block ä»¥åŠ Thread å¯¹åº”å¯ä»¥è®¿é—®çš„åˆ†åˆ«æ˜¯ Global Memory ã€Shared Memory ä»¥åŠ Register / Local Memoryã€‚å…¶ä¸­ Global Memoryã€Local Memory æ˜¯ç‰‡å¤–ï¼ˆoff-chipï¼‰å­˜å‚¨å™¨ï¼ŒShared Memory å’Œ Register å±äºç‰‡å†…ï¼ˆon-chipï¼‰å­˜å‚¨å™¨ã€‚ä¸åŒå±‚æ¬¡çš„æ˜¾å­˜è®¿é—®å»¶è¿Ÿä¸åŒï¼Œä»¥ PCIE 80GB çš„ H800ä¸ºä¾‹ï¼Œå…¶ Global Memory çš„è®¿é—®å»¶è¿Ÿçº¦ä¸º 478 ä¸ªæ—¶é’Ÿå‘¨æœŸï¼ŒShared Memory çš„è®¿é—®å»¶è¿Ÿçº¦ä¸º 30 ä¸ªæ—¶é’Ÿå‘¨æœŸï¼ŒRegister çº¦ä¸º 1 ä¸ªæ—¶é’Ÿå‘¨æœŸã€‚ç”±äºä¸åŒçš„å­˜å‚¨å™¨è®¿é—®å»¶è¿Ÿå·®è·è¾ƒå¤§ï¼Œå¦‚æœæˆ‘ä»¬åœ¨ç¼–ç¨‹çš„æ—¶å€™å¯ä»¥åˆ©ç”¨ç‰‡å†…å­˜å‚¨å™¨é™ä½è®¿é—®å»¶è¿Ÿï¼Œå°±å¯ä»¥æå‡ Kernel çš„æ€§èƒ½ã€‚åº†å¹¸çš„æ˜¯ï¼Œåœ¨ GPU ç¼–ç¨‹ä¸­ï¼ŒCUDA ä¸º Shared Memory æä¾›ç¼–ç¨‹æ¥å£ï¼Œè¿™ä½¿å¾—å¼€å‘è€…åœ¨è®¾è®¡ Kernel å®ç°æ—¶ï¼Œå¯ä»¥åˆ©ç”¨ Shared Memory è®¿é—®å»¶è¿Ÿä½çš„ç‰¹ç‚¹åŠ é€Ÿ Kernel çš„æ€§èƒ½ã€‚æ‰€ä»¥åœ¨ GPU ç¼–ç¨‹ä¸­ï¼ŒKernel çš„è®¾è®¡æ˜¯ä»¥ Thread Block è¿™ä¸ªç²’åº¦å±•å¼€çš„ã€‚ä½†è¿™æ ·ä¼šå¯¼è‡´ä¸¤ä¸ªé—®é¢˜ï¼š</p>
<p>1.<strong>å•ä¸ª Thread Block å¤„ç†çš„æ•°æ®è§„æ¨¡æœ‰é™</strong> ï¼ŒåŸå› æ˜¯ Shared Memory çš„å®¹é‡æœ‰é™ã€‚è¿˜æ˜¯ä»¥ PCIE 80GB çš„ H800ä¸ºä¾‹ï¼Œå…¶Global Memory å¤§å°ä¸º 80GBï¼Œè€Œæ¯ä¸ª Thread Block æœ€å¤§å¯ç”¨ Shared Memory ä»… 227 KBã€‚è¿™ä½¿å¾—å•ä¸ª Thread Block ä¸ºäº†ä½¿ç”¨ Shared MemoryåŠ é€Ÿæ€§èƒ½æ—¶ï¼Œåªèƒ½å¤„ç†ä¸€ä¸ªæ•°æ®è§„æ¨¡è¾ƒå°çš„å­ä»»åŠ¡ã€‚ä»»åŠ¡è§„æ¨¡ä¸€æ—¦å˜å¤§ï¼ŒShared Memory ä¸å¤Ÿç”¨ï¼ŒThread Block å°±åªèƒ½ç”¨é«˜è®¿é—®å»¶è¿Ÿçš„ Global Memory å®Œæˆä»»åŠ¡ï¼Œå¯¼è‡´ Kernel æ€§èƒ½é™ä½ã€‚</p>
<p>2.<strong>SM åˆ©ç”¨ç‡è¾ƒä½</strong> ã€‚å•ä¸ª Thread Block å¯é…ç½®çš„æœ€å¤§çº¿ç¨‹æ•°ä¸º 1024ï¼Œæ¯ä¸ª Thread Block ä¼šåˆ†é…åˆ°ä¸€ä¸ª SM ä¸Šè¿è¡Œã€‚å‡å¦‚æ¯ä¸ª Thread Block å¤„ç†è¾ƒå¤§è§„æ¨¡çš„æ•°æ®ã€è®¡ç®—ï¼ŒKernel ä¸€æ¬¡ä»…å‘å°„å¾ˆå°‘çš„ Thread Blockï¼Œå¯èƒ½å¯¼è‡´æŸäº› SM å¤„äºç©ºé—²çŠ¶æ€ï¼Œè®¡ç®—èµ„æºæ²¡æœ‰è¢«å……åˆ†æŒ–æ˜ï¼Œè¿™æ ·åŒæ ·ä¼šé™åˆ¶ Kernel çš„æ•´ä½“æ€§èƒ½ã€‚ä¾‹å¦‚åœ¨ LLM é•¿æ–‡æœ¬æ¨ç† è¿›è¡Œ Decoding Attentionæ—¶ï¼Œ ğ¾ã€ğ‘‰ é•¿åº¦è¾ƒé•¿ï¼Œæ­¤æ—¶ç”±äºæ˜¾å­˜ä¸Šé™é—®é¢˜ï¼Œ batch size ä¼šå°ï¼Œè¿™å¯¼è‡´å•ä¸ª Thread Block è®¿é—®çš„æ•°æ®é‡ã€è®¡ç®—é‡è¾ƒå¤§ï¼ŒåŒæ—¶å‘å°„çš„ Thread Block çš„æ•°é‡è¾ƒå°‘ï¼Œå¯¼è‡´æŸäº› SM å¤„äºç©ºé—²çŠ¶æ€ï¼Œé™åˆ¶ Kernel æ€§èƒ½ã€‚</p>
<p>æŒ‰ Thread Block è¿™ä¸ªç²’åº¦åˆ’åˆ†å­ä»»åŠ¡å·²ç»éš¾ä»¥å¤„ç†ä¸€äº›åœºæ™¯ï¼Œé™åˆ¶äº† Kernel è¿è¡Œæ•ˆç‡ã€‚è§£å†³è¿™ä¸ªé—®é¢˜çš„æœ€ç›´æ¥çš„æ–¹å¼æ˜¯ï¼šæä¾›æ›´å¤§ç²’åº¦çš„çº¿ç¨‹ç»„ã€‚</p>
<h4 id="12-thread-block-clusters">1.2 Thread Block Clusters</h4>
<p>ä¸ºäº†è§£å†³ Thread Block ç²’åº¦è¿‡å°å¯¼è‡´çš„ Kernel è¿è¡Œæ•ˆç‡ä¸è¶³çš„é—®é¢˜ï¼ŒHooper åœ¨ Thread Block ä¹‹ä¸Šå†å¼•å…¥ä¸€å±‚ç»“æ„â€”â€”Thread Block Clustersã€‚</p>
<p><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/mmbiz_jpg/yXChImmsky9Rm1NBP69PH2pzKNpGp4ZQ50mInguW2sM39eMebiascfnWVibf5VhSaQbfYYClJcB1musdCk6baBjw/640?wx_fmt=other&amp;from=appmsg" alt=""></p>
<p>ä¸€ä¸ª Thread Block Cluster ç”±è‹¥å¹²ä¸ªçº¿ç¨‹å—æ„æˆï¼Œå…¶çº¿ç¨‹å—çš„æ•°é‡ç§°ä¸º Cluster Sizeï¼Œç›®å‰ Hopper æ¶æ„é€šç”¨çš„æœ€å¤§ Cluster Size ä¸º 8ï¼Œå³ä¸€ä¸ª Thread Block Cluster æœ€å¤šç”± 8 ä¸ª Thread Block ç»„æˆã€‚è€Œ H100 æœ‰ç‚¹ç‰¹æ®Šï¼ˆæ¯•ç«Ÿå¾ˆè´µï¼‰ï¼Œå…¶æœ€å¤§çš„ Cluster Size ä¸º 16ã€‚Thread Block Cluster æ‰€æœ‰çº¿ç¨‹å¯ä»¥è®¿é—®åˆ†å¸ƒåœ¨ä¸åŒçº¿ç¨‹å—çš„Shared Memoryï¼Œè¿™ç§ Shared Memory ç§°ä¸º Distributed Shared Memoryï¼Œå…¶å¯¹åº”çš„åœ°å€ç©ºé—´ç§°ä¸º Distributed Shared Memory åœ°å€ç©ºé—´ã€‚Distributed Shared Memory å¹¶ä¸æ˜¯ä¸€ç§æ–°å¢çš„æ–°å‹å­˜å‚¨å™¨ï¼Œè€Œæ˜¯ä¸€ç§ Shared Memory çš„â€œé›†åˆâ€ï¼Œå…¶ç©ºé—´å¤§å°ç­‰äºæ‰€æœ‰ Thread Block çš„ Shared Memory å¤§å°æ€»å’Œã€‚ç”±äº Thread Block Cluster ä¸­ä¸åŒçš„ Thread Block å¯èƒ½æ”¾åœ¨ä¸åŒçš„ SM ä¸Šï¼ŒL1 Cache æ˜¯æ¯ä¸ª SM ç‹¬æœ‰çš„ï¼Œä¸€ä¸ª SM æ— æ³•è®¿é—®å¦ä¸€ä¸ª SM çš„ L1 Cacheï¼Œæ‰€ä»¥ Distributed Shared Memory éœ€è¦ä½¿ç”¨æ‰€æœ‰ SM éƒ½èƒ½è®¿é—®çš„é«˜æ•ˆå­˜å‚¨å™¨ã€‚L2 Cache æ˜¯æ‰€æœ‰ SM å‡å¯è®¿é—®ï¼Œè€Œ Distributed Shared Memory ä»…éœ€è¦ä¿è¯ä¸€ä¸ª Cluster å†…éƒ¨çš„ SM å¯ä»¥è®¿é—®å³å¯ï¼Œé‚£ä¹ˆ Hopper æ˜¯å¦å­˜åœ¨ä¸€å±‚å­˜å‚¨å™¨æ”¯æŒ Cluster å†…éƒ¨çš„æ‰€æœ‰ SM å¯ä»¥è®¿é—®ï¼Ÿç­”æ¡ˆæ˜¯å¯ä»¥çš„ã€‚Hopper æ¶æ„åœ¨ Cluster å†…éƒ¨ï¼Œä½äº L1 å’Œ L2 Cache ä¹‹é—´æ–°å¢äº†ä¸€å±‚SM-to-SM Networkã€‚Thread Block Cluster å†…éƒ¨çš„ SM å¯ä»¥é€šè¿‡è¯¥å±‚ç½‘ç»œè®¿é—®å…¶ä»– SM çš„ Shared Memoryã€‚åœ¨è½¯ä»¶å±‚ï¼ŒCUDA ä¸º Distributed Shared Memory æä¾›äº†è®¿é—®çš„ç¼–ç¨‹æ¥å£ä»¥åŠæ•´ä¸ª Thread Block Cluster çš„åŒæ­¥æ¥å£ï¼Œåé¢ä¼šæåˆ°ã€‚Hooper é€šè¿‡å¼•å…¥ Thread Block Clusterï¼Œå¼€å‘è€…å¯ä»¥å°†ä¸€ä¸ªå­ä»»åŠ¡çš„æ•°æ®è§„æ¨¡ Scale åˆ° Cluster Size å€ï¼Œå¤§å¤§å¢åŠ äº†å­ä»»åŠ¡çš„å¤„ç†èƒ½åŠ›ä»¥åŠ SM åˆ©ç”¨ç‡ã€‚</p>
<p><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/mmbiz_jpg/yXChImmsky9Rm1NBP69PH2pzKNpGp4ZQ9sJaQibZfgbIBm1TmHibPgpRVNjcrYPyOuRF386heNk9ak3HuI3rhnJA/640?wx_fmt=other&amp;from=appmsg" alt=""></p>
<h4 id="2-distributed-shared-memory-ç”¨æ³•">2. Distributed Shared Memory ç”¨æ³•</h4>
<p>æœ¬èŠ‚ä¸»è¦ä»‹ç»å¦‚ä½•åœ¨ CUDA Kernel ä¸­ä½¿ç”¨ Distributed Shared Memoryã€‚Distributed Shared Memory çš„ä½¿ç”¨ä¸»è¦å…³æ³¨ä»¥ä¸‹ä¸¤ç‚¹ï¼š</p>
<ol>
<li>
<p>Distributed Shared Memory è®¿é—®æ–¹å¼ï¼šæ€ä¹ˆæ‹¿åˆ°å…¶ä»– Thread Block çš„ Shared Memoryï¼Ÿ</p>
</li>
<li>
<p>Cluster åŒæ­¥æ–¹å¼ï¼šæ€æ ·ä¿è¯å½“å‰çº¿ç¨‹è®¿é—®çš„ Distributed Shared Memory æ˜¯åˆæ³•çš„ï¼ˆå·²åˆå§‹åŒ–ã€æœªè¢«é”€æ¯çš„ï¼‰ï¼Ÿ</p>
</li>
</ol>
<p>ä¸‹é¢å°†é€šè¿‡ä¸€ä¸ªå®˜æ–¹æä¾›çš„ç›´æ–¹å›¾ç»Ÿè®¡ç¤ºä¾‹ï¼Œè®²è§£è¿™ä¸¤ç‚¹çš„ä½¿ç”¨æ–¹å¼ã€‚</p>
<h4 id="21-å¸¸è§„ä½¿ç”¨">2.1 å¸¸è§„ä½¿ç”¨</h4>
<pre><code>#include &lt;cooperative_groups.h&gt;  
  
// Distributed Shared memory histogram kernel  
__global__ void clusterHist_kernel(int *bins, const int nbins,  
                                   const int bins_per_block,  
                                   const int *__restrict__ input,  
                                   size_t array_size)  
{  
  extern __shared__ int smem[];  
  namespace cg = cooperative_groups;  
  int tid = cg::this_grid().thread_rank();  
  
  // è·å–å½“å‰ cluster ä¿¡æ¯  
  cg::cluster_group cluster = cg::this_cluster();  
  unsigned int clusterBlockRank = cluster.block_rank();  
  int cluster_size = cluster.dim_blocks().x;  
  
  for (int i = threadIdx.x; i &lt; bins_per_block; i += blockDim.x) {  
    // åˆå§‹åŒ–ç›´æ–¹å›¾æ¯ä¸ªbinçš„å€¼  
    smem[i] = 0; //Initialize shared memory histogram to zeros  
  }  
  
  // Cluster åŒæ­¥ï¼Œç±»ä¼¼ Thread Block çš„ __syncthreads()ã€‚è¯¥è°ƒç”¨ä¿è¯æ•´ä¸ª Cluster çš„  
  // çº¿ç¨‹éƒ½ä¼šåœ¨è¿™ä¸ªç‚¹åŒæ­¥ã€‚è¿™ä¸ªåŒæ­¥ç‚¹ç›®æ ‡æ˜¯ä¿è¯ cluster ä¸­æ‰€æœ‰ Thread Block çš„ smem éƒ½  
  // å®Œæˆåˆå§‹åŒ–ï¼Œå¯ä»¥å¼€å§‹è¿è¡Œåé¢çš„å¤„ç†é€»è¾‘ã€‚  
  cluster.sync();  
  
  for (int i = tid; i &lt; array_size; i += blockDim.x * gridDim.x)  
  {  
    int ldata = input[i];  
  
    //Find the right histogram bin.  
    int binid = ldata;  
    if (ldata &lt; 0)  
      binid = 0;  
    else if (ldata &gt;= nbins)  
      binid = nbins - 1;  
  
    int dst_block_rank = (int)(binid / bins_per_block);  
    int dst_offset = binid % bins_per_block;  
  
    // é‡ç‚¹ï¼šmap_shared_rank ä¸»è¦ç”¨äºè·å–å…¶ä»– Thread Block çš„ Shared Memory åœ°å€  
    int *dst_smem = cluster.map_shared_rank(smem, dst_block_rank);  
  
    // æ›´æ–°ç›´æ–¹å›¾ bin çš„ç»Ÿè®¡æ•°å­—  
    atomicAdd(dst_smem + dst_offset, 1);  
  }  
  
  // è¿™ä¸ªåŒæ­¥ç‚¹ç›®æ ‡æ˜¯ä¿è¯ cluster ä¸­æ‰€æœ‰ Thread Block çš„ smem éƒ½å¤„äºå¯ç”¨çš„çŠ¶æ€ã€‚  
  // å¦‚æœä¸åŒæ­¥ï¼Œå¯èƒ½éƒ¨åˆ† Thread Block æå‰ç»“æŸè¿è¡Œï¼Œå¯¹åº”çš„ smem ä¹Ÿè¢«é”€æ¯ï¼Œè¿™æ—¶æœªé€€å‡ºçš„  
  // Thread Block æœ‰å¯èƒ½è®¿é—®å·²é€€å‡ºçš„ Thread Block å¯¹åº”çš„ smemï¼Œå‡ºç°éæ³•å†…å­˜è®¿é—®ï¼Œ  
  // ä¼šé€ æˆç¨‹åºå´©æºƒ  
  cluster.sync();   
  
  int *lbins = bins + cluster.block_rank() * bins_per_block;  
  for (int i = threadIdx.x; i &lt; bins_per_block; i += blockDim.x)  
  {  
    atomicAdd(&amp;lbins[i], smem[i]);  
  }  
}  
</code></pre>
<p>åœ¨ç¼–å†™ Thread Block Cluster çš„ Kernel æ—¶ï¼Œæˆ‘ä»¬éœ€è¦ç”¨åˆ° CUDA æä¾›çš„ Cooperative Groups æ¨¡å—ã€‚è¯¥æ¨¡å—ç»™æˆ‘ä»¬æä¾›è®¿é—® Cluster çš„æ¥å£ã€‚ä¸Šè¿°ä»£ç ä¹Ÿæ˜¯åŸºäº Cooperative Groups æ¨¡å—çš„æ¥å£å®Œæˆ Thread Block Cluster çš„åŒæ­¥ã€Distributed Shared Memory çš„è®¿é—®ã€‚Cluster Kernel ä¸»è¦æœ‰ä¸‰ä¸ªå…³é”®æ¥å£éœ€è¦é‡ç‚¹è®²è§£ï¼š</p>
<ul>
<li>
<p>cg::this_cluster()ï¼šè·å–å½“å‰ clusterã€‚è¿™æ˜¯å®ç° Thread Block Cluster Kernel çš„å‰ç½®æ­¥éª¤ï¼Œéœ€è¦åœ¨åˆå§‹åŒ–é˜¶æ®µå°±è®©çº¿ç¨‹è·å–å½“å‰ cluster å¯¹è±¡ï¼Œä»¥å®ç° Distributed Shared Memory çš„è®¿é—®ä»¥åŠ Cluster çº§åˆ«çš„åŒæ­¥ã€‚</p>
</li>
<li>
<p>cluster.map_shared_rank(void *smem, int rank)ï¼šä¸»è¦ç”¨äºè·å–å…¶ä»– Thread Block çš„ Shared Memory åœ°å€ï¼Œé€šè¿‡è¯¥è°ƒç”¨å®ç° Distributed Shared Memmory çš„è®¿é—®ã€‚ç¬¬ä¸€ä¸ªå‚æ•°ä¼ é€’å½“å‰ Thread Block çš„ Shared Memory åœ°å€ï¼Œç¬¬äºŒä¸ªå‚æ•°ä¸ºç›®æ ‡ Thread Block çš„ä¸‹æ ‡åœ°å€ã€‚</p>
</li>
<li>
<p>cluster.sync()ï¼šè´Ÿè´£æ•´ä¸ª Thread Block Cluster æ‰€æœ‰çº¿ç¨‹çš„åŒæ­¥æ“ä½œã€‚åŒæ­¥å¼€é”€æˆæœ¬è¾ƒé«˜ï¼Œæ¯”ä¸€èˆ¬çš„ __syncthreads()è¦æ›´é«˜ã€‚</p>
</li>
</ul>
<p>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œä¸Šè¿°ä»£ç æœ‰ä¸¤å¤„ cluster.sync æ“ä½œã€‚ç¬¬ä¸€ä¸ª cluster.sync ä¸ä¸€èˆ¬çš„ Thread Block Kernel ä¸€æ ·ï¼Œåœ¨åˆå§‹åŒ– Shared Memory çš„æ—¶å€™éœ€è¦åŒæ­¥ï¼Œä¿è¯æ‰€æœ‰çº¿ç¨‹å®Œæˆ Shared Memory çš„åˆå§‹åŒ–ï¼›è€Œç¬¬äºŒä¸ª cluster.sync åˆ™ä¸åŒï¼Œæ˜¯ç”¨äºä¿è¯å½“å‰ Thread Block çš„ Shared Memory çš„å¯ç”¨æ€§ã€‚ç”±äºä¸åŒ Thread Block è¿è¡Œé€Ÿåº¦ä¸ä¸€æ ·ï¼Œå¦‚æœä¸åŠ å…¥ cluster.sync åŒæ­¥ï¼Œéƒ¨åˆ† Thread Block å¯èƒ½æå‰ç»“æŸè¿è¡Œï¼Œé€€å‡ºçš„ Thread Block å¯¹åº”çš„ Shared Memory ä¹Ÿä¼šè¢«é”€æ¯ï¼Œè¿™æ ·æœªé€€å‡ºçš„ Thread Block æœ‰å¯èƒ½è®¿é—®åˆ°è¿™äº›è¢«é”€æ¯çš„ Shared Memoryï¼Œä»è€Œå¯¼è‡´ç¨‹åºå´©æºƒã€‚ç¬¬äºŒä¸ª cluster.sync ç®—æ˜¯ Thread Block Cluster Kernel ç‹¬æœ‰å¹¶ä¸”å¿…é¡»çš„ï¼Œä»¥å‰ Thread Block Kernel å¹¶ä¸éœ€è¦åŒæ­¥æ“ä½œä¿è¯ Shared Memory çš„å¯ç”¨æ€§ã€‚æ‰€ä»¥ï¼Œä¸€ä¸ª Thread Block Cluster Kernel çš„å®ç°èŒƒå¼å¦‚ä¸‹ï¼š</p>
<pre><code>#include &lt;cooperative_groups.h&gt;  
namespace cg = cooperative_groups;  
__global__ void cluster_kernel() {  
    auto cluster = cg::this_cluster();  
    extern __shared__ int shm[];  
    // åˆå§‹åŒ– ...   
    init_local_shared_data(shm);  
    // ä¿è¯åˆå§‹åŒ–å®Œæˆ  
    cluster.sync();  
    // ...  
    // è·å– Distributed Shared Memory åœ°å€  
    int *dsmem = cluster.map_shared_rank(&amp;shm[0], some_rank);  
    // å¤„ç† Distributed Shared Memory  
    process_shared_data(dsmem);  
    // ä¿è¯ Shared Memory å¯ç”¨ï¼Œé¿å…å…¶ä»– Thread Block è®¿é—®  
    // å½“å‰ Thread Block çš„ Shared Memory å¤±è´¥  
    cluster.sync();  
}  
</code></pre>
<h4 id="22-kernel-launch-æ–¹å¼">2.2 Kernel Launch æ–¹å¼</h4>
<p>ç”±äºä¼ ç»Ÿçš„ Kernel Lauch æ— æ³•ä¼ é€’ Cluster Size è¿™ä¸ªå‚æ•°ï¼Œæ‰€ä»¥ Thread Block Cluster Kernel çš„ Launch æ–¹å¼ä¸èƒ½ä½¿ç”¨ä¼ ç»Ÿçš„ Kernel Lauch æ–¹å¼( kernel&laquo;&lt;&hellip;&raquo;&gt;() ) ã€‚Thread Block Cluster Kernel éœ€è¦ä½¿ç”¨ cudaLaunchKernelEx è¿™ä¸ªå‡½æ•°ï¼Œé€šè¿‡è®¾ç½® cudaLaunchConfig_t ä»¥åŠ cudaLaunchAttribute è®¾ç½® gridã€block ä»¥åŠ cluster é…ç½®ã€‚ä»¥ä¸‹æ˜¯ Thread Block Cluster Kernel çš„ Lauch ç¤ºä¾‹ã€‚</p>
<pre><code>// Launch via extensible launch  
{  
  cudaLaunchConfig_t config = {0};  
  config.gridDim = array_size / threads_per_block;  
  config.blockDim = threads_per_block;  
  
  // cluster_size depends on the histogram size.  
  // ( cluster_size == 1 ) implies no distributed shared memory, just thread block local shared memory  
  int cluster_size = 2; // size 2 is an example here  
  int nbins_per_block = nbins / cluster_size;  
  
  //dynamic shared memory size is per block.  
  //Distributed shared memory size =  cluster_size * nbins_per_block * sizeof(int)  
  config.dynamicSmemBytes = nbins_per_block * sizeof(int);  
  
  CUDA_CHECK(::cudaFuncSetAttribute((void *)clusterHist_kernel, cudaFuncAttributeMaxDynamicSharedMemorySize, config.dynamicSmemBytes));  
  
  cudaLaunchAttribute attribute[1];  
  attribute[0].id = cudaLaunchAttributeClusterDimension;  
  attribute[0].val.clusterDim.x = cluster_size;  
  attribute[0].val.clusterDim.y = 1;  
  attribute[0].val.clusterDim.z = 1;  
  
  config.numAttrs = 1;  
  config.attrs = attribute;  
  
  cudaLaunchKernelEx(&amp;config, clusterHist_kernel, bins, nbins, nbins_per_block, input, array_size);  
}  
</code></pre>
<h4 id="23-åŒæ­¥ä¼˜åŒ–">2.3 åŒæ­¥ä¼˜åŒ–</h4>
<p>ä¸Šæ–‡æåˆ°ï¼Œcluster.sync() è´Ÿè´£æ•´ä¸ª Thread Block Cluster æ‰€æœ‰çº¿ç¨‹çš„åŒæ­¥æ“ä½œï¼ŒåŒæ­¥å¼€é”€æ¯”ä¸€èˆ¬çš„ __syncthreads()è¦æ›´é«˜ã€‚å½“å‰çº¿ç¨‹åœ¨è°ƒç”¨ cluster.sync() åï¼Œéœ€è¦ç­‰å¾…æ‰€æœ‰çº¿ç¨‹è°ƒç”¨è¯¥æ¥å£ï¼Œæ‰èƒ½ç»§ç»­è¿è¡Œã€‚æˆ‘ä»¬çŸ¥é“ï¼Œ cluster.sync() çš„ç›®çš„ä¸»è¦æ˜¯å®Œæˆ Shared Memory çš„åˆå§‹åŒ–æˆ–è€…ä¿è¯ Thread Blockä¸æå‰é€€å‡ºã€‚å¦‚æœå…è®¸æˆ‘ä»¬åœ¨ç­‰å¾…æœŸé—´å®Œæˆä¸€äº›ä¸ Shared Memory æ— å…³çš„æ“ä½œï¼Œè¿™æ ·å°±å¯ä»¥æ©ç›–äº† cluster.sync() çš„éƒ¨åˆ†å»¶è¿Ÿï¼Œä»è€Œæå‡æ€§èƒ½ã€‚è¿™æ ·å°±éœ€è¦ CUDA æä¾›æ‹†åˆ† cluster.sync() çš„èƒ½åŠ›ï¼Œå°† cluster.sync() æ‹†åˆ†æˆä¸¤ä¸ªé˜¶æ®µï¼šåŒæ­¥ç‚¹ä¸ç­‰å¾…ç‚¹ã€‚åœ¨åŒæ­¥ç‚¹ä¸ç­‰å¾…ç‚¹ä¹‹é—´ï¼Œå¯ä»¥æ’å…¥ä¸ Shared Memory æ— å…³çš„æ“ä½œã€‚CUDA æä¾›äº†ä»¥ä¸‹ä¸¤ä¸ªæ¥å£å®ç° cluster.sync() æ‹†åˆ†çš„èƒ½åŠ›ï¼š</p>
<ul>
<li>
<p>arrival_token cluster.barrier_arrive()ï¼šè®¾ç½®åŒæ­¥ç‚¹ï¼Œè¿”å›åŒæ­¥ç‚¹æ ‡è®° tokenã€‚</p>
</li>
<li>
<p>cluster.barrier_wait(arrival_token&amp;&amp; token): è®¾ç½®ç­‰å¾…ç‚¹ï¼Œè¾“å…¥ä¸ºåŒæ­¥ç‚¹æ ‡è®° tokenã€‚å½“ Thread Block Cluster ä¸­æ‰€æœ‰çº¿ç¨‹éƒ½ç»“æŸ barrier_arrive è°ƒç”¨åï¼Œç­‰å¾… barrier_wait çš„çº¿ç¨‹å°±å¯ä»¥ç»“æŸç­‰å¾…ï¼Œç»§ç»­è¿è¡Œã€‚</p>
</li>
</ul>
<p>åœ¨è¿™ä¸¤ä¸ªæ ‡è®°ç‚¹ä¸­é—´å¯ä»¥æ’å…¥ä¸€äº›ä¸ Distributed Shared Memory æ— å…³çš„æ“ä½œï¼Œæ©ç›– barrier_arrive çš„åŒæ­¥å»¶è¿Ÿã€‚ä»¥ä¸‹æ˜¯ä½¿ç”¨è¿™ä¸¤ä¸ªæ¥å£çš„ç¤ºä¾‹ä»£ç ã€‚</p>
<pre><code>#include &lt;cooperative_groups.h&gt;  
  
using namespace cooperative_groups;  
  
void __device__ init_shared_data(const thread_block&amp; block, int *data);  
void __device__ local_processing(const thread_block&amp; block);  
void __device__ process_shared_data(const thread_block&amp; block, int *data);  
  
__global__ void cluster_kernel() {  
    extern __shared__ int array[];  
    auto cluster = this_cluster();  
    auto block   = this_thread_block();  
  
    // Use this thread block to initialize some shared state  
    init_shared_data(block, &amp;array[0]);  
  
    auto token = cluster.barrier_arrive(); // Let other blocks know this block is running and data was initialized  
  
    // Do some local processing to hide the synchronization latency  
    local_processing(block);  
  
    // Map data in shared memory from the next block in the cluster  
    int *dsmem = cluster.map_shared_rank(&amp;array[0], (cluster.block_rank() + 1) % cluster.num_blocks());  
  
    // Make sure all other blocks in the cluster are running and initialized shared data before accessing dsmem  
    cluster.barrier_wait(std::move(token));  
  
    // Consume data in distributed shared memory  
    process_shared_data(block, dsmem);  
    cluster.sync();  
}  
</code></pre>
<p>ä¸Šè¿°ä»£ç ä¸­ï¼Œåœ¨ cluster.barrier_arrive() å’Œ cluster.barrier_wait(std::move(token)) ä¹‹é—´æ’å…¥äº† local_processing å’Œ map_shared_rankï¼Œè¿™ä¸¤ä¸ªè°ƒç”¨ä¸æ¶‰åŠ Shared Memory å†™æ“ä½œï¼Œä¸ä¼šå½±å“å…¶ä»– Thread Block çš„ process_shared_dataï¼Œå¯ä»¥ overlap æ‰éƒ¨åˆ† cluster.sync() åŒæ­¥çš„å¼€é”€ã€‚</p>
<h4 id="3-æ€»ç»“">3. æ€»ç»“</h4>
<p>æœ¬æ–‡ä¸»è¦ä»‹ç»äº† Hopper æ¶æ„çš„æ–°ç‰¹æ€§â€”â€”Distributed Shared Memory &amp; Thread Block Clustersï¼Œå¹¶ä»‹ç»äº†åœ¨ CUDA ä¸Šå¦‚ä½•ä½¿ç”¨ Distributed Shared Memoryã€‚åœ¨ä¸€äº›å¯¹ Shared Memoryéœ€æ±‚æ¯”è¾ƒå¤§ã€å•ä¸ª Thread Block çš„ workload è¾ƒå¤§ä¸”SMåˆ©ç”¨ç‡è¾ƒä½çš„åœºæ™¯ä¸‹ï¼ŒDistributed Shared Memory &amp; Thread Block Clusters æ˜¯ä¸ªæ¯”è¾ƒå¥½çš„ä¼˜åŒ–é€‰é¡¹ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œæˆ‘ä¸ªäººè§‰å¾— GEMM SplitK ç±»ï¼ˆåŒ…æ‹¬ Flash Decodingï¼‰ç®—å­æ¯”è¾ƒé€‚åˆä½¿ç”¨ Distributed Shared Memory åšä¼˜åŒ–ã€‚Flash Decoding Kernel å¯ä»¥æŠŠå½“å‰ Thread Block çš„ Online Softmax å±€éƒ¨çŠ¶æ€ä¿¡æ¯æ”¾åˆ° Share Memory ä¸­ï¼Œç„¶ååŒæ­¥ Thread Block Clusterï¼Œå°† Cluster ä¸­æ¯ä¸ª Thread Block çš„çŠ¶æ€åˆå¹¶ï¼Œå¾—åˆ°æœ€ç»ˆç»“æœã€‚è¿™æ ·å¯ä»¥é™ä½ Flash Decoding Kernel çš„è¾“å‡ºè®¿å­˜å¼€é”€ã€Reduce Kernel çš„è¾“å…¥è®¿å­˜å¼€é”€ä»¥åŠ Launch å¼€é”€ï¼Œä»è€Œæå‡ Kernel æ€§èƒ½ã€‚</p>
<p>æ›´å¤šAIå·¥å…·ï¼Œå‚è€ƒ<a href="https://aibard123.com/">Github-AiBard123</a>ï¼Œ<a href="https://aibard123.com/">å›½å†…AiBard123</a></p>



          </div>

å¯å…³æ³¨æˆ‘ä»¬çš„å…¬ä¼—å·ï¼šæ¯å¤©AIæ–°å·¥å…·

<p><img src="/images/aitools/2024/03/qrcode_for_gh_dde1b429630d_258.jpg" alt=""></p>

        </article>

      </div>
    </div>
  </div>
</section>
        </div>
    </div>
    </main>




<script type='text/javascript' src='/assets/js/jquery.ui.touch-punch.min-0.2.2.js' id='jqueryui-touch-js'></script>
<script type='text/javascript' src='/assets/js/clipboard.min-5.6.2.js' id='clipboard-js'></script>
<script type='text/javascript' src='/assets/js/tooltip-extend.js' id='iplaycode-nav-js'></script>
<script type='text/javascript' id='popper-js-extra'>
 

var theme = {"ajaxurl":"","addico":"https:\/\/nav.baidu.cn\/wp-content\/themes\/onenav\/images\/add.png","order":"asc","formpostion":"top","defaultclass":"io-grey-mode","isCustomize":"1","icourl":"","icopng":".png","urlformat":"1","customizemax":"10","newWindow":"0","lazyload":"1","minNav":"1","loading":"1","hotWords":"baidu","classColumns":" col-sm-6 col-md-4 col-xl-5a col-xxl-6a ","apikey":"TWpBeU1UVTNOekk1TWpVMEIvZ1M2bFVIQllUMmxsV1dZelkxQTVPVzB3UW04eldGQmxhM3BNWW14bVNtWk4="};
 
</script>
<script type='text/javascript' src='/assets/js/popper.min.js' id='popper-js'></script>
<script type='text/javascript' src='/assets/js/bootstrap.min-4.3.1.js' id='bootstrap-js'></script>
<script type='text/javascript' src='/assets/js/theia-sticky-sidebar-1.5.0.js' id='sidebar-js'></script>
<script type='text/javascript' src='/assets/js/lazyload.min-12.4.0.js' id='lazyload-js'></script>
<script type='text/javascript' src='/assets/js/fancybox.min-3.5.7.js' id='lightbox-js-js'></script>

<script type='text/javascript' src='/assets/js/app-anim.js' id='appanim-js'></script>

<script type="text/javascript">
    $(document).ready(function(){
        var siteWelcome = $('#loading');
        siteWelcome.addClass('close');
        setTimeout(function() {
            siteWelcome.remove();
        }, 600);
    });
</script>
<script>        
    $(document).ready(function(){
        setTimeout(function () {
            if ($('a.smooth[href="' + window.location.hash + '"]')[0]) {
                $('a.smooth[href="' + window.location.hash + '"]').click();
            }else if (window.location.hash != '') {
                $("html, body").animate({
                    scrollTop: $(window.location.hash).offset().top - 90
                }, {
                    duration: 500,
                    easing: "swing"
                });
            }
        }, 300);
        $(document).on('click','a.smooth',function(ev) {
            if($('#sidebar').hasClass('show') && !$(this).hasClass('change-href')){
                $('#sidebar').modal('toggle');
            }
            if($(this).attr("href").substr(0, 1) == "#"){
                $("html, body").animate({
                    scrollTop: $($(this).attr("href")).offset().top - 90
                }, {
                    duration: 500,
                    easing: "swing"
                });
            }
            if($(this).hasClass('go-search-btn')){
                $('#search-text').focus();
            }
            if(!$(this).hasClass('change-href')){
                var menu =  $("a"+$(this).attr("href"));
                menu.click();
                toTarget(menu.parent().parent(),true,true);
            }
        });
        $(document).on('click','a.tab-noajax',function(ev) {
            var url = $(this).data('link');
            if(url)
                $(this).parents('.d-flex.flex-fill.flex-tab').children('.btn-move.tab-move').show().attr('href', url);
            else
                $(this).parents('.d-flex.flex-fill.flex-tab').children('.btn-move.tab-move').hide();
        });
        
    });
</script>

<script>

(function(){
    if(document.cookie.replace(/(?:(?:^|.*;\s*)night\s*\=\s*([^;]*).*$)|^.*$/, "$1") === ''){
        if(new Date().getHours() > 22 || new Date().getHours() < 6){
            document.body.classList.remove('io-black-mode');
            document.body.classList.add('io-grey-mode');
            document.cookie = "night=1;path=/";
            console.log('å¤œé—´æ¨¡å¼å¼€å¯');
        }else{
            document.body.classList.remove('night');
            document.cookie = "night=0;path=/";
            console.log('å¤œé—´æ¨¡å¼å…³é—­');
        }
    }else{
        var night = document.cookie.replace(/(?:(?:^|.*;\s*)night\s*\=\s*([^;]*).*$)|^.*$/, "$1") || '0';
        if(night == '0'){
            document.body.classList.remove('night');
        }else if(night == '1'){
            document.body.classList.add('night');
        }
    }
})();

$("#search-bg").css("background", "linear-gradient(#e2c4c4, #d8d8d8)");   
function switchNightMode(){
    var night = document.cookie.replace(/(?:(?:^|.*;\s*)night\s*\=\s*([^;]*).*$)|^.*$/, "$1") || '0';
    if(night == '0'){
	$("#search-bg").css("background", "linear-gradient(#e2c4c4, #d8d8d8)");
        document.body.classList.remove('io-grey-mode');
        document.body.classList.add('io-black-mode');
        document.cookie = "night=1;path=/"
        console.log(' ');
        $(".switch-dark-mode").attr("data-original-title","æ—¥é—´æ¨¡å¼");
        $(".mode-ico").removeClass("icon-night");
        $(".mode-ico").addClass("icon-light");
    }else{
	$("#search-bg").css("background", "linear-gradient(#4f4040, #1b1d1f)");
        document.body.classList.remove('io-black-mode');
        document.body.classList.add('io-grey-mode');
        document.cookie = "night=0;path=/"
        console.log(' ');
        $(".switch-dark-mode").attr("data-original-title","å¤œé—´æ¨¡å¼");
        $(".mode-ico").removeClass("icon-light");
        $(".mode-ico").addClass("icon-night");
    }
}
</script>


<script>
    var newsContainer = document.getElementById('news-container');
    var newsItems = document.getElementsByClassName('news-item');
    var currentItem = 0;

    setInterval(function() {
        
        newsItems[currentItem].classList.remove('show');
        newsItems[currentItem].style.transform = 'translateY(-20px)';
        
        currentItem = (currentItem + 1) % newsItems.length;
        newsItems[currentItem].style.transform = 'translateY(' + (newsContainer.offsetHeight - 20) + 'px)';
        setTimeout(function() {
            newsItems[currentItem].classList.add('show');
        }, 500);
    }, 8000);
</script>

</body>
</html>


