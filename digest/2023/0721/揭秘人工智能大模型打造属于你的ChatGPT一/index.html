

<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1" />
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta name="theme-color" content="#f9f9f9" />

	<title>揭秘人工智能大模型，打造属于你的ChatGPT（一） 作者： 万象新说 来源： 万象新说 点击上方蓝字关注万象新说 现在什么概念最火？一定是人工智能。不说国外的进展，国内现在已经是“百模大战”，据不完全统计，现在已有约100个公司或组织在训练和发布自己的大模型； 未来的时代，大模型也许会深刻地改变我们的生  | AiBard123| ai工具网址导航,ai最新产品</title>
	<link rel="shortcut icon" href="/assets/images/favicon.png" />
    <meta name="keywords" content="chatgpt,AI,AI聊天,AI文本生成,AI绘画,AI编程,AI电商" />
    <meta name="description" content="AiBard123 网址导航 | 免费chatgpt 汇集各类先进的人工智能产品，旨在帮助用户更快速地了解和使用这些产品,轻松地浏览不同领域的AI产品，包括语音识别、图像处理、自然语言处理。" />
    
    <meta name="baidu-site-verification" content="codeva-cCAOSG8MBO" />
    
    <link rel="stylesheet" id="block-library-css"
        href="/assets/css/block-library.min-5.6.2.css" type="text/css" media="all" />
    <link rel="stylesheet" id="iconfont-css" href="/assets/css/iconfont-3.03029.1.css"
        type="text/css" media="all" />

    
    <link href="/scss/style.min.css" rel="stylesheet" />
    
		    <link rel="stylesheet" id="iowen-css" href="/assets/css/style-3.03029.1.css"
        type="text/css" media="all" />
    <link rel="stylesheet" id="custom-css" href="/assets/css/custom-style.css"
        type="text/css" media="all" />
		
		<link rel="stylesheet" href=/plugins/font-awesome/css/font-awesome.min.css />


    <link rel="stylesheet" id="fortawesome-css" href="/assets/fontawesome-5.15.4/css/all.min.css" type="text/css" />


    <script type="text/javascript" src="/assets/js/jquery.min-3.2.1.js" id="jquery-js"></script>
    <script type="text/javascript" src="/assets/js/content-search.js"  id="content-search-js"></script>

    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2073588164294660"
     crossorigin="anonymous"></script>

	
    <script>
        

		var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?8450bc732b2a86f7e4aec4ebd9fd8252";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();

        
    </script>
    

    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-7071W80M2K"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-7071W80M2K');
    </script>

</head>


    <div class="page-container">
	
	<div id="sidebar" class="sticky sidebar-nav fade animate-nav" style="width: 170px">
        
            <div class="modal-dialog h-100 sidebar-nav-inner">
                <div class="sidebar-logo border-bottom border-color">
                    
                    <div class="logo overflow-hidden">
                        <a href="https://aibard123.com/" class="logo-expanded">
                            <img src="/assets/images/bt8-expand-light.png" height="40" class="logo-light"
                                alt="AiBard123| ai工具网址导航,ai最新产品">
                            <img src="/assets/images/bt8-expand-dark.png" height="40" class="logo-dark d-none"
                                alt="AiBard123| ai工具网址导航,ai最新产品">
                        </a>
                        <a href="https://aibard123.com/" class="logo-collapsed">
                            <img src="/assets/images/bt.png" height="40" class="logo-light"
                                alt="AiBard123| ai工具网址导航,ai最新产品">
                            <img src="/assets/images/bt.png" height="40" class="logo-dark d-none"
                                alt="AiBard123| ai工具网址导航,ai最新产品">
                        </a>
                    </div>
                    
                </div>
                <div class="sidebar-menu flex-fill">
                    <div class="sidebar-scroll">
                        <div class="sidebar-menu-inner">
                            <ul>
                                
                                    
                                    <li class="sidebar-item">
                                        <a href="/#00834a9dd147b04c5d53d4368cdb0b57" class="smooth">
                                            <i class="fas fa-sun fa-lg fa-lg icon-fw icon-lg mr-2"></i>
                                            <span>本月热门</span>
                                        </a>
                                    </li>
                                    
                                
                                    
                                    <li class="sidebar-item">
                                        <a href="/#db0311e7ecfedd24d157f0ceb4a0897f" class="smooth">
                                            <i class="fas fa-star-and-crescent fa-lg fa-lg icon-fw icon-lg mr-2"></i>
                                            <span>热门网站</span>
                                        </a>
                                    </li>
                                    
                                
                                    
                                    <li class="sidebar-item">
                                        <a href="/#21b5cbb2c769010fec3ce029a5f8a4a3" class="smooth">
                                            <i class="far fa-star fa-lg icon-fw icon-lg mr-2"></i>
                                            <span>国内热门</span>
                                        </a>
                                    </li>
                                    
                                
                                    
                                    <li class="sidebar-item">
                                        <a href="/#8310718935e8ec25ce0350de01e3f7dc" class="smooth">
                                            <i class="fas fa-phone fa-lg fa-lg icon-fw icon-lg mr-2"></i>
                                            <span>对话工具</span>
                                        </a>
                                    </li>
                                    
                                
                                    
                                    <li class="sidebar-item">
                                        <a href="/#d58e850d9115797306c2edf61ac6ddd8" class="smooth">
                                            <i class="fas fa-newspaper fa-lg fa-lg icon-fw icon-lg mr-2"></i>
                                            <span>写作</span>
                                        </a>
                                    </li>
                                    
                                
                                    
                                    <li class="sidebar-item">
                                        <a href="/#2a7418a5f8f1ca4e054364a9300657df" class="smooth">
                                            <i class="fas fa-image fa-lg fa-lg icon-fw icon-lg mr-2"></i>
                                            <span>图像生成</span>
                                        </a>
                                    </li>
                                    
                                
                                    
                                    <li class="sidebar-item">
                                        <a href="/#7808a68ee1b34dab43011429a12de19e" class="smooth">
                                            <i class="fas fa-image fa-lg fa-lg icon-fw icon-lg mr-2"></i>
                                            <span>图像处理</span>
                                        </a>
                                    </li>
                                    
                                
                                    
                                    <li class="sidebar-item">
                                        <a href="/#6729afc51f5ac49a828812fa0eb0c82f" class="smooth">
                                            <i class="fas fa-video fa-lg fa-lg icon-fw icon-lg mr-2"></i>
                                            <span>音视频</span>
                                        </a>
                                    </li>
                                    
                                
                                    
                                    <li class="sidebar-item">
                                        <a href="/#e5ce844860451fff3faf3d8f8894971d" class="smooth">
                                            <i class="fas fa-music fa-lg fa-lg icon-fw icon-lg mr-2"></i>
                                            <span>音乐生成</span>
                                        </a>
                                    </li>
                                    
                                
                                    
                                    <li class="sidebar-item">
                                        <a href="/#db53804b7d726967c58fcc8c9ca03d27" class="smooth">
                                            <i class="fas fa-language fa-lg fa-lg icon-fw icon-lg mr-2"></i>
                                            <span>办公</span>
                                        </a>
                                    </li>
                                    
                                
                                    
                                    <li class="sidebar-item">
                                        <a href="/#47b7af9547e034d28fe6f6d439968ac8" class="smooth">
                                            <i class="fas fa-copy fa-lg fa-lg icon-fw icon-lg mr-2"></i>
                                            <span>提示词</span>
                                        </a>
                                    </li>
                                    
                                
                                    
                                    <li class="sidebar-item">
                                        <a href="/#41282bf95e43c64d579757573a03cdde" class="smooth">
                                            <i class="fas fa-code fa-lg fa-lg icon-fw icon-lg mr-2"></i>
                                            <span>编程</span>
                                        </a>
                                    </li>
                                    
                                
                                    
                                    <li class="sidebar-item">
                                        <a href="/#fd71852fd52d5e18ef4f9a252f1eac58" class="smooth">
                                            <i class="fas fa-search fa-lg fa-lg icon-fw icon-lg mr-2"></i>
                                            <span>AI搜索</span>
                                        </a>
                                    </li>
                                    
                                
                                    
                                    <li class="sidebar-item">
                                        <a href="/#81b1637fbe47625dbdf2094acd3b6683" class="smooth">
                                            <i class="fas fa-language fa-lg fa-lg icon-fw icon-lg mr-2"></i>
                                            <span>文本翻译</span>
                                        </a>
                                    </li>
                                    
                                
                                    
                                    <li class="sidebar-item">
                                        <a href="/#2e9ba3fa6e1ed0e9311b3e97f97f9a40" class="smooth">
                                            <i class="fas fa-book fa-lg fa-lg icon-fw icon-lg mr-2"></i>
                                            <span>学习网站</span>
                                        </a>
                                    </li>
                                    
                                
                            </ul>           
                        </div>
                    </div>
                </div>
                <div class="border-top py-2 border-color">
                    <div class="flex-bottom">
                        <ul>
			    <li id="menu-item-212"
                                 class="menu-item menu-item-type-custom menu-item-object-custom menu-item-212 sidebar-item">
                                 <a href="#friendlink" class="smooth">
                                     <i class="fab fa-staylinked icon-fw icon-lg mr-2"></i>
                                     <span>友情链接</span>
                                 </a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>


<div class="flex-fill grid-bg">
    <div class="big-header-banner">
        <div id="header" class="page-header sticky">
            <div class="navbar navbar-expand-md">
                <div class="container-fluid p-0">

                    <a href="" class="navbar-brand d-md-none" title="AiBard123| ai工具网址导航,ai最新产品">
                        <img src="/assets/images/bt.png" class="logo-light"
                            alt="AiBard123| ai工具网址导航,ai最新产品">
                        <img src="/assets/images/bt.png" class="logo-dark d-none"
                            alt="AiBard123| ai工具网址导航,ai最新产品">
                    </a>

                    <div class="collapse navbar-collapse order-2 order-md-1">
                        <div class="header-mini-btn">
                            <label>
                                <input id="mini-button" type="checkbox">
                                <svg viewbox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                                    <path class="line--1" d="M0 40h62c18 0 18-20-17 5L31 55"></path>
                                    <path class="line--2" d="M0 50h80"></path>
                                    <path class="line--3" d="M0 60h62c18 0 18 20-17-5L31 45"></path>
                                </svg>
                            </label>

                        </div>

                        <ul class="navbar-nav site-menu" style="margin-right: 16px;">
                        
			<li >
				<a href="/">
                                    <i class="fa fa-home fa-lg mr-2"></i>
                                    <span>首页</span>
                                </a>
				<ul class="sub-menu">
				
				</ul>
			    </li>
			
			</ul>

                        
                        <div class="rounded-circle weather">
                            <div id="he-plugin-simple" style="display: contents;"></div>
                            <script>WIDGET = {
                                    CONFIG: {
                                        "modules": "01234",
                                        "background": 5,
                                        "tmpColor": "008000",
                                        "tmpSize": 14,
                                        "cityColor": "008000",
                                        "citySize": 14,
                                        "aqiColor": "#008000",
                                        "aqiSize": 14,
                                        "weatherIconSize": 24,
                                        "alertIconSize": 18,
                                        "padding": "10px 10px 10px 10px",
                                        "shadow": "1",
                                        "language": "auto",
                                        "borderRadius": 5,
                                        "fixed": "false",
                                        "vertical": "middle",
                                        "horizontal": "left",
                                        "key": "085791e805a24491b43b06cf58ab31e7"
                                    }
                                }
                            </script>
                            <script src="https://widget.qweather.net/simple/static/js/he-simple-common.js?v=2.0"></script>
                        </div>
                        
                    </div>

                    <ul class="nav navbar-menu text-xs order-1 order-md-2">
                        
                        
                        <li class="nav-item mr-3 mr-lg-0 d-none d-lg-block">
                            <script>
                                fetch('https://v1.hitokoto.cn')
                                    .then(response => response.json())
                                    .then(data => {
                                    const hitokoto = document.getElementById('hitokoto_text')
                                    hitokoto.href = 'https://hitokoto.cn/?uuid=' + data.uuid
                                    hitokoto.innerText = data.hitokoto
                                    })
                                    .catch(console.error)
                            </script>                           
                            <div id="hitokoto"><a href="#" target="_blank" id="hitokoto_text">疏影横斜水清浅，暗香浮动月黄昏。</a></div>
                        </li>
                        
                        
                        <li class="nav-search ml-3 ml-md-4">
                            <a href="javascript:" data-toggle="modal" data-target="#search-modal"><i
                                    class="iconfont icon-search icon-2x"></i></a>
                        </li>
                        <li class="nav-item d-md-none mobile-menu ml-3 ml-md-4">
                            <a href="javascript:" id="sidebar-switch" data-toggle="modal"
                                data-target="#sidebar"><i class="iconfont icon-classification icon-2x"></i></a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
        <div class="placeholder" style="height:74px"></div>
    </div>




<body class="page-body boxed-container  io-grey-mode">
    <main role="main" class="flex-shrink-0">
    <div class="container">
        
        <div class="content">
            <style>
    body{
	    background: #f9f9f9;
	}

    h1, h2, h3, h4, h5, h6 {
        margin-top: 1.5rem;
        margin-bottom: 1.5rem;
    }


 
@media (min-width: 1000px) {
  .container, .container-sm {
    max-width: 800px;
  }
}

</style>

<div class="featured-post-content">

    <a href="/digest/" class="featured-post-title">
       AI 文摘
    </a>

</div>

<section class="blog-single">
  <div class="container">
    <div class="row">

      <div class="col-lg-12 order-1 order-lg-2">
        <article class="single-blog">
          <p class="title">揭秘人工智能大模型，打造属于你的ChatGPT（一）</p>
            <br/>
          <ul class="meta">
            <li>
              By <a href=https://aibard123.com/about>AiBard123</a>
            </li>
            <li>
              <i class="fa fa-clock-o"></i>
              July 21, 2023 - 2 min read
            </li>
          </ul>

          <div class="_1NCGf">
              <img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/mmbiz_png/ZuNKdmbVMicoForwzGreR2zLmfUYXNH9EJWxYI76BH1RBq6wpsuoHDaLYInaOMic3HcPKtbnFCp3Npod1Klhb90Q/640?wx_fmt=png" width="640" >
          </div>
            <br>
            <br>
            <br>
          
          <div class="single-blog-content">
            <p>作者： 万象新说  来源： <a href="https://mp.weixin.qq.com/s/ySBPHLTxaR5Jpe82RIzXtA">万象新说</a></p>
<p>点击上方蓝字关注万象新说</p>
<h4 id="heading"></h4>
<p>现在什么概念最火？一定是人工智能。不说国外的进展，国内现在已经是“百模大战”，据不完全统计，现在已有约100个公司或组织在训练和发布自己的大模型；</p>
<p>未来的时代，大模型也许会深刻地改变我们的生活，下面是一些科技圈大佬对大模型的评价：</p>
<blockquote>
<p>我们最开始以为这是互联网十年不遇的机会，但是越想越觉得这是几百年不遇的、类似发明电的工业革命一样的机遇，所以我们觉得（AI）非常重要</p>
</blockquote>
<p>马化腾</p>
<blockquote>
<p>我们正处在全新起点，这是一个以大模型为核心的人工智能新时代，大模型改变了人工智能，大模型即将改变世界</p>
</blockquote>
<p>李彦宏</p>
<blockquote>
<p>未来可能不是百模大战，而是万模群舞，无论是To B、To G还是SaaS化的企业都有很多机会</p>
</blockquote>
<p>周鸿祎</p>
<p>笔者也判断，大模型的未来会是无处不在，无孔不入的一个存在，可能我们每个人都有属于自己的专属人工智能大模型，帮助我们生活与工作。</p>
<p>因此，理解人工特智能大模型的原理还是比较重要的。</p>
<p>打造大模型，其实和把大象放冰箱一样，简单理解一共有三步：</p>
<ul>
<li>
<p>第一步：海量语料训练基座模型</p>
</li>
<li>
<p>第二步：对基座模型做SFT微调</p>
</li>
<li>
<p>第三步：对上述模型做RLHF对齐</p>
</li>
</ul>
<p>对第一步，预训练模型其实已经有几年了，模型结构基本上没有变化，只是规模变大很多。想了解详情的话，可以参考笔者前面的文章，从代码层面讲清楚了训练基座模型的原理：</p>
<p><a href="http://mp.weixin.qq.com/s?__biz=MzI0ODI0NzkxOA==&amp;mid=2247483715&amp;idx=1&amp;sn=eb38788abd0fce88ab422e73b6e80e83&amp;chksm=e9a2e242ded56b542b0f8e1beb79275a4d4e1b54c238178b0c4299ec05df20afed598bf71fe9&amp;scene=21#wechat_redirect">深入探秘：百川7B大模型的训练代码解析，揭秘巨无霸语言模型背后的奥秘</a></p>
<p>今天，我们主要讲第二步：也就是对基座模型微调：这里面用到的一个重要的技术就是Lora，我们可以先看下，Lora是什么，它可以干什么？</p>
<p><strong>Lora可以生成漂亮的小姐姐！</strong></p>
<p><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/mmbiz_jpg/ZuNKdmbVMicpwdSFVDfVmdJfVfmgTDleq7HvFseQdc5YABab4bbU6jotBaCqDJ5lImoaibDZfibBWYYA7twdjx0zQ/640?wx_fmt=jpeg" alt=""></p>
<p><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/mmbiz_jpg/ZuNKdmbVMicpwdSFVDfVmdJfVfmgTDleqHhCEmS3s6Rkt1n5X4Ne5j968VlSR61cbb03KMHbkpWib3NkEukETlCQ/640?wx_fmt=jpeg" alt=""></p>
<p><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/mmbiz_jpg/ZuNKdmbVMicpwdSFVDfVmdJfVfmgTDleqZnzKiaC6M0O38HjetjXJYlyQxUVibTbegksln0ATP7k3vmpEEjnKg19Q/640?wx_fmt=jpeg" alt=""></p>
<p><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/mmbiz_jpg/ZuNKdmbVMicpwdSFVDfVmdJfVfmgTDleqbGtSpa7bqOgSAHH0dMxl91h0CibkfaicCAJQBD2xqpkciauZl3SkAm4gg/640?wx_fmt=jpeg" alt=""></p>
<p><strong>滑动查看更多小姐姐</strong></p>
<p>但Lora作用不止于此，它本来是为了大语言模型设计的，但不小心开发了画小姐姐这一功能，技能树点歪了，但也确实说明了Lora这个模型的强大。</p>
<p>今天，我们暂时先不讲Lora是怎么用来画小姐姐的，我们正经一点，说一下它本来的用途：</p>
<p><strong>微调大语言模型</strong></p>
<p>为什么要微调大语言模型呢？比如，我们有一个基座模型，它有个很大的问题在于，它像是一个修炼了很多顶级内功的高手，但不会招式，打架的话很不占优势。</p>
<p>举个例子吧，我们来问下Baichuan-7B这个没有经过微调的基座模型一些简单的问题，相当于“出招”。它这时是不太会接招的，或者说，它的回答就是知识性的回答，回答问题的方式不符合人类的交谈标准。不像现在的ChatGPT一样，什么回答都写个1,2,3之类的。</p>
<p><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/mmbiz_png/ZuNKdmbVMicoForwzGreR2zLmfUYXNH9Es4ZrjsORKwdX5U7Gfkj9lnRfgCrtXvR7Jia3LedDZJPjCIwiaO8FSDBg/640?wx_fmt=png" alt=""></p>
<p>同时附上了ChatGpt的结果，明显更像一个“好学生”：</p>
<p><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/mmbiz_png/ZuNKdmbVMicpwdSFVDfVmdJfVfmgTDleqsQ1FjYjfJNgPJq9jprTZ6RoYmT7H7NZyiavhpJic1JNAt6UmTj81WpMg/640?wx_fmt=png" alt=""></p>
<p>那就需要教它“做人”了，现在比较流行的方法就是微调（finetune），也就是SFT是的FT，那S是什么呢？S是supervised，也就是有监督的，连起来的意思就是，现在我有一份经过我检验和审核的（有监督的）训练样本，它们就是关于怎么说人话的，大模型你去学一下，学会了你就会有招式了，会说人话了。</p>
<p>一说到大模型还要学习，那就不是普通人能做的了，一般都是专业的团队才能做到的； 可以看下大模型需要的参数，动不动百亿，能训练起的都是啥家庭啊？</p>
<p><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/mmbiz_png/ZuNKdmbVMicoForwzGreR2zLmfUYXNH9ErRyIUxOHcBqJAkQV1K5WnGnQJc9AYRFr3Rl53J5Lo4TBialPoshZscg/640?wx_fmt=png" alt=""></p>
<p>但现在，人工智能必定是全民运动了，大家都会有想试一试的冲动，所以，训练不动所有的模型，那我训练一部分参数可以吗？所以就有了一些方法、技巧，可以在大模型的基础上只训练一部分参数，从而达到和整体微调接近的效果；</p>
<p>这就很友好了，现在流行的就是LORA，它的中文名字叫做“<strong>大语言模型的低阶适应</strong> ”，可以理解为一种插件，在一个大模型的整体框架下，增加一些可训练的参数，然后在训练原来的模型时， 可以冻结原来模型的上百亿参数，只训练新增的几个亿的参数，这样成本就大大降低了；</p>
<p>所以它是怎么做到的呢？</p>
<p><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/mmbiz_png/ZuNKdmbVMicoForwzGreR2zLmfUYXNH9Eqr7kyhGpyJ8vKl16fibOo2EjDyYb0mZqzYAnicMxMgsjYInuicmgX4AUg/640?wx_fmt=png" alt=""></p>
<p>看上面这张图就够了，它就是LORA的全部</p>
<p>左边是训练的流程，我们先从训练开始：这里给一个公式：</p>
<p>*<strong>h = Wx + BAx</strong> *</p>
<p>第一步：W是原来大模型的参数，可以看到这个参数的维度是很高的，d*d, 它的参数是冻结的，不参与训练；这一步可以保证微调的效率</p>
<p>第二步：然后，我们再加两个可训练的A，B矩阵，这两个矩阵的是<em>d * r</em>维的矩阵，然后A 和B 相乘，<em>d * r * r * d</em> 又变成了 <em>d * d</em> 维的矩阵。</p>
<p>最后：两者结果相加，* h = Wx + BAx*</p>
<p>挺简单的，我们看下代码吧，看经典的Huggingface的PEFT库吧.</p>
<p><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/mmbiz_png/ZuNKdmbVMicoForwzGreR2zLmfUYXNH9EAPS36Xsm6a052jBaCsf0s5qrXc7DEoWEKL8icUEQaFplEJcULY9jSyg/640?wx_fmt=png" alt=""><em>现</em>在NLP的很多任务都是基于huggingface的transformer库做的（感谢开源！）所以PEFT也可以支持大部分的市面上大模型的微调，我们看下官方例子：</p>
<p><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/mmbiz_png/ZuNKdmbVMicoForwzGreR2zLmfUYXNH9ETUgzibLak15ErXH3xGXepAdBoibvW0z2HYyOqbefRhZyMyeDJiaeLX0tQ/640?wx_fmt=png" alt=""></p>
<p>就一句’get_peft_model()’就可以把预训练的model转成可训练的peft模型，同时也可以计算出需要微调的参数数量</p>
<p>所以，我们看下它是怎么做的？先去github把PEFT上的源码下载下来</p>
<p><a href="https://github.com/huggingface/peft">https://github.com/huggingface/peft</a></p>
<p>第一步：get_peft_model()， 因为PEFT可以微调很多种模型，所以先选择对应的模型，比如我们是搞的LLM模型，就选下面的：</p>
<p><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/mmbiz_png/ZuNKdmbVMicoForwzGreR2zLmfUYXNH9EMpgNc76m4jm4NicNEkQMTUOMsIfzuel2uuicuIbx3M7qXpcHTibpiatGLA/640?wx_fmt=png" alt=""></p>
<p><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/mmbiz_png/ZuNKdmbVMicoForwzGreR2zLmfUYXNH9EMSaZwLubfib5RCM0WupzXBs7L2ny6QCICYfxBhto3TSbh5ykcsqwuMw/640?wx_fmt=png" alt=""></p>
<p>**每二步，进到对应的模型里看具体的实现： **</p>
<p>PeftModelForCausalLM会调用下基类的init函数，因此我们重点看基类</p>
<p><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/mmbiz_png/ZuNKdmbVMicoForwzGreR2zLmfUYXNH9E5M6RIIgRLvibjWy2obvBdPnicm1jt9HZ46bbYhRmghHhWOoic1T2IoMIw/640?wx_fmt=png" alt=""></p>
<p><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/mmbiz_png/ZuNKdmbVMicoForwzGreR2zLmfUYXNH9E4PVf0yQqiaVyIkSlZSgwG6bSzpq5wuuWn3Z0sRVu7Yx3JdYZ7HIsuFQ/640?wx_fmt=png" alt="">基类同样能过一个类的map映射，到对应的类中处理</p>
<p>第三步, 这一步是关键的一步，具体的为目标层增加可训练参数，也就上上面的公式里说的从 *h = Wx *变成 <em>h = Wx + BAx</em></p>
<p><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/mmbiz_png/ZuNKdmbVMicoForwzGreR2zLmfUYXNH9EJWxYI76BH1RBq6wpsuoHDaLYInaOMic3HcPKtbnFCp3Npod1Klhb90Q/640?wx_fmt=png" alt=""></p>
<p>可以看到，在add_adapter里，会有一个find_and_replace函数，用来找到目标的模块，并增加一些可训练参数替换它，接下来，可以看具体怎么替换的，在_create_new_module里，会新建一个Linear类，它是Pytorch的nn.Linear类的子类，通过重写forward方法，把本来很简单的 <em>h = Wx</em> 变成 <em>h = Wx + BAx</em></p>
<p><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/mmbiz_png/ZuNKdmbVMicoForwzGreR2zLmfUYXNH9EUyqwXjia1YicJnsZuMibOPNEDicicJa9aX7ZtPdZv8WyUymBbAsmR1biazqA/640?wx_fmt=png" alt=""></p>
<p>详情就是下面的代码写的，这段代码比较重要，我把源码贴上来了，标红的部分，第一部分是计算原来的冻结参数，第二部分是将 A * B的结果加到原来的result上，也就对应了上面的图</p>
<p><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/mmbiz_png/ZuNKdmbVMicpwdSFVDfVmdJfVfmgTDleq35Uu5dPkqopzVUkM37sUTJUgwVN4kOPLTlUiarCia4AYTrj5R8Yib8tSA/640?wx_fmt=png" alt=""></p>
<hr>
<pre><code>def forward(self, x: torch.Tensor):
    previous_dtype = x.dtype
    if self.active_adapter not in self.lora_A.keys():
        return F.linear(x, transpose(self.weight, self.fan_in_fan_out), bias=self.bias)
    if self.disable_adapters:
        if self.r[self.active_adapter] &gt; 0 and self.merged:
            self.unmerge()
        result = F.linear(x, transpose(self.weight, self.fan_in_fan_out), bias=self.bias)
    elif self.r[self.active_adapter] &gt; 0 and not self.merged:
        # result 就是待输出的隐层h, self.weight 是W，这句就是  h = Wx;
        result = F.linear(x, transpose(self.weight, self.fan_in_fan_out), bias=self.bias)
  

        x = x.to(self.lora_A[self.active_adapter].weight.dtype)
        # 
        result += (
            # 隐层h在这里增加了 B * A * x 的结果，就是 h = Wx + BAx
            self.lora_B[self.active_adapter](
                self.lora_A[self.active_adapter](self.lora_dropout[self.active_adapter](x))
            )
            * self.scaling[self.active_adapter]
        )
    else:
        result = F.linear(x, transpose(self.weight, self.fan_in_fan_out), bias=self.bias)
  

    result = result.to(previous_dtype)
  

    return result
</code></pre>
<p><strong>最后给大家讲下推理</strong> ，首先就有个疑问，Lora这种方法，总归是增加了一些参数，推理会不会慢呢？理论上是会的，但是，我们可以把经过Lora微调的大模型，和原来的模型合并起来， 也就是把上面的公式变换一下，把W 和 BA 的结果 merge起来，这样就可以保持和原来模型一样的推理效率了。</p>
<p>原公式 ：*<strong>h = Wx + BAx</strong> *</p>
<p>新公式：*<strong>h = （W + BA）x</strong> *</p>
<p><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/mmbiz_png/ZuNKdmbVMicoForwzGreR2zLmfUYXNH9ECrenS4njSVACOqDibibzPIl0xc5amib4U7fxBkyerxlrdp1FQtEzibrC5g/640?wx_fmt=png" alt=""> <img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/mmbiz_png/ZuNKdmbVMicoForwzGreR2zLmfUYXNH9Eqr7kyhGpyJ8vKl16fibOo2EjDyYb0mZqzYAnicMxMgsjYInuicmgX4AUg/640?wx_fmt=png" alt=""></p>
<p>这个就是利用Lora微调大模型的原理了，后面计划讲下RLHF的原理，这个比SFT要难理解一点，可能要分几篇来讲</p>
<p>最后，感谢阅读！Lora生成的小姐姐真的好看！再贴几张，请滑动欣赏~</p>
<p><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/mmbiz_jpg/ZuNKdmbVMicpwdSFVDfVmdJfVfmgTDleq72mn99qGfh0nbz2kOBOyiaKDWE6szn1fZRx4MLyDOdW3G7Ay2BSzRZA/640?wx_fmt=jpeg" alt=""></p>
<p><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/mmbiz_jpg/ZuNKdmbVMicpwdSFVDfVmdJfVfmgTDleqlnRh16Ewqibdl5DRoMGiagsAXnx76hYDRP5icfYUtHEMaWCesB3YicA5Cg/640?wx_fmt=jpeg" alt=""></p>
<p><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/mmbiz_jpg/ZuNKdmbVMicpwdSFVDfVmdJfVfmgTDleqlSZ07GhOqqyEOniaPMm2mPlPQgOA1YraznfMEWdmicL6kBy2vPLDXcvA/640?wx_fmt=jpeg" alt=""></p>
<p><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/mmbiz_jpg/ZuNKdmbVMicpwdSFVDfVmdJfVfmgTDleqU4jRWBTU6fmQY05iaR0fFzmNHzWfhvxJYhiah1rgqVB8fJqWZgcrbPkg/640?wx_fmt=jpeg" alt=""></p>
<p><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/mmbiz_jpg/ZuNKdmbVMicpwdSFVDfVmdJfVfmgTDleqzbdGsibp3VRicgE6zsf4pv2oH5icEPaDwCWXEnTtm8NvYaYZE1BZNWrHw/640?wx_fmt=jpeg" alt=""></p>
<p><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/mmbiz_jpg/ZuNKdmbVMicpwdSFVDfVmdJfVfmgTDleqKib6iasjhW0XO9sibcxEpdIpoPa2oiarru3wfk3jryj644p7x0NHhic7zXA/640?wx_fmt=jpeg" alt=""></p>
<p><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/mmbiz_jpg/ZuNKdmbVMicpwdSFVDfVmdJfVfmgTDleqnb2lzAfoscegas8tiaYLQFIHbLvgdPVHXKeXPHqAt0Myceg9DKsSDBg/640?wx_fmt=jpeg" alt=""></p>
<p><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/mmbiz_jpg/ZuNKdmbVMicpwdSFVDfVmdJfVfmgTDlequmQLGFjeFh95y7ozz5bEdHR0XXNFCgm78IDkrOiccxLH32lJEaQ8YFA/640?wx_fmt=jpeg" alt=""></p>
<p><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/mmbiz_jpg/ZuNKdmbVMicpwdSFVDfVmdJfVfmgTDleqFnJZk0CeTDZCcUhLu7Uwp5sCJVaibOcXTwiaRxdy6vsqcVk6micRHf4KQ/640?wx_fmt=jpeg" alt=""></p>
<p><strong>滑动查看更多小姐姐</strong></p>
<p>更多AI工具，参考<a href="https://aibard123.com/">Github-AiBard123</a>，<a href="https://aibard123.com/">国内AiBard123</a></p>



          </div>

可关注我们的公众号：每天AI新工具

<p><img src="/images/aitools/2024/03/qrcode_for_gh_dde1b429630d_258.jpg" alt=""></p>

        </article>

      </div>
    </div>
  </div>
</section>
        </div>
    </div>
    </main>




<script type='text/javascript' src='/assets/js/jquery.ui.touch-punch.min-0.2.2.js' id='jqueryui-touch-js'></script>
<script type='text/javascript' src='/assets/js/clipboard.min-5.6.2.js' id='clipboard-js'></script>
<script type='text/javascript' src='/assets/js/tooltip-extend.js' id='iplaycode-nav-js'></script>
<script type='text/javascript' id='popper-js-extra'>
 

var theme = {"ajaxurl":"","addico":"https:\/\/nav.baidu.cn\/wp-content\/themes\/onenav\/images\/add.png","order":"asc","formpostion":"top","defaultclass":"io-grey-mode","isCustomize":"1","icourl":"","icopng":".png","urlformat":"1","customizemax":"10","newWindow":"0","lazyload":"1","minNav":"1","loading":"1","hotWords":"baidu","classColumns":" col-sm-6 col-md-4 col-xl-5a col-xxl-6a ","apikey":"TWpBeU1UVTNOekk1TWpVMEIvZ1M2bFVIQllUMmxsV1dZelkxQTVPVzB3UW04eldGQmxhM3BNWW14bVNtWk4="};
 
</script>
<script type='text/javascript' src='/assets/js/popper.min.js' id='popper-js'></script>
<script type='text/javascript' src='/assets/js/bootstrap.min-4.3.1.js' id='bootstrap-js'></script>
<script type='text/javascript' src='/assets/js/theia-sticky-sidebar-1.5.0.js' id='sidebar-js'></script>
<script type='text/javascript' src='/assets/js/lazyload.min-12.4.0.js' id='lazyload-js'></script>
<script type='text/javascript' src='/assets/js/fancybox.min-3.5.7.js' id='lightbox-js-js'></script>

<script type='text/javascript' src='/assets/js/app-anim.js' id='appanim-js'></script>

<script type="text/javascript">
    $(document).ready(function(){
        var siteWelcome = $('#loading');
        siteWelcome.addClass('close');
        setTimeout(function() {
            siteWelcome.remove();
        }, 600);
    });
</script>
<script>        
    $(document).ready(function(){
        setTimeout(function () {
            if ($('a.smooth[href="' + window.location.hash + '"]')[0]) {
                $('a.smooth[href="' + window.location.hash + '"]').click();
            }else if (window.location.hash != '') {
                $("html, body").animate({
                    scrollTop: $(window.location.hash).offset().top - 90
                }, {
                    duration: 500,
                    easing: "swing"
                });
            }
        }, 300);
        $(document).on('click','a.smooth',function(ev) {
            if($('#sidebar').hasClass('show') && !$(this).hasClass('change-href')){
                $('#sidebar').modal('toggle');
            }
            if($(this).attr("href").substr(0, 1) == "#"){
                $("html, body").animate({
                    scrollTop: $($(this).attr("href")).offset().top - 90
                }, {
                    duration: 500,
                    easing: "swing"
                });
            }
            if($(this).hasClass('go-search-btn')){
                $('#search-text').focus();
            }
            if(!$(this).hasClass('change-href')){
                var menu =  $("a"+$(this).attr("href"));
                menu.click();
                toTarget(menu.parent().parent(),true,true);
            }
        });
        $(document).on('click','a.tab-noajax',function(ev) {
            var url = $(this).data('link');
            if(url)
                $(this).parents('.d-flex.flex-fill.flex-tab').children('.btn-move.tab-move').show().attr('href', url);
            else
                $(this).parents('.d-flex.flex-fill.flex-tab').children('.btn-move.tab-move').hide();
        });
        
    });
</script>

<script>

(function(){
    if(document.cookie.replace(/(?:(?:^|.*;\s*)night\s*\=\s*([^;]*).*$)|^.*$/, "$1") === ''){
        if(new Date().getHours() > 22 || new Date().getHours() < 6){
            document.body.classList.remove('io-black-mode');
            document.body.classList.add('io-grey-mode');
            document.cookie = "night=1;path=/";
            console.log('夜间模式开启');
        }else{
            document.body.classList.remove('night');
            document.cookie = "night=0;path=/";
            console.log('夜间模式关闭');
        }
    }else{
        var night = document.cookie.replace(/(?:(?:^|.*;\s*)night\s*\=\s*([^;]*).*$)|^.*$/, "$1") || '0';
        if(night == '0'){
            document.body.classList.remove('night');
        }else if(night == '1'){
            document.body.classList.add('night');
        }
    }
})();

$("#search-bg").css("background", "linear-gradient(#e2c4c4, #d8d8d8)");   
function switchNightMode(){
    var night = document.cookie.replace(/(?:(?:^|.*;\s*)night\s*\=\s*([^;]*).*$)|^.*$/, "$1") || '0';
    if(night == '0'){
	$("#search-bg").css("background", "linear-gradient(#e2c4c4, #d8d8d8)");
        document.body.classList.remove('io-grey-mode');
        document.body.classList.add('io-black-mode');
        document.cookie = "night=1;path=/"
        console.log(' ');
        $(".switch-dark-mode").attr("data-original-title","日间模式");
        $(".mode-ico").removeClass("icon-night");
        $(".mode-ico").addClass("icon-light");
    }else{
	$("#search-bg").css("background", "linear-gradient(#4f4040, #1b1d1f)");
        document.body.classList.remove('io-black-mode');
        document.body.classList.add('io-grey-mode');
        document.cookie = "night=0;path=/"
        console.log(' ');
        $(".switch-dark-mode").attr("data-original-title","夜间模式");
        $(".mode-ico").removeClass("icon-light");
        $(".mode-ico").addClass("icon-night");
    }
}
</script>


<script>
    var newsContainer = document.getElementById('news-container');
    var newsItems = document.getElementsByClassName('news-item');
    var currentItem = 0;

    setInterval(function() {
        
        newsItems[currentItem].classList.remove('show');
        newsItems[currentItem].style.transform = 'translateY(-20px)';
        
        currentItem = (currentItem + 1) % newsItems.length;
        newsItems[currentItem].style.transform = 'translateY(' + (newsContainer.offsetHeight - 20) + 'px)';
        setTimeout(function() {
            newsItems[currentItem].classList.add('show');
        }, 500);
    }, 8000);
</script>

</body>
</html>


