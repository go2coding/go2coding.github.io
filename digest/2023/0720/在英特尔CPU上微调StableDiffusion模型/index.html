

<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1" />
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta name="theme-color" content="#f9f9f9" />

	<title>在英特尔CPU上微调StableDiffusion模型 作者： Hugging Face 来源： Hugging Face 扩散模型能够根据文本提示生成逼真的图像，这种能力促进了生成式人工智能的普及。人们已经开始把这些模型用在包括数据合成及内容创建在内的多个应用领域。Hugging Face Hub 包含超过 5 千个预训练的文生图 模型。这些模型与 Diffusers 库 结合使用，  | AiBard123| ai工具网址导航,ai最新产品</title>
	<link rel="shortcut icon" href="/assets/images/favicon.png" />
    <meta name="keywords" content="chatgpt,AI,AI聊天,AI文本生成,AI绘画,AI编程,AI电商" />
    <meta name="description" content="AiBard123 网址导航 | 免费chatgpt 汇集各类先进的人工智能产品，旨在帮助用户更快速地了解和使用这些产品,轻松地浏览不同领域的AI产品，包括语音识别、图像处理、自然语言处理。" />
    
    <meta name="baidu-site-verification" content="codeva-cCAOSG8MBO" />
    
    <link rel="stylesheet" id="block-library-css"
        href="/assets/css/block-library.min-5.6.2.css" type="text/css" media="all" />
    <link rel="stylesheet" id="iconfont-css" href="/assets/css/iconfont-3.03029.1.css"
        type="text/css" media="all" />

    
    <link href="/scss/style.min.css" rel="stylesheet" />
    
		    <link rel="stylesheet" id="iowen-css" href="/assets/css/style-3.03029.1.css"
        type="text/css" media="all" />
    <link rel="stylesheet" id="custom-css" href="/assets/css/custom-style.css"
        type="text/css" media="all" />
		
		<link rel="stylesheet" href=/plugins/font-awesome/css/font-awesome.min.css />


    <link rel="stylesheet" id="fortawesome-css" href="/assets/fontawesome-5.15.4/css/all.min.css" type="text/css" />


    <script type="text/javascript" src="/assets/js/jquery.min-3.2.1.js" id="jquery-js"></script>
    <script type="text/javascript" src="/assets/js/content-search.js"  id="content-search-js"></script>

    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2073588164294660"
     crossorigin="anonymous"></script>

	
    <script>
        

		var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?8450bc732b2a86f7e4aec4ebd9fd8252";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();

        
    </script>
    

    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-7071W80M2K"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-7071W80M2K');
    </script>

</head>


    <div class="page-container">
	
	<div id="sidebar" class="sticky sidebar-nav fade animate-nav" style="width: 170px">
        
            <div class="modal-dialog h-100 sidebar-nav-inner">
                <div class="sidebar-logo border-bottom border-color">
                    
                    <div class="logo overflow-hidden">
                        <a href="https://aibard123.com/" class="logo-expanded">
                            <img src="/assets/images/bt8-expand-light.png" height="40" class="logo-light"
                                alt="AiBard123| ai工具网址导航,ai最新产品">
                            <img src="/assets/images/bt8-expand-dark.png" height="40" class="logo-dark d-none"
                                alt="AiBard123| ai工具网址导航,ai最新产品">
                        </a>
                        <a href="https://aibard123.com/" class="logo-collapsed">
                            <img src="/assets/images/bt.png" height="40" class="logo-light"
                                alt="AiBard123| ai工具网址导航,ai最新产品">
                            <img src="/assets/images/bt.png" height="40" class="logo-dark d-none"
                                alt="AiBard123| ai工具网址导航,ai最新产品">
                        </a>
                    </div>
                    
                </div>
                <div class="sidebar-menu flex-fill">
                    <div class="sidebar-scroll">
                        <div class="sidebar-menu-inner">
                            <ul>
                                
                                    
                                    <li class="sidebar-item">
                                        <a href="/#00834a9dd147b04c5d53d4368cdb0b57" class="smooth">
                                            <i class="fas fa-sun fa-lg fa-lg icon-fw icon-lg mr-2"></i>
                                            <span>本月热门</span>
                                        </a>
                                    </li>
                                    
                                
                                    
                                    <li class="sidebar-item">
                                        <a href="/#db0311e7ecfedd24d157f0ceb4a0897f" class="smooth">
                                            <i class="fas fa-star-and-crescent fa-lg fa-lg icon-fw icon-lg mr-2"></i>
                                            <span>热门网站</span>
                                        </a>
                                    </li>
                                    
                                
                                    
                                    <li class="sidebar-item">
                                        <a href="/#21b5cbb2c769010fec3ce029a5f8a4a3" class="smooth">
                                            <i class="far fa-star fa-lg icon-fw icon-lg mr-2"></i>
                                            <span>国内热门</span>
                                        </a>
                                    </li>
                                    
                                
                                    
                                    <li class="sidebar-item">
                                        <a href="/#8310718935e8ec25ce0350de01e3f7dc" class="smooth">
                                            <i class="fas fa-phone fa-lg fa-lg icon-fw icon-lg mr-2"></i>
                                            <span>对话工具</span>
                                        </a>
                                    </li>
                                    
                                
                                    
                                    <li class="sidebar-item">
                                        <a href="/#d58e850d9115797306c2edf61ac6ddd8" class="smooth">
                                            <i class="fas fa-newspaper fa-lg fa-lg icon-fw icon-lg mr-2"></i>
                                            <span>写作</span>
                                        </a>
                                    </li>
                                    
                                
                                    
                                    <li class="sidebar-item">
                                        <a href="/#2a7418a5f8f1ca4e054364a9300657df" class="smooth">
                                            <i class="fas fa-image fa-lg fa-lg icon-fw icon-lg mr-2"></i>
                                            <span>图像生成</span>
                                        </a>
                                    </li>
                                    
                                
                                    
                                    <li class="sidebar-item">
                                        <a href="/#7808a68ee1b34dab43011429a12de19e" class="smooth">
                                            <i class="fas fa-image fa-lg fa-lg icon-fw icon-lg mr-2"></i>
                                            <span>图像处理</span>
                                        </a>
                                    </li>
                                    
                                
                                    
                                    <li class="sidebar-item">
                                        <a href="/#6729afc51f5ac49a828812fa0eb0c82f" class="smooth">
                                            <i class="fas fa-video fa-lg fa-lg icon-fw icon-lg mr-2"></i>
                                            <span>音视频</span>
                                        </a>
                                    </li>
                                    
                                
                                    
                                    <li class="sidebar-item">
                                        <a href="/#e5ce844860451fff3faf3d8f8894971d" class="smooth">
                                            <i class="fas fa-music fa-lg fa-lg icon-fw icon-lg mr-2"></i>
                                            <span>音乐生成</span>
                                        </a>
                                    </li>
                                    
                                
                                    
                                    <li class="sidebar-item">
                                        <a href="/#db53804b7d726967c58fcc8c9ca03d27" class="smooth">
                                            <i class="fas fa-language fa-lg fa-lg icon-fw icon-lg mr-2"></i>
                                            <span>办公</span>
                                        </a>
                                    </li>
                                    
                                
                                    
                                    <li class="sidebar-item">
                                        <a href="/#47b7af9547e034d28fe6f6d439968ac8" class="smooth">
                                            <i class="fas fa-copy fa-lg fa-lg icon-fw icon-lg mr-2"></i>
                                            <span>提示词</span>
                                        </a>
                                    </li>
                                    
                                
                                    
                                    <li class="sidebar-item">
                                        <a href="/#41282bf95e43c64d579757573a03cdde" class="smooth">
                                            <i class="fas fa-code fa-lg fa-lg icon-fw icon-lg mr-2"></i>
                                            <span>编程</span>
                                        </a>
                                    </li>
                                    
                                
                                    
                                    <li class="sidebar-item">
                                        <a href="/#fd71852fd52d5e18ef4f9a252f1eac58" class="smooth">
                                            <i class="fas fa-search fa-lg fa-lg icon-fw icon-lg mr-2"></i>
                                            <span>AI搜索</span>
                                        </a>
                                    </li>
                                    
                                
                                    
                                    <li class="sidebar-item">
                                        <a href="/#81b1637fbe47625dbdf2094acd3b6683" class="smooth">
                                            <i class="fas fa-language fa-lg fa-lg icon-fw icon-lg mr-2"></i>
                                            <span>文本翻译</span>
                                        </a>
                                    </li>
                                    
                                
                                    
                                    <li class="sidebar-item">
                                        <a href="/#2e9ba3fa6e1ed0e9311b3e97f97f9a40" class="smooth">
                                            <i class="fas fa-book fa-lg fa-lg icon-fw icon-lg mr-2"></i>
                                            <span>学习网站</span>
                                        </a>
                                    </li>
                                    
                                
                            </ul>           
                        </div>
                    </div>
                </div>
                <div class="border-top py-2 border-color">
                    <div class="flex-bottom">
                        <ul>
			    <li id="menu-item-212"
                                 class="menu-item menu-item-type-custom menu-item-object-custom menu-item-212 sidebar-item">
                                 <a href="#friendlink" class="smooth">
                                     <i class="fab fa-staylinked icon-fw icon-lg mr-2"></i>
                                     <span>友情链接</span>
                                 </a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>


<div class="flex-fill grid-bg">
    <div class="big-header-banner">
        <div id="header" class="page-header sticky">
            <div class="navbar navbar-expand-md">
                <div class="container-fluid p-0">

                    <a href="" class="navbar-brand d-md-none" title="AiBard123| ai工具网址导航,ai最新产品">
                        <img src="/assets/images/bt.png" class="logo-light"
                            alt="AiBard123| ai工具网址导航,ai最新产品">
                        <img src="/assets/images/bt.png" class="logo-dark d-none"
                            alt="AiBard123| ai工具网址导航,ai最新产品">
                    </a>

                    <div class="collapse navbar-collapse order-2 order-md-1">
                        <div class="header-mini-btn">
                            <label>
                                <input id="mini-button" type="checkbox">
                                <svg viewbox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                                    <path class="line--1" d="M0 40h62c18 0 18-20-17 5L31 55"></path>
                                    <path class="line--2" d="M0 50h80"></path>
                                    <path class="line--3" d="M0 60h62c18 0 18 20-17-5L31 45"></path>
                                </svg>
                            </label>

                        </div>

                        <ul class="navbar-nav site-menu" style="margin-right: 16px;">
                        
			<li >
				<a href="/">
                                    <i class="fa fa-home fa-lg mr-2"></i>
                                    <span>首页</span>
                                </a>
				<ul class="sub-menu">
				
				</ul>
			    </li>
			
			</ul>

                        
                        <div class="rounded-circle weather">
                            <div id="he-plugin-simple" style="display: contents;"></div>
                            <script>WIDGET = {
                                    CONFIG: {
                                        "modules": "01234",
                                        "background": 5,
                                        "tmpColor": "008000",
                                        "tmpSize": 14,
                                        "cityColor": "008000",
                                        "citySize": 14,
                                        "aqiColor": "#008000",
                                        "aqiSize": 14,
                                        "weatherIconSize": 24,
                                        "alertIconSize": 18,
                                        "padding": "10px 10px 10px 10px",
                                        "shadow": "1",
                                        "language": "auto",
                                        "borderRadius": 5,
                                        "fixed": "false",
                                        "vertical": "middle",
                                        "horizontal": "left",
                                        "key": "085791e805a24491b43b06cf58ab31e7"
                                    }
                                }
                            </script>
                            <script src="https://widget.qweather.net/simple/static/js/he-simple-common.js?v=2.0"></script>
                        </div>
                        
                    </div>

                    <ul class="nav navbar-menu text-xs order-1 order-md-2">
                        
                        
                        <li class="nav-item mr-3 mr-lg-0 d-none d-lg-block">
                            <script>
                                fetch('https://v1.hitokoto.cn')
                                    .then(response => response.json())
                                    .then(data => {
                                    const hitokoto = document.getElementById('hitokoto_text')
                                    hitokoto.href = 'https://hitokoto.cn/?uuid=' + data.uuid
                                    hitokoto.innerText = data.hitokoto
                                    })
                                    .catch(console.error)
                            </script>                           
                            <div id="hitokoto"><a href="#" target="_blank" id="hitokoto_text">疏影横斜水清浅，暗香浮动月黄昏。</a></div>
                        </li>
                        
                        
                        <li class="nav-search ml-3 ml-md-4">
                            <a href="javascript:" data-toggle="modal" data-target="#search-modal"><i
                                    class="iconfont icon-search icon-2x"></i></a>
                        </li>
                        <li class="nav-item d-md-none mobile-menu ml-3 ml-md-4">
                            <a href="javascript:" id="sidebar-switch" data-toggle="modal"
                                data-target="#sidebar"><i class="iconfont icon-classification icon-2x"></i></a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
        <div class="placeholder" style="height:74px"></div>
    </div>




<body class="page-body boxed-container  io-grey-mode">
    <main role="main" class="flex-shrink-0">
    <div class="container">
        
        <div class="content">
            <style>
    body{
	    background: #f9f9f9;
	}

    h1, h2, h3, h4, h5, h6 {
        margin-top: 1.5rem;
        margin-bottom: 1.5rem;
    }


 
@media (min-width: 1000px) {
  .container, .container-sm {
    max-width: 800px;
  }
}

</style>

<div class="featured-post-content">

    <a href="/digest/" class="featured-post-title">
       AI 文摘
    </a>

</div>

<section class="blog-single">
  <div class="container">
    <div class="row">

      <div class="col-lg-12 order-1 order-lg-2">
        <article class="single-blog">
          <p class="title">在英特尔CPU上微调StableDiffusion模型</p>
            <br/>
          <ul class="meta">
            <li>
              By <a href=https://aibard123.com/about>AiBard123</a>
            </li>
            <li>
              <i class="fa fa-clock-o"></i>
              July 20, 2023 - 2 min read
            </li>
          </ul>

          <div class="_1NCGf">
              <img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/mmbiz_jpg/5LJDib8HPR2o5JD2LRGpXfuJAjlqUEROlY0UQBIEStZoXmU1WBWj7TTHaOt9vI8BDOJSXQvccgOA1g4S4sSHOaw/640?wx_fmt=jpeg" width="640" >
          </div>
            <br>
            <br>
            <br>
          
          <div class="single-blog-content">
            <p>作者： Hugging Face  来源： <a href="https://mp.weixin.qq.com/s/YmznHA811TqCrqHOwL2D0Q">Hugging Face</a></p>
<p>扩散模型能够根据文本提示生成逼真的图像，这种能力促进了生成式人工智能的普及。人们已经开始把这些模型用在包括数据合成及内容创建在内的多个应用领域。Hugging Face Hub 包含超过 5 千个预训练的文生图 模型。这些模型与 Diffusers 库 结合使用，使得构建图像生成工作流或者对不同的图像生成工作流进行实验变得无比简单。</p>
<p>和 transformer 模型一样，你可以微调扩散模型以让它们生成更符合特定业务需求的内容。起初，大家只能用 GPU 进行微调，但情况正在发生变化！几个月前，英特尔 推出 了代号为 Sapphire Rapids 的第四代至强 CPU。Sapphire Rapids 中包含了英特尔先进矩阵扩展 (Advanced Matrix eXtension，AMX)，它是一种用于深度学习工作负载的新型硬件加速器。在之前的几篇博文中，我们已经展示了 AMX 的优势: <a href="http://mp.weixin.qq.com/s?__biz=Mzk0MDQyNTY4Mw==&amp;mid=2247484610&amp;idx=1&amp;sn=bdd1a01ddf137f2d72a2bb2df606e691&amp;chksm=c2e0ac7ef5972568f2fb6f2e3c6ebd047ae3fef6bae8fab1b977d20f278cce90fbe728bcf83d&amp;scene=21#wechat_redirect">微调 NLP transformers 模型</a>、<a href="http://mp.weixin.qq.com/s?__biz=Mzk0MDQyNTY4Mw==&amp;mid=2247485733&amp;idx=1&amp;sn=cbdfcebe8b79787a4478ff24b44e2552&amp;chksm=c2e0a199f597288f32417c515a3cc069906b4d184d5fda4e665dbaf9bc4529ee62d4494e574c&amp;scene=21#wechat_redirect">对 NLP transformers 模型进行推理</a>，以及 <a href="http://mp.weixin.qq.com/s?__biz=Mzk0MDQyNTY4Mw==&amp;mid=2247486355&amp;idx=1&amp;sn=2f6f6386f03890eb09a094ce5f073056&amp;chksm=c2e0a32ff5972a39a1cd6d2e775b959ea58d72a2aeab50bcb72cdac3726808ed85f62585493d&amp;scene=21#wechat_redirect">对 Stable Diffusion 模型进行推理</a>。</p>
<p>本文将展示如何在英特尔第四代至强 CPU 集群上微调 Stable Diffusion 模型。我们用于微调的是 文本逆向 (Textual Inversion) 技术，该技术仅需少量训练样本即可对模型进行有效微调。在本文中，我们仅用 5 个样本就行了！</p>
<p>我们开始吧。</p>
<h4 id="配置集群">配置集群</h4>
<p>英特尔 的小伙伴给我们提供了 4 台托管在 英特尔开发者云 (Intel Developer Cloud，IDC) 上的服务器。IDC 作为一个云服务平台，提供了一个英特尔深度优化的、集成了最新英特尔处理器及 最优性能软件栈 的部署环境，用户可以很容易地在此环境上开发、运行其工作负载。</p>
<p>我们得到的每台服务器均配备两颗英特尔第四代至强 CPU，每颗 CPU 有 56 个物理核和 112 个线程。以下是其 lscpu
的输出:</p>
<pre><code>Architecture: x86_64  
  CPU op-mode(s): 32-bit, 64-bit  
  Address sizes: 52 bits physical, 57 bits virtual  
  Byte Order: Little Endian  
CPU(s): 224  
  On-line CPU(s) list: 0-223  
Vendor ID: GenuineIntel  
  Model name: Intel(R) Xeon(R) Platinum 8480+  
    CPU family: 6  
    Model: 143  
    Thread(s) per core: 2  
    Core(s) per socket: 56  
    Socket(s): 2  
    Stepping: 8  
    CPU max MHz: 3800.0000  
    CPU min MHz: 800.0000  
    BogoMIPS: 4000.00  
    Flags: fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush dts acpi mmx fxsr sse sse2 ss ht tm pbe syscall nx pdpe1gb rdtscp lm constant_tsc art arch_per fmon pebs bts rep_good nopl xtopology nonstop_tsc cpuid aperfmperf tsc_known_freq pni pclmulqdq dtes64 monitor ds_cpl vmx smx est tm2 ssse3 sdbg fma cx16 xtpr pdcm pcid dca sse4_1 sse4_2 x2apic movbe popcnt tsc_deadline_timer aes xsave avx f16c rdrand lahf_lm abm 3dnowprefetch cpuid_fault epb cat_l3 cat_l2 cdp_l3 invpcid_single intel_ppin cdp_l2 ssbd mba ibrs ibpb stibp ibrs_enhanced tpr_shadow vnmi flexpriority ept vpid ept_ad fsgsbase tsc_adjust bmi1 avx2 smep bmi2 erms invpcid cqm rdt_a avx512f avx512dq rdseed adx smap avx512ifma clflushopt clwb intel_pt avx512cd sha_ni avx512bw avx512vl xsaveopt xsavec xgetbv1 xsaves cqm_llc cqm_occup_llc cqm_mbm_total cqm_mbm_local split_lock_detect avx_vnni avx512_bf16 wbnoinvd dtherm ida arat pln pts hwp hwp_act_window hwp_epp hwp_pkg_req avx512vbmi umip pku ospke waitpkg avx512_vbmi2 gfni vaes vpclmulqdq avx512_vnni avx512_bitalg tme avx512_vpopcntdq la57 rdpid bus_lock_detect cldemote movdiri movdir64b enqcmd fsrm md_clear serialize tsxldtrk pconfig arch_lbr amx_bf16 avx512_fp16 amx_tile amx_int8 flush_l1d arch_capabilities  
</code></pre>
<p>我们把四台服务器的 IP 地址写到 nodefile
文件中，其中，第一行是主服务器。</p>
<pre><code>cat &lt;&lt; EOF &gt; nodefile  
192.168.20.2  
192.168.21.2  
192.168.22.2  
192.168.23.2  
EOF  
</code></pre>
<p>分布式训练要求主节点和其他节点之间实现无密码 ssh
通信。如果你对此不是很熟悉，可以参考这篇 文章，并跟着它一步步设置好无密码 ssh
。</p>
<p>接下来，我们在每个节点上搭建运行环境并安装所需软件。我们特别安装了两个英特尔优化库: 用于管理分布式通信的 oneCCL 以及 Intel Extension for PyTorch (IPEX)，IPEX 中包含了能充分利用 Sapphire Rapids 中的硬件加速功能的软件优化。我们还安装了 libtcmalloc
，它是一个高性能内存分配库，及其软件依赖项 gperftools
。</p>
<pre><code>conda create -n diffuser python==3.9  
conda activate diffuser  
pip3 install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cpu  
pip3 install transformers accelerate==0.19.0  
pip3 install oneccl_bind_pt -f https://developer.intel.com/ipex-whl-stable-cpu  
pip3 install intel_extension_for_pytorch  
conda install gperftools -c conda-forge -y  
</code></pre>
<p>下面，我们在每个节点上克隆 diffusers 代码库并进行源码安装。</p>
<pre><code>git clone https://github.com/huggingface/diffusers.git  
cd diffusers  
pip install .  
</code></pre>
<p>紧接着，我们需要使用 IPEX 对 diffusers/examples/textual_inversion
中的微调脚本进行一些优化，以将 IPEX 对推理模型的优化包含在内 (译者注: diffusers
的设计中，其 pipeline
与 transformers 的 pipeline
虽然名称相似，但无继承关系，所以其子模型的推理优化无法在库内完成，只能在脚本代码内完成。而 Clip-Text 模型的微调由于使用了 accelerate
，所以其优化可由 accelerate
完成)。我们导入 IPEX 并对 U-Net 和变分自编码器 (VAE) 模型进行推理优化。最后，不要忘了这个改动对每个节点的代码都要做。</p>
<pre><code>diff --git a/examples/textual_inversion/textual_inversion.py b/examples/textual_inversion/textual_inversion.py  
index 4a193abc..91c2edd1 100644  
--- a/examples/textual_inversion/textual_inversion.py  
+++ b/examples/textual_inversion/textual_inversion.py  
@@ -765,6 +765,10 @@ def main():  
     unet.to(accelerator.device, dtype=weight_dtype)  
     vae.to(accelerator.device, dtype=weight_dtype)  
  
+ import intel_extension_for_pytorch as ipex  
+ unet = ipex.optimize(unet, dtype=weight_dtype)  
+ vae = ipex.optimize(vae, dtype=weight_dtype)  
+  
     # We need to recalculate our total training steps as the size of the training dataloader may have changed.  
     num_update_steps_per_epoch = math.ceil(len(train_dataloader) / args.gradient_accumulation_steps)  
     if overrode_max_train_steps:  
</code></pre>
<p>最后一步是下载 训练图像。一般我们会使用共享 NFS 文件夹，但为了简单起见，这里我们选择在每个节点上下载图像。请确保训练图像的目录在所有节点上的路径都相同 ( /home/devcloud/dicoo
)。</p>
<pre><code>mkdir /home/devcloud/dicoo  
cd /home/devcloud/dicoo  
wget https://huggingface.co/sd-concepts-library/dicoo/resolve/main/concept_images/0.jpeg  
wget https://huggingface.co/sd-concepts-library/dicoo/resolve/main/concept_images/1.jpeg  
wget https://huggingface.co/sd-concepts-library/dicoo/resolve/main/concept_images/2.jpeg  
wget https://huggingface.co/sd-concepts-library/dicoo/resolve/main/concept_images/3.jpeg  
wget https://huggingface.co/sd-concepts-library/dicoo/resolve/main/concept_images/4.jpeg  
</code></pre>
<p>下面展示了我们使用的训练图像:</p>
<p><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/mmbiz_jpg/5LJDib8HPR2o5JD2LRGpXfuJAjlqUEROl525LbMRLtZYBZOCuwKSHBuYNPWATsrOOWa0icEOBxRX8Se5UK8GpwtQ/640?wx_fmt=jpeg" alt=""><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/mmbiz_jpg/5LJDib8HPR2o5JD2LRGpXfuJAjlqUEROlr9LZOqxMnmWeYS4tl5bCNUy0gibQGCuHbyiamMgfpv87VzYw9EEfoI6Q/640?wx_fmt=jpeg" alt=""><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/mmbiz_jpg/5LJDib8HPR2o5JD2LRGpXfuJAjlqUEROlY81HaB5v3gSBZOrczwl0s5BiaLlAv16OFvT92aosicG689A2tXibx5hibg/640?wx_fmt=jpeg" alt=""><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/mmbiz_jpg/5LJDib8HPR2o5JD2LRGpXfuJAjlqUEROlr8e6QX8Jibk6UV11xOecWx6Ud6ZEmb5fNPEE7DkP4R7mwGyDibzxpfkQ/640?wx_fmt=jpeg" alt=""><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/mmbiz_jpg/5LJDib8HPR2o5JD2LRGpXfuJAjlqUEROlY0UQBIEStZoXmU1WBWj7TTHaOt9vI8BDOJSXQvccgOA1g4S4sSHOaw/640?wx_fmt=jpeg" alt=""></p>
<p>至此，系统配置就完成了。下面，我们开始配置训练任务。</p>
<h4 id="配置微调环境">配置微调环境</h4>
<p>使用 accelerate 库让分布式训练更容易。我们需要在每个节点上运行 acclerate config
并回答一些简单问题。</p>
<p>下面是主节点的屏幕截图。在其他节点上，你需要将 rank
设置为 1、2 和 3，其他答案保持不变即可。</p>
<p><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/mmbiz_png/5LJDib8HPR2o5JD2LRGpXfuJAjlqUEROlibjzUJX2dYJJdOsk8yXq5icgMFhQ9iad8wUuh9HCRtdYXbE4sQ9WY6sicg/640?wx_fmt=png" alt=""></p>
<p>最后，我们需要在主节点上设置一些环境变量。微调任务启动时，这些环境变量会传播到其他节点。第一行设置连接到所有节点运行的本地网络的网络接口的名称。你可能需要使用 ifconfig
来设置适合你的网络接口名称。</p>
<pre><code>export I_MPI_HYDRA_IFACE=ens786f1  
oneccl_bindings_for_pytorch_path=$(python -c &quot;from oneccl_bindings_for_pytorch import cwd; print(cwd)&quot;)  
source $oneccl_bindings_for_pytorch_path/env/setvars.sh  
export LD_PRELOAD=${LD_PRELOAD}:${CONDA_PREFIX}/lib/libiomp5.so  
export LD_PRELOAD=${LD_PRELOAD}:${CONDA_PREFIX}/lib/libtcmalloc.so  
export CCL_ATL_TRANSPORT=ofi  
export CCL_WORKER_COUNT=1  
  
export MODEL_NAME=&quot;runwayml/stable-diffusion-v1-5&quot;  
export DATA_DIR=&quot;/home/devcloud/dicoo&quot;  
</code></pre>
<p>好了，现在我们可以启动微调了。</p>
<h4 id="微调模型">微调模型</h4>
<p>我们使用 mpirun
启动微调，它会自动在 nodefile
中列出的节点之间建立分布式通信。这里，我们运行 16 个进程 ( -n
)，其中每个节点运行 4 个进程 ( -ppn
)。Accelerate
库会自动在所有进程间建立分布式的训练。</p>
<p>我们启动下面的命令训练 200 步，仅需约 <strong>5 分钟</strong> 。</p>
<pre><code>mpirun -f nodefile -n 16 -ppn 4                                                         \  
accelerate launch diffusers/examples/textual_inversion/textual_inversion.py \  
--pretrained_model_name_or_path=$MODEL_NAME --train_data_dir=$DATA_DIR \  
--learnable_property=&quot;object&quot; --placeholder_token=&quot;&lt;dicoo&gt;&quot; --initializer_token=&quot;toy&quot; \  
--resolution=512 --train_batch_size=1 --seed=7 --gradient_accumulation_steps=1 \  
--max_train_steps=200 --learning_rate=2.0e-03 --scale_lr --lr_scheduler=&quot;constant&quot; \  
--lr_warmup_steps=0 --output_dir=./textual_inversion_output --mixed_precision bf16 \  
--save_as_full_pipeline  
</code></pre>
<p>下面的截图显示了训练过程中集群的状态:</p>
<p><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/mmbiz_png/5LJDib8HPR2o5JD2LRGpXfuJAjlqUEROlHjziaLcicUOuC3VYrrxQ8tUicKy02EMjSvjYibkE2XopgemVqUvjZNzJMA/640?wx_fmt=png" alt=""></p>
<h4 id="排障">排障</h4>
<p>分布式训练有时候会出现一些棘手的问题，尤其是当你新涉足于此。单节点上的小的配置错误是最可能出现的问题: 缺少依赖项、图像存储在不同位置等。</p>
<p>你可以登录各个节点并在本地进行训练来快速定位问题。首先，设置与主节点相同的环境，然后运行:</p>
<pre><code>python diffusers/examples/textual_inversion/textual_inversion.py \  
--pretrained_model_name_or_path=$MODEL_NAME --train_data_dir=$DATA_DIR \  
--learnable_property=&quot;object&quot; --placeholder_token=&quot;&lt;dicoo&gt;&quot; --initializer_token=&quot;toy&quot; \  
--resolution=512 --train_batch_size=1 --seed=7 --gradient_accumulation_steps=1 \  
--max_train_steps=200 --learning_rate=2.0e-03 --scale_lr --lr_scheduler=&quot;constant&quot; \  
--lr_warmup_steps=0 --output_dir=./textual_inversion_output --mixed_precision bf16 \  
--save_as_full_pipeline  
</code></pre>
<p>如果训练成功启动，就停止它并移至下一个节点。如果在所有节点上训练都成功启动了，请返回主节点并仔细检查 nodefile
、环境以及 mpirun
命令是否有问题。不用担心，最终你会找到问题的 :)。</p>
<h4 id="使用微调模型生成图像">使用微调模型生成图像</h4>
<p>经过 5 分钟的训练，训得的模型就保存在本地了，我们可以直接用 diffusers
的 pipeline
加载该模型并进行图像生成。但这里，我们要使用 Optimum Intel 和 OpenVINO 以进一步对模型进行推理优化。正如 <a href="http://mp.weixin.qq.com/s?__biz=Mzk0MDQyNTY4Mw==&amp;mid=2247486355&amp;idx=1&amp;sn=2f6f6386f03890eb09a094ce5f073056&amp;chksm=c2e0a32ff5972a39a1cd6d2e775b959ea58d72a2aeab50bcb72cdac3726808ed85f62585493d&amp;scene=21#wechat_redirect">上一篇文章</a> 中所讨论的，优化后，仅用单颗 CPU 就能让你在不到 5 秒的时间内生成一幅图像！</p>
<pre><code>pip install optimum[openvino]  
</code></pre>
<p>我们用下面的代码来加载模型，并对其针对固定输出形状进行优化，最后保存优化后的模型:</p>
<pre><code>from optimum.intel.openvino import OVStableDiffusionPipeline  
  
model_id = &quot;./textual_inversion_output&quot;  
  
ov_pipe = OVStableDiffusionPipeline.from_pretrained(model_id, export=True)  
ov_pipe.reshape(batch_size=5, height=512, width=512, num_images_per_prompt=1)  
ov_pipe.save_pretrained(&quot;./textual_inversion_output_ov&quot;)  
</code></pre>
<p>然后，我们加载优化后的模型，生成 5 张不同的图像并保存下来:</p>
<pre><code>from optimum.intel.openvino import OVStableDiffusionPipeline  
  
model_id = &quot;./textual_inversion_output_ov&quot;  
  
ov_pipe = OVStableDiffusionPipeline.from_pretrained(model_id, num_inference_steps=20)  
prompt = [&quot;a yellow &lt;dicoo&gt; robot at the beach, high quality&quot;]*5  
images = ov_pipe(prompt).images  
print(images)  
for idx,img in enumerate(images):  
    img.save(f&quot;image{idx}.png&quot;)  
</code></pre>
<p>下面是其生成的图像。令人惊艳的是，模型只需要五张图像就知道 dicoo
是戴眼镜的！</p>
<p><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/mmbiz_png/5LJDib8HPR2o5JD2LRGpXfuJAjlqUEROlS0bs7dqos7v9bbEFAaT17cAzWfwNyLj1Hic0XfjrtThcxAQX4zQhz2A/640?wx_fmt=png" alt=""></p>
<p>你还可以对模型进行更多的微调，以期获得更好的效果。下面是一个经 3 千步 (大约一个小时) 微调而得的模型生成的图像，效果相当不错。</p>
<p><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/mmbiz_png/5LJDib8HPR2o5JD2LRGpXfuJAjlqUEROlRT3OPn1ic7uQHJmWMS51oa2wN66wic9WkQiclicngIxGDuDVJhsFfsccyA/640?wx_fmt=png" alt=""></p>
<h4 id="总结">总结</h4>
<p>得益于 Hugging Face 和英特尔的深度合作，现在大家可以用至强 CPU 服务器来生成满足各自业务需求的高质量图像。而 CPU 通常比 GPU 等专用硬件更便宜且更易得，同时至强 CPU 还是个多面手，它可以轻松地用于其他生产任务，如 Web 服务器、数据库等等不一而足。因此，CPU 理所当然地成为了 IT 基础设施的一个功能全面且灵活的备选方案。</p>
<p>以下资源可供入门，你可按需使用:</p>
<ul>
<li>
<p>Diffusers 文档</p>
</li>
<li>
<p>Optimum Intel 文档</p>
</li>
<li>
<p>GitHub 上的 英特尔 IPEX</p>
</li>
<li>
<p>英特尔和 Hugging Face 的 开发者资源</p>
</li>
<li>
<p>IDC、AWS 、GCP 以及 阿里云 上的第四代至强 CPU 实例</p>
</li>
</ul>
<p>如果你有任何疑问或反馈，欢迎到 Hugging Face 论坛 留言。</p>
<p>感谢垂阅！</p>
<h4 id="heading"></h4>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<p>英文原文: <a href="https://hf.co/blog/stable-diffusion-finetuning-intel">https://hf.co/blog/stable-diffusion-finetuning-intel</a></p>
<p>原文作者: Julien Simon</p>
<p>译者: Matrix Yao (姚伟峰)，英特尔深度学习工程师，工作方向为 transformer-family 模型在各模态数据上的应用及大规模模型的训练推理。</p>
<p>审校/排版: zhongdongy (阿东)</p>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
<p>更多AI工具，参考<a href="https://aibard123.com/">Github-AiBard123</a>，<a href="https://aibard123.com/">国内AiBard123</a></p>



          </div>

可关注我们的公众号：每天AI新工具

<p><img src="/images/aitools/2024/03/qrcode_for_gh_dde1b429630d_258.jpg" alt=""></p>

        </article>

      </div>
    </div>
  </div>
</section>
        </div>
    </div>
    </main>




<script type='text/javascript' src='/assets/js/jquery.ui.touch-punch.min-0.2.2.js' id='jqueryui-touch-js'></script>
<script type='text/javascript' src='/assets/js/clipboard.min-5.6.2.js' id='clipboard-js'></script>
<script type='text/javascript' src='/assets/js/tooltip-extend.js' id='iplaycode-nav-js'></script>
<script type='text/javascript' id='popper-js-extra'>
 

var theme = {"ajaxurl":"","addico":"https:\/\/nav.baidu.cn\/wp-content\/themes\/onenav\/images\/add.png","order":"asc","formpostion":"top","defaultclass":"io-grey-mode","isCustomize":"1","icourl":"","icopng":".png","urlformat":"1","customizemax":"10","newWindow":"0","lazyload":"1","minNav":"1","loading":"1","hotWords":"baidu","classColumns":" col-sm-6 col-md-4 col-xl-5a col-xxl-6a ","apikey":"TWpBeU1UVTNOekk1TWpVMEIvZ1M2bFVIQllUMmxsV1dZelkxQTVPVzB3UW04eldGQmxhM3BNWW14bVNtWk4="};
 
</script>
<script type='text/javascript' src='/assets/js/popper.min.js' id='popper-js'></script>
<script type='text/javascript' src='/assets/js/bootstrap.min-4.3.1.js' id='bootstrap-js'></script>
<script type='text/javascript' src='/assets/js/theia-sticky-sidebar-1.5.0.js' id='sidebar-js'></script>
<script type='text/javascript' src='/assets/js/lazyload.min-12.4.0.js' id='lazyload-js'></script>
<script type='text/javascript' src='/assets/js/fancybox.min-3.5.7.js' id='lightbox-js-js'></script>

<script type='text/javascript' src='/assets/js/app-anim.js' id='appanim-js'></script>

<script type="text/javascript">
    $(document).ready(function(){
        var siteWelcome = $('#loading');
        siteWelcome.addClass('close');
        setTimeout(function() {
            siteWelcome.remove();
        }, 600);
    });
</script>
<script>        
    $(document).ready(function(){
        setTimeout(function () {
            if ($('a.smooth[href="' + window.location.hash + '"]')[0]) {
                $('a.smooth[href="' + window.location.hash + '"]').click();
            }else if (window.location.hash != '') {
                $("html, body").animate({
                    scrollTop: $(window.location.hash).offset().top - 90
                }, {
                    duration: 500,
                    easing: "swing"
                });
            }
        }, 300);
        $(document).on('click','a.smooth',function(ev) {
            if($('#sidebar').hasClass('show') && !$(this).hasClass('change-href')){
                $('#sidebar').modal('toggle');
            }
            if($(this).attr("href").substr(0, 1) == "#"){
                $("html, body").animate({
                    scrollTop: $($(this).attr("href")).offset().top - 90
                }, {
                    duration: 500,
                    easing: "swing"
                });
            }
            if($(this).hasClass('go-search-btn')){
                $('#search-text').focus();
            }
            if(!$(this).hasClass('change-href')){
                var menu =  $("a"+$(this).attr("href"));
                menu.click();
                toTarget(menu.parent().parent(),true,true);
            }
        });
        $(document).on('click','a.tab-noajax',function(ev) {
            var url = $(this).data('link');
            if(url)
                $(this).parents('.d-flex.flex-fill.flex-tab').children('.btn-move.tab-move').show().attr('href', url);
            else
                $(this).parents('.d-flex.flex-fill.flex-tab').children('.btn-move.tab-move').hide();
        });
        
    });
</script>

<script>

(function(){
    if(document.cookie.replace(/(?:(?:^|.*;\s*)night\s*\=\s*([^;]*).*$)|^.*$/, "$1") === ''){
        if(new Date().getHours() > 22 || new Date().getHours() < 6){
            document.body.classList.remove('io-black-mode');
            document.body.classList.add('io-grey-mode');
            document.cookie = "night=1;path=/";
            console.log('夜间模式开启');
        }else{
            document.body.classList.remove('night');
            document.cookie = "night=0;path=/";
            console.log('夜间模式关闭');
        }
    }else{
        var night = document.cookie.replace(/(?:(?:^|.*;\s*)night\s*\=\s*([^;]*).*$)|^.*$/, "$1") || '0';
        if(night == '0'){
            document.body.classList.remove('night');
        }else if(night == '1'){
            document.body.classList.add('night');
        }
    }
})();

$("#search-bg").css("background", "linear-gradient(#e2c4c4, #d8d8d8)");   
function switchNightMode(){
    var night = document.cookie.replace(/(?:(?:^|.*;\s*)night\s*\=\s*([^;]*).*$)|^.*$/, "$1") || '0';
    if(night == '0'){
	$("#search-bg").css("background", "linear-gradient(#e2c4c4, #d8d8d8)");
        document.body.classList.remove('io-grey-mode');
        document.body.classList.add('io-black-mode');
        document.cookie = "night=1;path=/"
        console.log(' ');
        $(".switch-dark-mode").attr("data-original-title","日间模式");
        $(".mode-ico").removeClass("icon-night");
        $(".mode-ico").addClass("icon-light");
    }else{
	$("#search-bg").css("background", "linear-gradient(#4f4040, #1b1d1f)");
        document.body.classList.remove('io-black-mode');
        document.body.classList.add('io-grey-mode');
        document.cookie = "night=0;path=/"
        console.log(' ');
        $(".switch-dark-mode").attr("data-original-title","夜间模式");
        $(".mode-ico").removeClass("icon-light");
        $(".mode-ico").addClass("icon-night");
    }
}
</script>


<script>
    var newsContainer = document.getElementById('news-container');
    var newsItems = document.getElementsByClassName('news-item');
    var currentItem = 0;

    setInterval(function() {
        
        newsItems[currentItem].classList.remove('show');
        newsItems[currentItem].style.transform = 'translateY(-20px)';
        
        currentItem = (currentItem + 1) % newsItems.length;
        newsItems[currentItem].style.transform = 'translateY(' + (newsContainer.offsetHeight - 20) + 'px)';
        setTimeout(function() {
            newsItems[currentItem].classList.add('show');
        }, 500);
    }, 8000);
</script>

</body>
</html>


