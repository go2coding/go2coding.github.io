

<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1" />
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta name="theme-color" content="#f9f9f9" />

	<title>再看法律领域微调模型及外挂知识库问答优化方案：从引入关键词、领域嵌入到知识库细化、意图识别及知识增强项目案例 作者： 老刘说NLP 来源： 老刘说NLP 今天是2023年8月25日，星期五，北京，天气晴。 我们在前面的文章**《也谈如何利用关键词缓解LLM文档问答缺陷及微调大模型生成图数据库执行语句：几个代表工作介绍与总结》** 中，我们介绍了几个有趣的工作，  | AiBard123| ai工具网址导航,ai最新产品</title>
	<link rel="shortcut icon" href="/assets/images/favicon.png" />
    <meta name="keywords" content="chatgpt,AI,AI聊天,AI文本生成,AI绘画,AI编程,AI电商" />
    <meta name="description" content="AiBard123 网址导航 | 免费chatgpt 汇集各类先进的人工智能产品，旨在帮助用户更快速地了解和使用这些产品,轻松地浏览不同领域的AI产品，包括语音识别、图像处理、自然语言处理。" />
    
    <meta name="baidu-site-verification" content="codeva-cCAOSG8MBO" />
    
    <link rel="stylesheet" id="block-library-css"
        href="/assets/css/block-library.min-5.6.2.css" type="text/css" media="all" />
    <link rel="stylesheet" id="iconfont-css" href="/assets/css/iconfont-3.03029.1.css"
        type="text/css" media="all" />

    
    <link href="/scss/style.min.css" rel="stylesheet" />
    
		    <link rel="stylesheet" id="iowen-css" href="/assets/css/style-3.03029.1.css"
        type="text/css" media="all" />
    <link rel="stylesheet" id="custom-css" href="/assets/css/custom-style.css"
        type="text/css" media="all" />
		
		<link rel="stylesheet" href=/plugins/font-awesome/css/font-awesome.min.css />


    <link rel="stylesheet" id="fortawesome-css" href="/assets/fontawesome-5.15.4/css/all.min.css" type="text/css" />


    <script type="text/javascript" src="/assets/js/jquery.min-3.2.1.js" id="jquery-js"></script>
    <script type="text/javascript" src="/assets/js/content-search.js"  id="content-search-js"></script>

    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2073588164294660"
     crossorigin="anonymous"></script>

	
    <script>
        

		var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?8450bc732b2a86f7e4aec4ebd9fd8252";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();

        
    </script>
    

    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-7071W80M2K"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-7071W80M2K');
    </script>

</head>


    <div class="page-container">
	
	<div id="sidebar" class="sticky sidebar-nav fade animate-nav" style="width: 170px">
        
            <div class="modal-dialog h-100 sidebar-nav-inner">
                <div class="sidebar-logo border-bottom border-color">
                    
                    <div class="logo overflow-hidden">
                        <a href="https://aibard123.com/" class="logo-expanded">
                            <img src="/assets/images/bt8-expand-light.png" height="40" class="logo-light"
                                alt="AiBard123| ai工具网址导航,ai最新产品">
                            <img src="/assets/images/bt8-expand-dark.png" height="40" class="logo-dark d-none"
                                alt="AiBard123| ai工具网址导航,ai最新产品">
                        </a>
                        <a href="https://aibard123.com/" class="logo-collapsed">
                            <img src="/assets/images/bt.png" height="40" class="logo-light"
                                alt="AiBard123| ai工具网址导航,ai最新产品">
                            <img src="/assets/images/bt.png" height="40" class="logo-dark d-none"
                                alt="AiBard123| ai工具网址导航,ai最新产品">
                        </a>
                    </div>
                    
                </div>
                <div class="sidebar-menu flex-fill">
                    <div class="sidebar-scroll">
                        <div class="sidebar-menu-inner">
                            <ul>
                                
                                    
                                    <li class="sidebar-item">
                                        <a href="/#00834a9dd147b04c5d53d4368cdb0b57" class="smooth">
                                            <i class="fas fa-sun fa-lg fa-lg icon-fw icon-lg mr-2"></i>
                                            <span>本月热门</span>
                                        </a>
                                    </li>
                                    
                                
                                    
                                    <li class="sidebar-item">
                                        <a href="/#db0311e7ecfedd24d157f0ceb4a0897f" class="smooth">
                                            <i class="fas fa-star-and-crescent fa-lg fa-lg icon-fw icon-lg mr-2"></i>
                                            <span>热门网站</span>
                                        </a>
                                    </li>
                                    
                                
                                    
                                    <li class="sidebar-item">
                                        <a href="/#21b5cbb2c769010fec3ce029a5f8a4a3" class="smooth">
                                            <i class="far fa-star fa-lg icon-fw icon-lg mr-2"></i>
                                            <span>国内热门</span>
                                        </a>
                                    </li>
                                    
                                
                                    
                                    <li class="sidebar-item">
                                        <a href="/#8310718935e8ec25ce0350de01e3f7dc" class="smooth">
                                            <i class="fas fa-phone fa-lg fa-lg icon-fw icon-lg mr-2"></i>
                                            <span>对话工具</span>
                                        </a>
                                    </li>
                                    
                                
                                    
                                    <li class="sidebar-item">
                                        <a href="/#d58e850d9115797306c2edf61ac6ddd8" class="smooth">
                                            <i class="fas fa-newspaper fa-lg fa-lg icon-fw icon-lg mr-2"></i>
                                            <span>写作</span>
                                        </a>
                                    </li>
                                    
                                
                                    
                                    <li class="sidebar-item">
                                        <a href="/#2a7418a5f8f1ca4e054364a9300657df" class="smooth">
                                            <i class="fas fa-image fa-lg fa-lg icon-fw icon-lg mr-2"></i>
                                            <span>图像生成</span>
                                        </a>
                                    </li>
                                    
                                
                                    
                                    <li class="sidebar-item">
                                        <a href="/#7808a68ee1b34dab43011429a12de19e" class="smooth">
                                            <i class="fas fa-image fa-lg fa-lg icon-fw icon-lg mr-2"></i>
                                            <span>图像处理</span>
                                        </a>
                                    </li>
                                    
                                
                                    
                                    <li class="sidebar-item">
                                        <a href="/#6729afc51f5ac49a828812fa0eb0c82f" class="smooth">
                                            <i class="fas fa-video fa-lg fa-lg icon-fw icon-lg mr-2"></i>
                                            <span>音视频</span>
                                        </a>
                                    </li>
                                    
                                
                                    
                                    <li class="sidebar-item">
                                        <a href="/#e5ce844860451fff3faf3d8f8894971d" class="smooth">
                                            <i class="fas fa-music fa-lg fa-lg icon-fw icon-lg mr-2"></i>
                                            <span>音乐生成</span>
                                        </a>
                                    </li>
                                    
                                
                                    
                                    <li class="sidebar-item">
                                        <a href="/#db53804b7d726967c58fcc8c9ca03d27" class="smooth">
                                            <i class="fas fa-language fa-lg fa-lg icon-fw icon-lg mr-2"></i>
                                            <span>办公</span>
                                        </a>
                                    </li>
                                    
                                
                                    
                                    <li class="sidebar-item">
                                        <a href="/#47b7af9547e034d28fe6f6d439968ac8" class="smooth">
                                            <i class="fas fa-copy fa-lg fa-lg icon-fw icon-lg mr-2"></i>
                                            <span>提示词</span>
                                        </a>
                                    </li>
                                    
                                
                                    
                                    <li class="sidebar-item">
                                        <a href="/#41282bf95e43c64d579757573a03cdde" class="smooth">
                                            <i class="fas fa-code fa-lg fa-lg icon-fw icon-lg mr-2"></i>
                                            <span>编程</span>
                                        </a>
                                    </li>
                                    
                                
                                    
                                    <li class="sidebar-item">
                                        <a href="/#fd71852fd52d5e18ef4f9a252f1eac58" class="smooth">
                                            <i class="fas fa-search fa-lg fa-lg icon-fw icon-lg mr-2"></i>
                                            <span>AI搜索</span>
                                        </a>
                                    </li>
                                    
                                
                                    
                                    <li class="sidebar-item">
                                        <a href="/#81b1637fbe47625dbdf2094acd3b6683" class="smooth">
                                            <i class="fas fa-language fa-lg fa-lg icon-fw icon-lg mr-2"></i>
                                            <span>文本翻译</span>
                                        </a>
                                    </li>
                                    
                                
                                    
                                    <li class="sidebar-item">
                                        <a href="/#2e9ba3fa6e1ed0e9311b3e97f97f9a40" class="smooth">
                                            <i class="fas fa-book fa-lg fa-lg icon-fw icon-lg mr-2"></i>
                                            <span>学习网站</span>
                                        </a>
                                    </li>
                                    
                                
                            </ul>           
                        </div>
                    </div>
                </div>
                <div class="border-top py-2 border-color">
                    <div class="flex-bottom">
                        <ul>
			    <li id="menu-item-212"
                                 class="menu-item menu-item-type-custom menu-item-object-custom menu-item-212 sidebar-item">
                                 <a href="#friendlink" class="smooth">
                                     <i class="fab fa-staylinked icon-fw icon-lg mr-2"></i>
                                     <span>友情链接</span>
                                 </a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>


<div class="flex-fill grid-bg">
    <div class="big-header-banner">
        <div id="header" class="page-header sticky">
            <div class="navbar navbar-expand-md">
                <div class="container-fluid p-0">

                    <a href="" class="navbar-brand d-md-none" title="AiBard123| ai工具网址导航,ai最新产品">
                        <img src="/assets/images/bt.png" class="logo-light"
                            alt="AiBard123| ai工具网址导航,ai最新产品">
                        <img src="/assets/images/bt.png" class="logo-dark d-none"
                            alt="AiBard123| ai工具网址导航,ai最新产品">
                    </a>

                    <div class="collapse navbar-collapse order-2 order-md-1">
                        <div class="header-mini-btn">
                            <label>
                                <input id="mini-button" type="checkbox">
                                <svg viewbox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                                    <path class="line--1" d="M0 40h62c18 0 18-20-17 5L31 55"></path>
                                    <path class="line--2" d="M0 50h80"></path>
                                    <path class="line--3" d="M0 60h62c18 0 18 20-17-5L31 45"></path>
                                </svg>
                            </label>

                        </div>

                        <ul class="navbar-nav site-menu" style="margin-right: 16px;">
                        
			<li >
				<a href="/">
                                    <i class="fa fa-home fa-lg mr-2"></i>
                                    <span>首页</span>
                                </a>
				<ul class="sub-menu">
				
				</ul>
			    </li>
			
			</ul>

                        
                        <div class="rounded-circle weather">
                            <div id="he-plugin-simple" style="display: contents;"></div>
                            <script>WIDGET = {
                                    CONFIG: {
                                        "modules": "01234",
                                        "background": 5,
                                        "tmpColor": "008000",
                                        "tmpSize": 14,
                                        "cityColor": "008000",
                                        "citySize": 14,
                                        "aqiColor": "#008000",
                                        "aqiSize": 14,
                                        "weatherIconSize": 24,
                                        "alertIconSize": 18,
                                        "padding": "10px 10px 10px 10px",
                                        "shadow": "1",
                                        "language": "auto",
                                        "borderRadius": 5,
                                        "fixed": "false",
                                        "vertical": "middle",
                                        "horizontal": "left",
                                        "key": "085791e805a24491b43b06cf58ab31e7"
                                    }
                                }
                            </script>
                            <script src="https://widget.qweather.net/simple/static/js/he-simple-common.js?v=2.0"></script>
                        </div>
                        
                    </div>

                    <ul class="nav navbar-menu text-xs order-1 order-md-2">
                        
                        
                        <li class="nav-item mr-3 mr-lg-0 d-none d-lg-block">
                            <script>
                                fetch('https://v1.hitokoto.cn')
                                    .then(response => response.json())
                                    .then(data => {
                                    const hitokoto = document.getElementById('hitokoto_text')
                                    hitokoto.href = 'https://hitokoto.cn/?uuid=' + data.uuid
                                    hitokoto.innerText = data.hitokoto
                                    })
                                    .catch(console.error)
                            </script>                           
                            <div id="hitokoto"><a href="#" target="_blank" id="hitokoto_text">疏影横斜水清浅，暗香浮动月黄昏。</a></div>
                        </li>
                        
                        
                        <li class="nav-search ml-3 ml-md-4">
                            <a href="javascript:" data-toggle="modal" data-target="#search-modal"><i
                                    class="iconfont icon-search icon-2x"></i></a>
                        </li>
                        <li class="nav-item d-md-none mobile-menu ml-3 ml-md-4">
                            <a href="javascript:" id="sidebar-switch" data-toggle="modal"
                                data-target="#sidebar"><i class="iconfont icon-classification icon-2x"></i></a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
        <div class="placeholder" style="height:74px"></div>
    </div>




<body class="page-body boxed-container  io-grey-mode">
    <main role="main" class="flex-shrink-0">
    <div class="container">
        
        <div class="content">
            <style>
    body{
	    background: #f9f9f9;
	}

    h1, h2, h3, h4, h5, h6 {
        margin-top: 1.5rem;
        margin-bottom: 1.5rem;
    }


 
@media (min-width: 1000px) {
  .container, .container-sm {
    max-width: 800px;
  }
}

</style>

<div class="featured-post-content">

    <a href="/digest/" class="featured-post-title">
       AI 文摘
    </a>

</div>

<section class="blog-single">
  <div class="container">
    <div class="row">

      <div class="col-lg-12 order-1 order-lg-2">
        <article class="single-blog">
          <p class="title">再看法律领域微调模型及外挂知识库问答优化方案：从引入关键词、领域嵌入到知识库细化、意图识别及知识增强项目案例</p>
            <br/>
          <ul class="meta">
            <li>
              By <a href=https://aibard123.com/about>AiBard123</a>
            </li>
            <li>
              <i class="fa fa-clock-o"></i>
              August 25, 2023 - 2 min read
            </li>
          </ul>

          <div class="_1NCGf">
              <img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/sz_mmbiz_png/fUBU1yiaEmJh3LOOecE18QruDYgNdqmAbkMXqOvQvRiaiapPuzymo0fqiaFG5nlibFPZTDWy7jFMTTiaCFjnVSDFQTPg/640?wx_fmt=png" width="640" >
          </div>
            <br>
            <br>
            <br>
          
          <div class="single-blog-content">
            <p>作者： 老刘说NLP  来源： <a href="https://mp.weixin.qq.com/s/aMooPwnRUsM8UUyjscJAxA">老刘说NLP</a></p>
<p>今天是2023年8月25日，星期五，北京，天气晴。</p>
<p>我们在前面的文章**《也谈如何利用关键词缓解LLM文档问答缺陷及微调大模型生成图数据库执行语句：几个代表工作介绍与总结》** 中，我们介绍了几个有趣的工作，包括ChatLaw。</p>
<p>为了缓解<strong>单纯使用向量检索出现结果不相关</strong> 的问题，Keyword LLM用于将用户口语化的诉求转化为法律行业关键词，并用于检索知识库中的法律知识，这个实际上是<strong>通过提取关联词的方案来加入一些限定的文档主题信息</strong> ，而关于关键词提取。</p>
<p>而最近开源外挂的方案越来越多，最近看到一个工作，zhihaiLLM：github.com/zhihaiLLM/wisdomInterrogatory，其实现了之前所说的知识库细化、意图识别分发、关键词与向量化多路召回的知识库完整链路，是个很好的示范，但也有很多的优化空间，比如向量化做的更好、多路召回做投票、如何做更细致的标签等等。‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍</p>
<p>值得我们借鉴的是，其知识库细化、意图识别分发、关键词与向量化多路召回的知识库的具体实现细节，包括数据的构成等，都是可以受益的点。</p>
<p>而进一步的，截至到现在，法律类的大模型已经达到了7个：‍</p>
<p><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/sz_mmbiz_png/fUBU1yiaEmJh3LOOecE18QruDYgNdqmAb43OY2UY5ibULfL44OwXZh0uKoVVyJuticFnereTFtZJ7tbx6tAEX6g4Q/640?wx_fmt=png" alt=""></p>
<p>LawGPT-zh：https://github.com/LiuHC0428/LAW-GPT</p>
<p>LaWGPT：https://github.com/pengxiao-song/</p>
<p>lawyer-llama：https://github.com/AndrewZhe/lawyer-llama</p>
<p>HanFei：https://github.com/siat-nlp/HanFei</p>
<p>LexiLaw：https://github.com/CSHaitao/LexiLaw</p>
<p>ChatLaw：https://github.com/PKU-YuanGroup/ChatLaw</p>
<p>wisdomInterrogatory：https://github.com/zhihaiLLM/wisdomInterrogatory</p>
<p>这些开源方案都很有意思，尤其是现在大家发现，靠检索太容易带偏，里面的水还挺深的，本文主要从ChatLaw引入关键词和领域嵌入提升召回相关性、zhihaiLLM融合意图识别、知识检索的问答方案、zhihaiLLM外挂知识数据的构成与构造方案、zhihaiLLM知识增强的三个关键步骤及源码实现等几个角度进行介绍，供大家一起参考。</p>
<h4 id="一chatlaw引入关键词和领域嵌入提升召回相关性">一、ChatLaw引入关键词和领域嵌入提升召回相关性‍‍‍‍‍‍‍‍‍‍‍‍‍‍</h4>
<p>文章https://zhuanlan.zhihu.com/p/641561673中介绍了当前chatlaw的实现方案，与标准的Langchain方案不同，作者认为，现在的组成实际是ChatLaw=ChatLawLLM+ keyword LM+lawsLLM，属于一种集成式的方案。</p>
<p><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/sz_mmbiz_png/fUBU1yiaEmJiaIDQVgJTUbAMeGyKnckeqQM8O9iaXr6LJMTgneYicia9JIkMOsIsvDeVMPBxMLcmYnibWuKtxzpwwtfA/640?wx_fmt=png&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt=""></p>
<p>如上图所示，</p>
<p>首先，为了缓解<strong>单纯使用向量检索出现结果不相关</strong> 的问题，Keyword LLM用于将用户口语化的诉求转化为法律行业关键词，并用于检索知识库中的法律知识。</p>
<p>实际上，作者最初尝试了利用MySQL和Elasticsearch进行检索的传统方案，但效果不佳，所以单独微调了一个LLM来抽取user queries的keywords，然后分别遍历keywords进行embedding，与用户输入input的embedding进行拼接，执行召回。</p>
<p>这个实际上是<strong>通过提取关联词的方案来加入一些限定的文档主题信息</strong> ，而关于关键词提取，我们在前面介绍过TFIDF，TextRank传统方案，以及Keybert等有监督方案，这些都可以尝试。而对于使用LLM进行关键词提取的，工作较少，作者提到了一个商品观点关键词提取的类似项目，可以参考：</p>
<p>地址：https://huggingface.co/JessyTsu1/comment_opinion_extract_ChatGLM_base</p>
<p>该模型利用5000条淘宝评论数据训练，先使用GPT4通过prompt抽取数据的关键词，经过清洗再使用ChatGLM进行训练。效果如下：</p>
<p><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/sz_mmbiz_png/fUBU1yiaEmJiaIDQVgJTUbAMeGyKnckeqQDNkHD8vxg7hRAKmOtIibd1fHSg7ib50tGLtJNmKeaUuEoqJLbJt3hiaUQ/640?wx_fmt=png&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt=""></p>
<p>其次，由于领域语料的问题，通用的embedding可能效果交差，所以搞了一个专门的embedding模型，Law LLM，其底层采用BERT对一些法律数据如文书，法规等进行训练，采用的是9.37k个国家判例法示例的数据集【数量级并不多】</p>
<p>该模型用于对user queries以及关键词keywords进行向量化，提取相应的法律规定和司法解释参考文献。提取的过程为：遍历每个关键词，取关键词embddding和用户输入embedding做拼接【并设定阈值alpha做加权】，再与知识库的每个文章做相似度计算，每个文章的得分为与所有关键词+用户输入拼接向量相似度之和【这个的逻辑是能够照顾到所有的关键主题信息】，然后按照从大到小顺序进行排列，最终取TopK作为上下文。</p>
<p>最后，ChatLaw LLM对检索出来的结果进行分析，参考相关的法律条款，输出结果。</p>
<p>2、细化文档标签的检索相关性提升</p>
<p>第二篇工作https://zhuanlan.zhihu.com/p/641132245，针对LLM+Embedding构建问答系统的局限性及优化方案进行了总结，该工作指出了当前单纯使用向量化方法进行召回存在的一些问题。</p>
<p>例如，相似度阈值不易控制。</p>
<p>一般而言，相似度阈值过高或topk【最终保留的文档数】过低，会导致某些有效知识点无法命中，反之，很多无效知识点、不相关的内容与噪声会被引入。再加上最大输入长度的限制，通常会截断处理，容易遗漏相似度较低但有效的知识点。</p>
<p>为了避免召回结果有遗漏，就需要<strong>降低</strong> 相似度评分下限，甚至同时提高召回结果数量上限(top k)，这样会带来明显的问题，包括召回结果有效信息密度大幅降低，并且长度很长，既慢又花钱。</p>
<p>因此，我们会发现，这个本质上就是一个相关性搜索的问题，所以评论区有些精彩评论：</p>
<p>“感觉检索阶段已经做好了精确搜索了，按照文中的这种例子，检索出来的答案直接展示就好，感觉不必在过一遍LLM。”</p>
<p>“为啥不多路召回，搜索场景非常常用的做法，向量召回效果不一定好，传统方法不能完全丢弃。”</p>
<p>所以，这一套方案的根本，其实还是在如何找到相关性的上下文。</p>
<p>但是，很不幸的是，但文档数很多时，相关性计算上会收到很大挑战。</p>
<p>因此，可以采用的方案是细化文档标签，以提升搜索相关性。<strong>例如，对文本进行分类，对于金融领域文本，根据板块进行分类，分成金融、法律、医疗等，也可以进一步细分为金融财务、金融审查、金融数据等多个标签，这样能够更好地缩小检索的问题域。</strong></p>
<p>那么， 什么是关键词和主题词呢？</p>
<p>关键词由作者自定义或自动分析提取，通常是可以高度概括该文章主题的，<strong>使用关键词搜索可搜出更加明确的主题方向的文章。</strong> 主题词是由机构定义和发布的规范词，通常是专有名词或名词短语；主题词<strong>检索结果包括检索词的近义词、同义词以及同一概念词的不同书写形式等，通过主题词检索可以很大程度降低漏检和误检。</strong></p>
<p>其中，对于主题词，可以采用结合依存的提取、基于成分句法分析的方法等进行，这些在我们早期的文章也有说过，可以查找进一步地看**。**</p>
<p><strong>而关于基于关键词的做法跟基于向量的方法，两者是做串行组合【先粗排，再精排】，还是并行组合【投票法取最大】，还是说如第一种方法同时转换为向量化操作，这些则需要我们根据具体业务，具体分析。</strong></p>
<h4 id="二zhihaillm融合意图识别知识检索的问答方案">二、zhihaiLLM融合意图识别、知识检索的问答方案‍‍‍‍‍‍‍</h4>
<p>智海-录问(wisdomInterrogatory)是由浙江大学、阿里巴巴达摩院以及华院计算三家单位共同设计研发的法律大模型，模型基座采用Baichuan-7B，在此基础上，进行了二次预训练以及指令微调训练。</p>
<p>地址：github.com/zhihaiLLM/wisdomInterrogatory</p>
<p>二次预训练阶段，采用包括法律文书、司法案例以及法律问答数据，共40G数据。训练数据的样例如下：</p>
<pre><code>{&quot;text&quot;: &quot;为一本关于被红眼生物诅咒的家族的恐怖小说生成一个引人入胜且独特的标题。&quot;}  
{&quot;text&quot;: &quot;这个算法的工作原理是循环遍历数组中的每个元素，找到它后面所有未排序元素中的最小值&quot;}  
</code></pre>
<p>其中，法律领域数据占总体数据的30%，通用数据占总体数据的70%。通用数据中，英文数据和中文数据各占50%。</p>
<p>通用数据上，英文数据包括LIMA 、OpenOrca 、ShareGPT等，中文数据包括BELLE 、MOSS等。</p>
<p>微调阶段的训练数据如下：</p>
<pre><code>{&quot;text&quot;: &quot;\n\nHuman: 为一本关于被红眼生物诅咒的家族的恐怖小说生成一个引人入胜且独特的标题。\n\nAssistant: 《鬼怪之眼：被诅咒的血脉》&quot;}  
  
{&quot;text&quot;: &quot;\n\nHuman: 用“勇气”、“诱惑”和“命运”这三个词写一首诗。\n\nAssistant: 雄心壮志，奋发有为，\n勇气汇聚心间，\n勇往直前。。。&quot;}  
</code></pre>
<p>在数据收集与筛选方面，对数据进行去重和清洗，通过条件过滤去除低质量的数据和重复数据。</p>
<p>同时对数据进行聚类和下采样。先使用Sentence-BERT对数据进行句子嵌入，然后对嵌入向量进行正则化和降维。之后利用KMeans算法对数据进行聚类，并在聚类簇中使用KCenter算法进行降采样。</p>
<h4 id="三zhihaillm外挂知识数据的构成与构造方案">三、zhihaiLLM外挂知识数据的构成与构造方案</h4>
<p>在增强知识库数据方面，一共收集6种类型的知识库，包括法条类、案例类、模板类、书籍类、法律考试类、法律日常问答类。</p>
<p><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/sz_mmbiz_png/fUBU1yiaEmJh3LOOecE18QruDYgNdqmAb2COibdMFEhW2Kjgib6Y72HwYTQNgbGp2I3m0tRXrpKIpmicqAicH8cBXcA/640?wx_fmt=png" alt=""></p>
<p>其中，在知识库收集与处理上，</p>
<p><strong>1、法条库</strong></p>
<p>包含宪法、法律（宪法相关法、民商法、刑法、经济法、行政法、社会法、诉讼与非诉讼程序法）、司法解释、地方性法规（浙江、河南、北京、广东、重庆、山东、上海）、监察法规和行政法规。将这类文件输出为多个txt文件，其中刑法是json文件，key是标题，value是内容。</p>
<pre><code>{  
    &quot;key0&quot;:&quot;《公益事业捐赠法(1999-06-28)》 第五条&quot;,  
    &quot;key&quot;:&quot;《公益事业捐赠法(1999-06-28)》 第五条 捐赠财产的使用应当尊重捐赠人的意愿，符合公益目的，不得将捐赠财产挪作他用。&quot;,  
    &quot;value&quot;:&quot;《公益事业捐赠法(1999-06-28)》 第五条 捐赠财产的使用应当尊重捐赠人的意愿，符合公益目的，不得将捐赠财产挪作他用。&quot;  
}  
  
{  
    &quot;key0&quot;:&quot;《劳动法(2018-12-29)》 第四十三条&quot;,  
    &quot;key&quot;:&quot;《劳动法(2018-12-29)》 第四十三条 用人单位不得违反本法规定延长劳动者的工作时间。&quot;,  
    &quot;value&quot;:&quot;《劳动法(2018-12-29)》 第四十三条 用人单位不得违反本法规定延长劳动者的工作时间。&quot;  
}  
</code></pre>
<p><strong>2、法律文书模版库</strong></p>
<p>包含民法、刑法和行政法三大部门法的起诉状、上诉状、法院判决书模版，以及合同等常用法律文书模版。</p>
<p>由于模版通常较长，因此通过ChatGPT总结得到文书模版的书写要点。最后得到一个json文件，key是文书标题，value是文书标题和要点。</p>
<p>数据样式如下：</p>
<p>{ &ldquo;民事起诉状&rdquo;: &ldquo;民事起诉状 要点包括：涉案当事人基本信息，法定代理人和委托代理人，诉讼请求，事实与理由，证据及来源，法院名称、附件副本及起诉人签名。&rdquo;, &ldquo;行政上诉状&rdquo;: &ldquo;行政上诉状 要点包括：上诉人、被上诉人基本信息，案由，不服原审判决的上诉，上诉请求，上诉理由，法院名称，上诉人签名，日期。&rdquo; }</p>
<p><strong>3、法学书籍库</strong></p>
<p>涵盖民法, 国际私法, 环境资源法, 法理学, 国际经济法, 中国特色社会主义法治理论, 民事诉讼法, 刑法, 刑事诉讼法, 司法制度和法律职业道德, 商法, 劳动与社会保障法, 宪法, 行政法与行政诉讼法, 国际法, 知识产权法, 经济法, 中国法律史等领域。</p>
<p>根据标题处理为多个txt文件以及与其对应的json文件，key是标题，value是内容。</p>
<p>法律学.txt，数据样式如下：</p>
<p><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/sz_mmbiz_png/fUBU1yiaEmJh3LOOecE18QruDYgNdqmAbEDsU0kqjdCvewj3T18FyzB5dH31VMsicTTx6NlibmwhwuB1icq2sqZYDw/640?wx_fmt=png" alt=""></p>
<p>法律学.json，数据样例如下：</p>
<p>&ldquo;法的起源与历史类型 法的产生&rdquo;: &ldquo;法作为一种文明现象，是人类历史发展到一定阶段的产物。马克思主义法学认为，法不是从来就有的，也不是永恒存在的，它是人类历史发展到奴隶社会阶段才出现的社会现象。法是随着生产力的提高.社会经济的发展.私有制和阶级的产生.国家的出现而产生的，经历了一个长期的渐进的过程。法产生的主要标志包括国家的产生.权利和义务观念的形成以及法律诉讼和司法审判的出现。原始社会没有法律，人们的生活由习惯和宗教等原始规范予以调整。法律产生之后，逐步在社会生活中发挥着越来越重要的作用。法律与原始社会规范相比，两者之间存在如下区别:法律与原始社会规范相比，两者之间存在如下区别:1.产生的方式不同。法是由国家制定或认可的，原始社会规范是先民在长期的生产和生活过程中自发形成的。法律与原始社会规范相比，两者之间存在如下区别:2.反映的利益和意志不同。法反映统治阶级的利益和意志，原始社会规范反映原始社会全体成员的利益和意志。法律与原始社会规范相比，两者之间存在如下区别:3.实施的机制不同。法以国家强制力保证实施，原始社会规范主要依靠社会舆论.传统力量和氏族部落领袖的威信保证实施。法律与原始社会规范相比，两者之间存在如下区别:4.适用的范围不同。法适用于国家主权范围内的所有居民，原始社会规范只适用于相同血缘的本氏族部落成员。&rdquo;,</p>
<p><strong>4、案例库</strong></p>
<p>包含刑法、民法领域中的大量案例。由于案件事实通常较长，因此通过ChatGPT将案件事实总结成【主观动机】、【客观行为】以及【事外情节】三个部分。最后得到一个json文件，key是案件事实，value是事实和判决结果。</p>
<p>数据样式如下：</p>
<p>&ldquo;案件事实<strong>主观动机：</strong> 被告人雷某军故意容留他人吸食毒品。<strong>客观行为</strong> ：被告人雷某军多次提供场所、吸毒工具容许他人吸食毒品，并被公安机关抓获。。<strong>事外情节</strong> ：无（该示例来自司法部）&rdquo;: &ldquo;案件事实 主观动机：被告人雷某军故意容留他人吸食毒品。客观行为：被告人雷某军多次提供场所、吸毒工具容许他人吸食毒品，并被公安机关抓获。。事外情节：无（该示例来自司法部）。判决：该犯罪事实相关的法条是《中华人民共和国刑法》第354条，罪名是容留他人吸毒罪。&rdquo;,</p>
<p><strong>5、法考题库</strong></p>
<p>包含2016年到2020年的1200题考题、选项、解析和答案。一个json文件，key是问题，value是问题、选项、解析和答案。</p>
<p>数据样式如下：</p>
<p>&ldquo;春秋时期，针对以往传统法律体制的不合理性，出现了诸如晋国赵鞅“铸刑鼎”，郑国执政子产“铸刑书”等变革活动。对此，下列哪一说法是正确的？&rdquo;: &ldquo;春秋时期，针对以往传统法律体制的不合理性，出现了诸如晋国赵鞅“铸刑鼎”，郑国执政子产“铸刑书”等变革活动。对此，下列哪一说法是正确的？A.晋国赵鞅“铸刑鼎”为中国历史上首次公布成文法B.奴隶主贵族对公布法律并不反对，认为利于其统治C.打破了“刑不可知，则威不可测”的壁垒D.孔子作为春秋时期思想家，肯定赵鞅“铸刑鼎”的举措。答案为C。解析为中国历史上首次公布成文法是郑国子产“铸刑书”的活动，晋国赵鞅“铸刑鼎”是第二次公布成文法的活动。成文法的公布，打破了“刑不可知，则威不可测”的传统，对奴隶贵族操纵和使用法律的特权形成严重冲击。因此，引起了奴隶主贵族的强烈指责。一心希望回到“三孔”时期的孔子对于公布成文法的活动也进行了抨击。故ABD选项错误，C选项正确。综上，本题正确答案为C选项。&rdquo;,</p>
<p><strong>6、法律问答库</strong></p>
<p>包含几千条法律领域的常见问题和答案数据。处理成为一个json文件，key是问题，value是答案。</p>
<p>数据样式如下：</p>
<p>&ldquo;在任何户籍所在地都能办理离婚。我们结婚证在江苏在湖南能办理离婚吗?&rdquo;: &ldquo;是的，任何户籍所在地都能办理离婚，结婚证在江苏，在湖南也可以办理离婚。&rdquo;,</p>
<p>任何一个知识点都是一个[key, value]的pair，其中：<strong>key是该知识点的内容简介，用于检索，value是知识点的具体内容，用于输入到模型中作为参考</strong> 。</p>
<h4 id="四zhihaillm知识增强的三个关键步骤及源码实现">四、zhihaiLLM知识增强的三个关键步骤及源码实现</h4>
<p>整个知识增强的方案如下图所示，包括意图识别、知识检索以及知识融合三个关键步骤：</p>
<p><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/sz_mmbiz_png/fUBU1yiaEmJh3LOOecE18QruDYgNdqmAbkMXqOvQvRiaiapPuzymo0fqiaFG5nlibFPZTDWy7jFMTTiaCFjnVSDFQTPg/640?wx_fmt=png" alt=""></p>
<p><strong>1、意图识别</strong></p>
<p>在意图识别（多步检索）上，不同问题需要不同类型的知识库来辅助问答，首先需要识别出问题意图获取哪些知识。</p>
<p>通过问题中的关键词和上述五种类型知识库的特征的关键词匹配，以此识别出问题涉及的知识类型并用对应知识库辅助。</p>
<p>五种类型知识库的特征关键词如下：</p>
<p>具体详细见：<strong>app/langchain_demo/data/cache/intention_reg.json</strong></p>
<p>{&ldquo;法律法条&rdquo;: [&ldquo;法律&rdquo;,&ldquo;法条&rdquo;,&ldquo;判罚&rdquo;,&ldquo;罪名&rdquo;,&ldquo;刑期&rdquo;,&ldquo;本院认为&rdquo;,&ldquo;观点&rdquo;,&ldquo;条文&rdquo;,&ldquo;条款&rdquo;,&ldquo;案由&rdquo;,&ldquo;定罪&rdquo;,&ldquo;量刑&rdquo;,&ldquo;法院观点&rdquo;,&ldquo;法官意见&rdquo;,&ldquo;条例&rdquo;,&ldquo;规定&rdquo;,&ldquo;执法依据&rdquo;,&ldquo;法规&rdquo;,&ldquo;罪责&rdquo;,&ldquo;量刑&rdquo;,&ldquo;诉讼&rdquo;,&ldquo;立法&rdquo;], &ldquo;法律书籍&rdquo;: [&ldquo;依据&rdquo;,&ldquo;法律读物&rdquo;,&ldquo;法学著作&rdquo;,&ldquo;法律参考书&rdquo;,&ldquo;法典&rdquo;,&ldquo;法规&rdquo;,&ldquo;参考书&rdquo;,&ldquo;读本&rdquo;,&ldquo;丛书&rdquo;,&ldquo;法理&rdquo;,&ldquo;法学&rdquo;,&ldquo;法哲学&rdquo;,&ldquo;法学家&rdquo;,&ldquo;著作&rdquo;,&ldquo;文献&rdquo;,&ldquo;学说&rdquo;,&ldquo;学术&rdquo;], &ldquo;法律文书模板&rdquo;: [&ldquo;文书&rdquo;,&ldquo;起诉书&rdquo;,&ldquo;法律文书&rdquo;,&ldquo;起诉状&rdquo;,&ldquo;判决书&rdquo;,&ldquo;裁定书&rdquo;,&ldquo;答辩状&rdquo;,&ldquo;法律合同&rdquo;,&ldquo;协议&rdquo;,&ldquo;证据&rdquo;,&ldquo;证明&rdquo;,&ldquo;合同&rdquo;,&ldquo;格式&rdquo;,&ldquo;模板&rdquo;,&ldquo;样本&rdquo;,&ldquo;规范&rdquo;,&ldquo;范本&rdquo;], &ldquo;法律案例&rdquo;: [&ldquo;法律&rdquo;,&ldquo;判罚&rdquo;,&ldquo;事实&rdquo;,&ldquo;案例&rdquo;,&ldquo;罪名&rdquo;,&ldquo;刑期&rdquo;,&ldquo;本院认为&rdquo;,&ldquo;观点&rdquo;,&ldquo;法律案件&rdquo;,&ldquo;典型案例&rdquo;,&ldquo;案情&rdquo;,&ldquo;案由&rdquo;,&ldquo;定罪&rdquo;,&ldquo;量刑&rdquo;,&ldquo;证据&rdquo;,&ldquo;判例&rdquo;,&ldquo;裁决&rdquo;,&ldquo;仲裁&rdquo;,&ldquo;先例&rdquo;,&ldquo;判决&rdquo;,&ldquo;司法&rdquo;], &ldquo;法律考试&rdquo;: [&ldquo;选项&rdquo;,&ldquo;选择&rdquo;,&ldquo;A,B,C,D&rdquo;,&ldquo;ABCD&rdquo;,&ldquo;A,B,C和D&rdquo;,&ldquo;考试&rdquo;,&ldquo;题目&rdquo;,&ldquo;法考&rdquo;,&ldquo;法律考试&rdquo;,&ldquo;考题&rdquo;,&ldquo;选择题&rdquo;,&ldquo;判断题&rdquo;,&ldquo;多选题&rdquo;,&ldquo;单选题&rdquo;,&ldquo;填空题&rdquo;,&ldquo;辨析题&rdquo;,&ldquo;案例分析题&rdquo;,&ldquo;答案&rdquo;,&ldquo;试题&rdquo;,&ldquo;试卷&rdquo;,&ldquo;法学&rdquo;,&ldquo;考研&rdquo;,&ldquo;司法考试&rdquo;,&ldquo;律师考试&rdquo;]}</p>
<p>通过识别问题意图，缩小需要检索的知识库范围，减少易混淆知识带来的影响，提升检索精确度。</p>
<p>如下图所示：</p>
<p><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/sz_mmbiz_png/fUBU1yiaEmJh3LOOecE18QruDYgNdqmAbdd1gPFw6cnmUFrb0YpKbsW8Tcibpn262YTtKF7HibC9Ic7nIXIYDsHnQ/640?wx_fmt=png" alt=""></p>
<p><strong>2、知识检索</strong></p>
<p>在知识检索（多路检索）上，同时采用<strong>统计特征层面的检索和语义特征层面的检索</strong> 。</p>
<p>对于统计特征，<strong>预先提取知识库中每条知识的关键词，比如法条库中每条法条的关键词是所属法律和法条条数</strong> ，使用fuzzy matching提取问题中的关键词和知识关键词匹配获取相关知识，匹配的逻辑如下图所示：</p>
<pre><code>import json  
from fuzzywuzzy import process  
import os  
import re  
  
## 基于关键词匹配实现意图分类  
def key_words_match_intention(input):  
    kg_names = set()  
    with open(&quot;app/langchain_demo/data/cache/intention_reg.json&quot;, &quot;r&quot;) as f:  
        dic = json.load(f)  
        for key,val in dic.items():  
            for el in val:  
                if el in input:  
                    kg_names.add(key)  
    return kg_names
## 初始化article 
def init_all_articles():
    &quot;&quot;&quot;{ &quot;key0&quot;:&quot;《劳动法(2018-12-29)》 第四十三条&quot;,    &quot;key&quot;:&quot;《劳动法(2018-12-29)》 第四十三条 用人单位不得违反本法规定延长劳动者的工作时间。&quot;,    &quot;value&quot;:&quot;《劳动法(2018-12-29)》 第四十三条 用人单位不得违反本法规定延长劳动者的工作时间。&quot;} &quot;&quot;&quot;
    art_dir = &quot;app/langchain_demo/data/cache/legal_articles&quot;  
    dic_all = {}  
    choices = []  
    for doc in os.listdir(art_dir):  
        if doc.endswith('.json'):  
            # print(doc)  
            with open(os.path.join(art_dir,doc),&quot;r&quot;) as f:  
                lines = f.readlines()  
                for line in lines:  
                    data = json.loads(line)  
                    dic_all[data[&quot;key0&quot;]] = data[&quot;value&quot;]  
                    choices.append(data[&quot;key0&quot;].split(&quot; &quot;)[0])   
    choices = list(set(choices))  
    return dic_all, choices  
## 抽取出具体法条  
def key_words_match_knowledge(dic_all, choices, query):  
    result_title = process.extract(query, choices, limit=1)  
    match = re.search(r'第(\S+)条', query)  
    if match:  
        result_num = match.group(1)  
        key0 = result_title[0][0]+&quot; 第&quot;+ result_num +&quot;条&quot;  
        if key0 in dic_all.keys():  
            return (key0, dic_all[key0])  
    return   
</code></pre>
<p>里面使用fuzzey matching的逻辑在于，其可以高效地完成关键词匹配，代码如下：</p>
<pre><code>&gt;&gt;&gt; choices = [&quot;Atlanta Falcons&quot;, &quot;New York Jets&quot;, &quot;New York Giants&quot;, &quot;Dallas Cowboys&quot;]  
&gt;&gt;&gt; process.extract(&quot;new york jets&quot;, choices, limit=2)  
        [('New York Jets', 100), ('New York Giants', 78)]  
&gt;&gt;&gt; process.extractOne(&quot;cowboys&quot;, choices)  
        (&quot;Dallas Cowboys&quot;, 90)  
</code></pre>
<p>对于语义特征，使用向量相似度检索，为了提升检索精确度，<strong>预先准备每条知识对应的摘要，向量检索时使用知识摘要和问题进行相似度计算</strong> ，找到相关知识后替换成具体知识【这里为什么使用摘要，然后再用摘要替换成原先文本，<strong>考虑的是超长问题以及长文本带来的噪声问题</strong> 】。</p>
<p><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/sz_mmbiz_png/fUBU1yiaEmJh3LOOecE18QruDYgNdqmAbZjibNx2ymTgOlY3NDo0Z2BatWiav8fHAn1YeJeOG2ONbDlUeibPVeHN3w/640?wx_fmt=png" alt=""></p>
<p>在检索模型训练阶段，为了获得更好的检索效果，额外利用对比学习训练了检索模型的embedding，具体地，<strong>将案例所对应的真实法条、类似案例、相关书籍描述等知识作为正例，并通过随机抽取和易混淆抽取（抽取和案例相似度高但并不对应的知识）</strong>  两种方式获取负例【这里的出发点是解决领域embedding的问题】</p>
<p><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/sz_mmbiz_png/fUBU1yiaEmJh3LOOecE18QruDYgNdqmAbDo6tkJLyOeUFMN3w8CUPq3sbeic82UnSWFodvNs9yKF39CHTlnWXxag/640?wx_fmt=png" alt=""></p>
<p><strong>3、知识融合</strong></p>
<p>在知识融合阶段，由于知识检索在意图识别阶段可能涉及多个知识库类型，将检索到的不同来源的知识融合后输入给法律大模型。</p>
<p>比如询问一个案例如何判罚时，<strong>意图识别阶段识别出应在法条库和类案库做检索，把和知识库名和其下检索到的知识拼接，再和问题拼接，共同输入到模型生成答案</strong> ：</p>
<pre><code>可参考的知识：法条：知识1，知识2 类案：知识1，知识2 问题：XXX，请问这个案例应该如何判罚？  
</code></pre>
<p><strong>4、核心代码实现</strong></p>
<p>最后，我们来看下最终的代码实现，外置知识库的初始化：</p>
<pre><code>class LangChainCFG:  
    llm_model_name = 'luwen_baichuan/output/zju_model_0813_100k'  # 本地模型文件 or huggingface远程仓库  
    embedding_model_name = 'app/langchain_demo/model/text2vec'  # 检索模型文件 or huggingface远程仓库  
    vector_store_path = 'app/langchain_demo/data/cache/legal_articles'  
    kg_vector_stores = {  
        '法律法条': 'app/langchain_demo/data/cache/legal_articles',  
        '法律书籍': 'app/langchain_demo/data/cache/legal_books',  
        '法律文书模板':'app/langchain_demo/data/cache/legal_templates',  
        '法律案例': 'app/langchain_demo/data/cache/legal_cases',  
        '法律考试': 'app/langchain_demo/data/cache/judicialExamination',  
        '日常法律问答': 'app/langchain_demo/data/cache/legal_QA',  
    }    
      
config = LangChainCFG()  
application = LangChainApplication(config)  
</code></pre>
<p>具体的实现逻辑如下：</p>
<pre><code>def predict(input,  
            kg_names=None,  
            history=None,  
            intention_reg=None,  
            **kwargs):  
    large_language_model=&quot;zju-bc&quot;  
    max_length=1024  
    top_k = 1  
    application.llm_service.max_token = max_length  
    if history == None:  
        history = []  
    search_text = ''  
    now_input = input  
    eos_token_ids = [application.llm_service.tokenizer.eos_token_id]  
    application.llm_service.history = history[-5:]  
    max_memory = 4096 - max_length  
    if intention_reg==[&quot;意图识别&quot;]:  
        auto_kg_names = key_words_match_intention(input)  
        if len(auto_kg_names)==0:  
            search_text += &quot;意图识别没有匹配到知识库。\n\n&quot;  
        else:  
            match_kg_names = &quot;、&quot;.join(list(auto_kg_names))  
            search_text += &quot;意图识别匹配到知识库是：&quot;+match_kg_names+&quot;。\n\n&quot;  
        kg_names = list(set(kg_names) | auto_kg_names)  
    kb_based = True if len(kg_names) != 0 else False  
    if len(history) != 0:  
        if large_language_model==&quot;zju-bc&quot;:  
            input = &quot;&quot;.join([&quot;&lt;/s&gt;Human:\n&quot; + i[0] +&quot;\n&quot; + &quot;&lt;/s&gt;Assistant:\n&quot; + i[1] + &quot;\n&quot;for i in application.llm_service.history]) + \  
            &quot;&lt;/s&gt;Human:\n&quot; + input  
            input = input[len(&quot;&lt;/s&gt;Human:\n&quot;):]  
        else:  
            input = &quot;&quot;.join([&quot;### Instruction:\n&quot; + i[0] +&quot;\n&quot; + &quot;### Response: &quot; + i[1] + &quot;\n&quot; for i in application.llm_service.history]) + \  
            &quot;### Instruction:\n&quot; + input  
            input = input[len(&quot;### Instruction:\n&quot;):]  
    if len(input) &gt; max_memory:  
        input = input[-max_memory:]  
    if kb_based:  
        related_docs_with_score_seq = []  
        for kg_name in kg_names:  
            if kg_name==&quot;法律法条&quot;:  
                related_article = key_words_match_knowledge(application.all_articles, application.choices, now_input)  
                if related_article:  
                    kg_matches = [[Document(page_content=related_article[0], metadata={&quot;value&quot;: related_article[1]})]]  
                else:  
                    application.source_service.load_vector_store(application.config.kg_vector_stores[kg_name])  
                    kg_matches = application.source_service.vector_store.similarity_search_with_score(input, k=top_k)  
            else:  
                application.source_service.load_vector_store(application.config.kg_vector_stores[kg_name])  
                kg_matches = application.source_service.vector_store.similarity_search_with_score(input, k=top_k)  
            related_docs_with_score_seq.append(kg_matches)  
        related_docs_with_score = related_docs_with_score_seq  
        if len(related_docs_with_score) &gt; 0:  
            input, context_with_score = application.generate_prompt(related_docs_with_score, input, large_language_model,kg_names)  
        search_text += context_with_score  
    torch_gc()  
    print(&quot;histroy in call: &quot;, history)  
    prompt = application.llm_service.generate_prompt(input, kb_based, large_language_model)  
    print(&quot;prompt: &quot;,prompt)  
</code></pre>
<p><strong>4、模型效果</strong></p>
<p>如下图所示，其模型效果如下：</p>
<p><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/sz_mmbiz_png/fUBU1yiaEmJh3LOOecE18QruDYgNdqmAb7n3QYybd3uO3ChibMg7L0hujSG62aLw3WolvYiczDCcItPFzm1PXeoKw/640?wx_fmt=png" alt=""></p>
<h4 id="总结">总结</h4>
<p>本文主要从ChatLaw引入关键词和领域嵌入提升召回相关性、zhihaiLLM融合意图识别、知识检索的问答方案、zhihaiLLM外挂知识数据的构成与构造方案、zhihaiLLM知识增强的三个关键步骤及源码实现等几个角度进行介绍。‍‍‍‍‍‍‍‍‍‍</p>
<p>其中，项目github.com/zhihaiLLM/wisdomInterrogatory大家可以关注，当然，这个项目也存在一些不足，也正如该工作所说，目前通过纯embedding匹配的检索效果仍然一般，后面考虑设计一套流程，可以自动训练得到针对某一知识库的专用检索模型， 同时，模型对融合的知识的理解能力仍有限，考虑在模型训练中对结合知识输出这方面进行增强。</p>
<p>行业微调模型长路漫漫，外挂知识库也本身是治标不治本，期待有更多、更好的工作出现。‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍</p>
<h4 id="参考文献">参考文献</h4>
<p>1、github.com/zhihaiLLM/wisdomInterrogatory</p>
<h4 id="关于我们">关于我们</h4>
<p>老刘，刘焕勇，NLP开源爱好者与践行者，主页：https://liuhuanyong.github.io。</p>
<p>老刘说NLP，将定期发布语言资源、工程实践、技术总结等内容，欢迎关注。</p>
<p><strong>对于想加入更优质的知识图谱、事件图谱、大模型AIGC实践、相关分享的，可关注公众号，在后台菜单栏中点击会员社区-&gt;会员入群加入。</strong></p>
<p>​​</p>
<p>更多AI工具，参考<a href="https://aibard123.com/">Github-AiBard123</a>，<a href="https://aibard123.com/">国内AiBard123</a></p>



          </div>

可关注我们的公众号：每天AI新工具

<p><img src="/images/aitools/2024/03/qrcode_for_gh_dde1b429630d_258.jpg" alt=""></p>

        </article>

      </div>
    </div>
  </div>
</section>
        </div>
    </div>
    </main>




<script type='text/javascript' src='/assets/js/jquery.ui.touch-punch.min-0.2.2.js' id='jqueryui-touch-js'></script>
<script type='text/javascript' src='/assets/js/clipboard.min-5.6.2.js' id='clipboard-js'></script>
<script type='text/javascript' src='/assets/js/tooltip-extend.js' id='iplaycode-nav-js'></script>
<script type='text/javascript' id='popper-js-extra'>
 

var theme = {"ajaxurl":"","addico":"https:\/\/nav.baidu.cn\/wp-content\/themes\/onenav\/images\/add.png","order":"asc","formpostion":"top","defaultclass":"io-grey-mode","isCustomize":"1","icourl":"","icopng":".png","urlformat":"1","customizemax":"10","newWindow":"0","lazyload":"1","minNav":"1","loading":"1","hotWords":"baidu","classColumns":" col-sm-6 col-md-4 col-xl-5a col-xxl-6a ","apikey":"TWpBeU1UVTNOekk1TWpVMEIvZ1M2bFVIQllUMmxsV1dZelkxQTVPVzB3UW04eldGQmxhM3BNWW14bVNtWk4="};
 
</script>
<script type='text/javascript' src='/assets/js/popper.min.js' id='popper-js'></script>
<script type='text/javascript' src='/assets/js/bootstrap.min-4.3.1.js' id='bootstrap-js'></script>
<script type='text/javascript' src='/assets/js/theia-sticky-sidebar-1.5.0.js' id='sidebar-js'></script>
<script type='text/javascript' src='/assets/js/lazyload.min-12.4.0.js' id='lazyload-js'></script>
<script type='text/javascript' src='/assets/js/fancybox.min-3.5.7.js' id='lightbox-js-js'></script>

<script type='text/javascript' src='/assets/js/app-anim.js' id='appanim-js'></script>

<script type="text/javascript">
    $(document).ready(function(){
        var siteWelcome = $('#loading');
        siteWelcome.addClass('close');
        setTimeout(function() {
            siteWelcome.remove();
        }, 600);
    });
</script>
<script>        
    $(document).ready(function(){
        setTimeout(function () {
            if ($('a.smooth[href="' + window.location.hash + '"]')[0]) {
                $('a.smooth[href="' + window.location.hash + '"]').click();
            }else if (window.location.hash != '') {
                $("html, body").animate({
                    scrollTop: $(window.location.hash).offset().top - 90
                }, {
                    duration: 500,
                    easing: "swing"
                });
            }
        }, 300);
        $(document).on('click','a.smooth',function(ev) {
            if($('#sidebar').hasClass('show') && !$(this).hasClass('change-href')){
                $('#sidebar').modal('toggle');
            }
            if($(this).attr("href").substr(0, 1) == "#"){
                $("html, body").animate({
                    scrollTop: $($(this).attr("href")).offset().top - 90
                }, {
                    duration: 500,
                    easing: "swing"
                });
            }
            if($(this).hasClass('go-search-btn')){
                $('#search-text').focus();
            }
            if(!$(this).hasClass('change-href')){
                var menu =  $("a"+$(this).attr("href"));
                menu.click();
                toTarget(menu.parent().parent(),true,true);
            }
        });
        $(document).on('click','a.tab-noajax',function(ev) {
            var url = $(this).data('link');
            if(url)
                $(this).parents('.d-flex.flex-fill.flex-tab').children('.btn-move.tab-move').show().attr('href', url);
            else
                $(this).parents('.d-flex.flex-fill.flex-tab').children('.btn-move.tab-move').hide();
        });
        
    });
</script>

<script>

(function(){
    if(document.cookie.replace(/(?:(?:^|.*;\s*)night\s*\=\s*([^;]*).*$)|^.*$/, "$1") === ''){
        if(new Date().getHours() > 22 || new Date().getHours() < 6){
            document.body.classList.remove('io-black-mode');
            document.body.classList.add('io-grey-mode');
            document.cookie = "night=1;path=/";
            console.log('夜间模式开启');
        }else{
            document.body.classList.remove('night');
            document.cookie = "night=0;path=/";
            console.log('夜间模式关闭');
        }
    }else{
        var night = document.cookie.replace(/(?:(?:^|.*;\s*)night\s*\=\s*([^;]*).*$)|^.*$/, "$1") || '0';
        if(night == '0'){
            document.body.classList.remove('night');
        }else if(night == '1'){
            document.body.classList.add('night');
        }
    }
})();

$("#search-bg").css("background", "linear-gradient(#e2c4c4, #d8d8d8)");   
function switchNightMode(){
    var night = document.cookie.replace(/(?:(?:^|.*;\s*)night\s*\=\s*([^;]*).*$)|^.*$/, "$1") || '0';
    if(night == '0'){
	$("#search-bg").css("background", "linear-gradient(#e2c4c4, #d8d8d8)");
        document.body.classList.remove('io-grey-mode');
        document.body.classList.add('io-black-mode');
        document.cookie = "night=1;path=/"
        console.log(' ');
        $(".switch-dark-mode").attr("data-original-title","日间模式");
        $(".mode-ico").removeClass("icon-night");
        $(".mode-ico").addClass("icon-light");
    }else{
	$("#search-bg").css("background", "linear-gradient(#4f4040, #1b1d1f)");
        document.body.classList.remove('io-black-mode');
        document.body.classList.add('io-grey-mode');
        document.cookie = "night=0;path=/"
        console.log(' ');
        $(".switch-dark-mode").attr("data-original-title","夜间模式");
        $(".mode-ico").removeClass("icon-light");
        $(".mode-ico").addClass("icon-night");
    }
}
</script>


<script>
    var newsContainer = document.getElementById('news-container');
    var newsItems = document.getElementsByClassName('news-item');
    var currentItem = 0;

    setInterval(function() {
        
        newsItems[currentItem].classList.remove('show');
        newsItems[currentItem].style.transform = 'translateY(-20px)';
        
        currentItem = (currentItem + 1) % newsItems.length;
        newsItems[currentItem].style.transform = 'translateY(' + (newsContainer.offsetHeight - 20) + 'px)';
        setTimeout(function() {
            newsItems[currentItem].classList.add('show');
        }, 500);
    }, 8000);
</script>

</body>
</html>


